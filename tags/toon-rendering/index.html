<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Toon Rendering | ZZNEWCLEAR13</title>
<meta name=keywords content><meta name=description content="这里是zznewclear13的，分享别处找不到的图形学和技术美术相关内容的，个人网站。"><meta name=author content="zznewclear13"><link rel=canonical href=http://localhost:1313/tags/toon-rendering/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://zznewclear13.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zznewclear13.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://zznewclear13.github.io/favicon.ico><link rel=apple-touch-icon href=https://zznewclear13.github.io/favicon.ico><link rel=mask-icon href=https://zznewclear13.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate type=application/rss+xml href=http://localhost:1313/tags/toon-rendering/index.xml><link rel=alternate hreflang=en href=http://localhost:1313/tags/toon-rendering/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-JZ0FQH1VK5"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JZ0FQH1VK5")}</script><meta property="og:title" content="Toon Rendering"><meta property="og:description" content="这里是zznewclear13的，分享别处找不到的图形学和技术美术相关内容的，个人网站。"><meta property="og:type" content="website"><meta property="og:url" content="http://localhost:1313/tags/toon-rendering/"><meta property="og:image" content="http://localhost:1313/images/address.png"><meta property="og:site_name" content="ZZNEWCLEAR13"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/images/address.png"><meta name=twitter:title content="Toon Rendering"><meta name=twitter:description content="这里是zznewclear13的，分享别处找不到的图形学和技术美术相关内容的，个人网站。"></head><body class=list id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="ZZNEWCLEAR13 (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>ZZNEWCLEAR13</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/now/ title=进行时><span>进行时</span></a></li><li><a href=http://localhost:1313/tags/ title=标签><span>标签</span></a></li><li><a href=http://localhost:1313/categories/ title=分类><span>分类</span></a></li><li><a href=http://localhost:1313/links/ title=友情链接><span>友情链接</span></a></li><li><a href=http://localhost:1313/search/ title="🔎 (Alt + /)" accesskey=/><span>🔎</span></a></li></ul></nav></header><main class=main><header class=page-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/tags/>Tags</a></div><h1>Toon Rendering</h1></header><article class="post-entry tag-entry"><figure class=entry-cover><img loading=lazy src=http://localhost:1313/posts/images/ToonRendering.png alt="Toon Rendering Cover"></figure><header class=entry-header><h2 class=entry-hint-parent>对少前2追放卡通渲染的拙劣模仿</h2></header><div class=entry-content><p>声明 感谢云母组在模之屋上发布了绛雨的模型和贴图文件。文中使用的Cubemap是Poly Haven上的Photo Stidio Loft Hall。本文仅代表我个人对卡通渲染的理解，其中可能存在错误、疏漏，或是冗杂的内容，请读者多多海涵。如有错误或是侵权的地方请通过邮件通知我(zznewclear@gmail.com)，我会第一时间处理。
少前2追放的卡通渲染 少前2追放的卡通渲染的优秀自不必多言，即使游戏本身饱受诟病，但玩家提起建模和渲染时也不得不赞叹其精美。网上能找到很多的少前2渲染的解析，最知名也最成体系的应该蛋白胨写的效果还原-少女前线2：追放 vepley角色渲染分析，这篇文章对少前2追放的模型和贴图文件做了详细的拆解和剖析，读完了之后受益很大，本文也参考了其中的实现。
少前2追放和其他二次元手游不一样的一点是，少前2追放更注重角色材质的pbr表现，这一点可以从少前2追放的贴图中可以看出，在二次元手游角色的法线贴图都没有完全普及的时候，少前2追放就已经使用了粗糙度贴图了。有PBR贴图，意味着我们应该要在PBR渲染模型的基础上发展npr的渲染，这也导致了少前2追放和别的游戏不同的地方，少前2追放的Ramp贴图除了用在Diffuse漫反射上，还用在了Specular高光上。
卡通渲染，在我看来只有取舍而没有优劣之分。有些人会说少前2追放的渲染比别的游戏好很多，或是有些人会说自己的卡通渲染比少前2追放的好很多，我觉得这是不太恰当的说法。说到底卡通渲染是一个基于个人喜好的东西，并不像真实感渲染一样有一个绝对的标准，甚至在各个项目中也会根据各自的项目去对各自的卡通渲染特性做一定的取舍。适合自己或是项目又或是玩家的卡通渲染，才是最好的卡通渲染。
本文的Shader编写理念 这里引用一下著名建筑大师密斯说过的一句名言，“Less is more”，少即是多。在网上看别人的分享的卡通渲染的代码，动辄二三十个不同的参数，最离奇的是我甚至看到有人在ShaderGUI里面加了一个搜索功能。过多的参数导致了只有Shader的编写者才能分辨出每一个参数具体的功能，这对美术来说光是试一遍这些参数就要付出很大的时间和精力，这也导致了美术几乎不可能完全使用到Shader编写者提供的所有参数。因此我致力于编写参数尽可能少的Shader，且每一个参数尽量具有直观的功能。
碎碎念也到此为止了，下面以绛雨为例子稍微讲解一下我是如何模仿少前2追放的卡通渲染的。本文使用的Unity版本是2022.3.34f1c1，URP版本是14.0.11，相关的代码可以在我的Github仓库里找到，由于篇幅限制，这里就不把所有代码都贴上来了。出于某些额外的考虑，这里暂时不直接放出代码了。
对少前2追放的卡通渲染的拙劣模仿 Ramp图 首先要理解Ramp图是用来做什么的。我们从采样方式来看，一般会把水平的Ramp图竖直堆叠成一张大图，然后使用xy坐标采样获得对应Ramp图的对应位置的颜色值。这实际上意味着Ramp图是一个将0到1之间的值映射到新的颜色范围的工具。0到1之间的值有很多，比如漫反射的NdotL，比如软阴影，比如菲涅尔项，甚至比如GGX的D项除以最亮处的D值。
因此我们对于主光源的直接光照部分，对漫反射的阴影和NdotL的乘积可以用一张Ramp图来映射到新的颜色，可以作出一定的次表面散射的感觉，也可以作出绘画中常用的带颜色的阴影边缘的效果，而我们对GGX的D项同样能用一张Ramp图来映射成新的颜色，除了正常的调整高光颜色的效果外，甚至还可以用来制作衍射的效果。
阴影 TODO：阴影
着色 着色分为间接光照和直接光照。
间接光照由于其频率较低我们考虑完全使用PBR的间接光照计算方式，即使用球谐作为漫反射来源，使用反射球作为高光反射来源。相较于Unity默认的计算方式，我这边使用了DFG贴图来计算更为正确的IBL结果，当没有DFG贴图时会使用虚幻引擎的拟合，同时也做了多重散射的弥补，具体计算可以看我的Shadertoy。我也制作了一个小工具用来对比R16G16_SFloat的DFG贴图，R8G8_UNorm的DFG贴图，和虚幻引擎拟合结果这三者的差异，可以说是微乎其微，主要集中在粗糙度低且NoV小的几个像素上，这几个像素的值可能会是1000以上的数值。
直接光照又分主光源和额外光源。对于主光源，我们用一张Ramp图重映射漫反射部分的阴影和NdotL，为了让暗部看上去有更丰富的颜色变化，我们甚至可以考虑对NdotL单独再分一张Ramp图，不过我这里就没这么做了。用另一张Ramp图重映射高光部分的D项除以最亮处的D项的值，将映射后的颜色值乘以最亮处的D项，再进入到GGX的计算中，这样既使用Ramp控制了高光的颜色变化，在数值上也符合PBR的结果。我的实现里高光并没有使用通过漫反射Ramp重映射之后的阴影和NdotL，也是我的一种取舍。对于额外光源，则仍是使用标准的PBR计算。
描边 生成平滑描边，只需要对每一个顶点，对其所在的每一个三角形的法线使用其张角加权求和，最后归一化就能得到平滑描边的方向，最后计算这些方向在切线空间的向量储存到UV或是顶点色就能在顶点着色器中计算平滑描边的方向了。值得一提的是使用张角的和也能略微计算出描边的粗细，可以想象发梢的张角和一定是比角色衣服平整区域的张角和小的，如果在美术没有绘制描边粗细的情况下，可以使用这个方式得到一个还可以的描边粗细。我也写了模型导入后处理的脚本用来生成平滑描边方向，但考虑到模型的顶点存在不同顶点但位于相同位置的可能性，所以我会先将临近的顶点认为是同一顶点（当然它们拥有独立的法线和切线），然后以此为基础计算平滑描边，实际的脚本运行速度有些慢，应该能用Jobs进行一定的优化。
描边既需要等宽也需要不等宽，这句话应当这么理解，当角色距离相机一定距离时，描边的像素粗细不会随着角色的远近而变化，而当角色超过一定距离时，描边的像素粗细会减少，但相对于角色的粗细会保持不变。对于FOV也是如此。
我们可以考虑距离相机d的长度为l的线段，相机的tan(fovy/2)值为y，对于Y轴分辨率为r的渲染目标，最终渲染的屏幕空间的像素长度约为l / d / y * r / 2。注意这里的约为，当线段平行于相机的Y轴时，这个像素长度是精确的，但是当线段本身存在旋转，且线段存在位移时，经过透视变换后屏幕空间的像素长度会发生变化。因此我在做描边时，会将顶点沿计算好的描边方向进行偏移，计算出透视变换后的屏幕空间坐标，与顶点本身的屏幕坐标相减归一化，得到正确的屏幕空间的向量，再依据这个向量进行描边宽度的调整，最后直接算出裁剪空间的坐标。而对于距离和fovy，只需要在合理的范围内做一次clamp就能满足上文所说的等宽却又不等宽了。
透明物体的着色与描边 这里我要提出我的“抛弃Blend SrcAlpha OneMinusSrcAlpha，使用Blend One OneMinusSrcAlpha”的观点。主要原因有两个，一是One OneMinusSrcAlpha完全能够胜任SrcAlpha OneMinusSrcAlpha的所有功能，二是One OneMinusSrcAlpha能够给我们更多的对颜色的控制，比如透明物体的高光不应该受到透明物体的透明度的影响，但是透明度却应该影响透明物体的漫反射（实际上应该叫透射）的颜色。为了尽量符合美术需求，我这边也提供了预乘透明度的功能，即让透明度同时影响物体的漫反射和高光，这样一些本想做成完全透明的部分也不会受到高光的影响了，当然透明剔除也能做到这一点。
目前我是通过透明物体写入深度来制作描边，对于单面的模型还需要启用双面显示来确保正常的渲染效果。
丝袜的着色 少前2追放的丝袜渲染可以说是让人叹为观止。市面上其他的二次元游戏，能用菲涅尔做一个渐变就了不得了，但是少前2追放的丝袜是既有受光的漫反射又有各向异性高光的丝袜，而不是单单用菲涅尔糊弄一个渐变效果。
大家一说起丝袜渲染，除了菲涅尔的渐变，最关注的就是各向异性。大家都知道GGX有一个各向异性的版本，只要对计算高光的代码稍作修改就能得到十分物理的各向异性高光，但我这边要说点不一样的。我们从VNDF的计算中可以知道，各向异性的高光几乎就是普通的高光沿着切线和双切线拉伸的结果，VNDF的操作是先把视线方向转换到根据各向异性拉伸后的切线空间，采样得到微表面法线之后，再将反射后的光源方向使用各向异性拉伸后的切线基转回世界空间。因此我使用的各向异性会将视线和光源方向都先转换到各向异性拉伸后的切线空间，在切线空间直接进行各向同性的GGX高光的渲染。这样子有两个好处，首先是高光效果在各向异性和各向同性中间是能无缝切换的，其次是这样通过坐标变换，即使是从上往下看角色的丝袜，也能在一定程度上看到各向异性的高光，这么做唯一的缺点是GGX计算的菲涅尔项会比正常的菲涅尔项大很多，不过我们可以先计算各项同性的菲涅尔项，之后在计算高光的时候仅替换菲涅尔项就可以了。
至于丝袜的颜色，目前我的做法是使用NoV的幂次控制贴图和丝袜颜色的混合（也就是大家都在用的菲涅尔啦），作为丝袜的漫反射颜色进入正常的光照计算。比较有意思的点是pow(NoV, x)和1 - pow(1 - NoV, x)的曲线形状不尽相同，可以根据自己的喜好选择一种渐变的曲线。至于丝袜的各种细微的颜色的渐变，我认为直接调整漫反射Ramp就能基本达到差不多的效果了，况且我也不想单单为了丝袜增加一张Ramp图。
由于绛雨的丝袜为了有比较明显的高光效果，贴图上的粗糙度比较低，只能在丝袜的计算中将间接光的高光部分排除掉，不然丝袜看上去会有点点胶衣的感觉，不太符合现实生活的丝袜的表现。
头发的着色 头发着色的解析可以看蛋白胨的文章，不同于很多卡通渲染使用的计算Kajiya Kay的方式，少前2追放仅通过视线在角色向上的向量上的投影，对采样高光图的UV进行Y轴的偏移，来制作角色头发的高光。为了贴图制作的方便，这里将模型拆成两套UV，第一套绘制基础颜色图，第二套调整UV使得每一绺头发UV的Y值是从发尾到发梢的渐变。虽然要渲染的是头发的高光，但我在运算中仅仅将高光叠加到了头发的漫反射贴图中，最后仍然是通过漫反射的方式来渲染了整个头发。
脸部的着色 二次元角色脸部一般会做得比较平，即削弱法线带来NdotL的变化，而又为了计算脸部的阴影，需要一张SDF图来标识脸部的阴影区域。
脸部比较平，在我们间接光照使用PBR计算之外，直接光照只需要计算主光源颜色乘阴影乘基础颜色图就可以了，为了和计算NdotL的身体其他部位相融合，我对结果再乘了一个0.8。脸部的阴影则是常规的SDF的计算，先在顶点中计算主光方向在角色空间的方向，取在角色的侧方和前方的投影值，用来采样和计算SDF阴影值即可。鼻尖高光则可以参考蛋白胨的计算，这里可以观察到SDF有一个通道的最亮的区域是左右对称的，这是用来应对光从角色一侧移动到另一侧时，SDF图X轴反转但鼻尖高光不会突变。鼻尖高光和阴影之和，恰巧可以统一到漫反射Ramp的采样当中。
刘海阴影 少前2追放的角色的刘海也有投影功能。一般是先绘制带模板值的刘海投影，再绘制脸部，分别对有刘海投影模板的区域和没有刘海的区域进行着色，最后再绘制透明度混合的刘海。但是限制于Unity多Pass的Shader的所有Pass是在绘制模型时一次性全部绘制的，只能改成先绘制带模板值的刘海投影，再绘制刘海，再绘制脸部了。这样我们不需要额外配置RendererFeature，仅通过Shader就可以完成正常的刘海阴影的渲染。
但是实际渲染时会发现，对于刘海区域比较大的角色，如绛雨，从角色的侧面可以观察到角色另一侧的头发在角色的侧脸也产生了投影，这是明显不合理的。我这边想到的办法是新增一个RendererFeature，先绘制带深度值的脸部，在绘制刘海投影时限制刘海投影只能在角色的上方侧方平面移动，同时又将刘海投影稍微沿相机位移减少正常情况下被深度剔除的概率，然后再绘制角色脸部。不知道少前2追放这里具体是怎么处理的，但是确实没有观察到从侧面看到另一侧头发投影的问题。
眼睛的渲染 不同于很多卡通渲染教程精心设计的使用视差计算眼睛位置来达到眼睛跟随相机的效果，少前2追放使用比眼眶更靠内的眼睛片的建模方式来达到这种效果，这跟现实的眼睛也有一些联系，因为人眼的虹膜相对于最外层的角膜来说，也是处于内部的，也自然会有视差的感觉。...</p></div><footer class=entry-footer><span title='2024-08-17 12:00:00 +0800 CST'>August 17, 2024</span>&nbsp;·&nbsp;zznewclear13</footer><a class=entry-link aria-label="post link to 对少前2追放卡通渲染的拙劣模仿" href=http://localhost:1313/posts/a-parody-of-toon-rendering-in-girls-frontline-2-exilium/></a></article><div style=display:none>zznewclear13 技术美术 图形学 个人博客 technical art computer graphics</div></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>ZZNEWCLEAR13</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>