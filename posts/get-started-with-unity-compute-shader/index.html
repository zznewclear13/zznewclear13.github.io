<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Unity Compute Shaderå¤‡å¿˜å½• | ZZNEWCLEAR13</title>
<meta name=keywords content="Compute Shader"><meta name=description content="å¤§æ¦‚è®°ä¸€äº›Unity Compute Shaderç›¸å…³çš„ä¸œè¥¿å§."><meta name=author content="zznewclear13"><link rel=canonical href=https://zznewclear13.github.io/posts/get-started-with-unity-compute-shader/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://zznewclear13.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zznewclear13.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://zznewclear13.github.io/favicon.ico><link rel=apple-touch-icon href=https://zznewclear13.github.io/favicon.ico><link rel=mask-icon href=https://zznewclear13.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://zznewclear13.github.io/posts/get-started-with-unity-compute-shader/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-157509723-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Unity Compute Shaderå¤‡å¿˜å½•"><meta property="og:description" content="å¤§æ¦‚è®°ä¸€äº›Unity Compute Shaderç›¸å…³çš„ä¸œè¥¿å§."><meta property="og:type" content="article"><meta property="og:url" content="https://zznewclear13.github.io/posts/get-started-with-unity-compute-shader/"><meta property="og:image" content="https://zznewclear13.github.io/posts/get-started-with-unity-compute-shader/posts/images/ComputeShader.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-16T19:00:00+08:00"><meta property="article:modified_time" content="2021-06-16T19:00:00+08:00"><meta property="og:site_name" content="ZZNEWCLEAR13"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zznewclear13.github.io/posts/get-started-with-unity-compute-shader/posts/images/ComputeShader.jpg"><meta name=twitter:title content="Unity Compute Shaderå¤‡å¿˜å½•"><meta name=twitter:description content="å¤§æ¦‚è®°ä¸€äº›Unity Compute Shaderç›¸å…³çš„ä¸œè¥¿å§."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zznewclear13.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Unity Compute Shaderå¤‡å¿˜å½•","item":"https://zznewclear13.github.io/posts/get-started-with-unity-compute-shader/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Unity Compute Shaderå¤‡å¿˜å½•","name":"Unity Compute Shaderå¤‡å¿˜å½•","description":"å¤§æ¦‚è®°ä¸€äº›Unity Compute Shaderç›¸å…³çš„ä¸œè¥¿å§.","keywords":["Compute Shader"],"articleBody":"ä»€ä¹ˆæ˜¯Compute Shaderï¼Œä»¥åŠå®ƒèƒ½ç”¨æ¥å¹²ä»€ä¹ˆ é¦–å…ˆæ ¹æ®Direct3D 11çš„è¯´æ˜æ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸€ä¸ªCompute Shaderæ˜¯ä¸€ä¸ªèƒ½å¤Ÿåˆ©ç”¨æ³›å¼ï¼ˆé€šç”¨ï¼‰çš„å†…å­˜è®¿é—®ï¼ˆå³è¾“å…¥å’Œè¾“å‡ºï¼‰ï¼Œæ¥è¿›è¡Œä»»æ„è¿ç®—çš„å¯ç¼–ç¨‹ç€è‰²å™¨ã€‚ä½œä¸ºç±»æ¯”ï¼Œæˆ‘è®¤ä¸ºCompute Shaderå’ŒUnityä¸­çš„Job Systemå¾ˆåƒï¼Œå‡†å¤‡å¥½ä¸€ç³»åˆ—çš„è¾“å…¥ï¼Œå¹¶è®¾ç½®å¥½è¾“å‡ºçš„ç›®æ ‡ï¼Œç„¶åæ‰§è¡Œè¿™ä¸ªCompute Shaderæˆ–è€…Jobï¼Œå°±èƒ½å¾—åˆ°æƒ³è¦çš„ç»“æœã€‚GPUå’Œå¤šçº¿ç¨‹ï¼Œæˆ‘è®¤ä¸ºåœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯å¼‚æ›²åŒå·¥çš„ã€‚Job Systemæœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼Œå°±æ˜¯å¿«ï¼Œè€ŒCompute Shaderä¹Ÿæœ‰è¿™ä¸ªä¼˜åŠ¿ï¼Œè€Œä¸”è¿˜è¦æ›´å¿«ï¼Compute shaderèƒŒåçš„æ€æƒ³å°±æ˜¯General-purpose computing on graphics processing units(GPGPU)ï¼Œå³åœ¨å›¾å½¢å¤„ç†å•å…ƒä¸Šè¿›è¡Œé€šç”¨è®¡ç®—ã€‚\nå¦‚ä½•åœ¨Unityé‡Œé¢ä½¿ç”¨Compute Shader åœ¨Unityä¸­åˆ›å»ºCompute Shaderä¹‹åï¼Œä¼šå¾—åˆ°ä¸€ä¸ªé»˜è®¤çš„Compute Shaderï¼Œé‡Œé¢çš„ä»£ç æ˜¯è¿™æ ·çš„:\n// Each #kernel tells which function to compile; you can have many kernels #pragma kernel CSMain // Create a RenderTexture with enableRandomWrite flag and set it // with cs.SetTexture RWTexture2D\u003cfloat4\u003e Result; [numthreads(8,8,1)] void CSMain (uint3 id : SV_DispatchThreadID) { // TODO: insert actual code here! Result[id.xy] = float4(id.x \u0026 id.y, (id.x \u0026 15)/15.0, (id.y \u0026 15)/15.0, 0.0); } éœ€è¦æ‰§è¡ŒCompute Shaderçš„æ—¶å€™ï¼Œéœ€è¦è·å–è¯¥Compute Shaderçš„å¼•ç”¨ï¼Œå†è°ƒç”¨å®ƒçš„Dispatchçš„æ–¹æ³•ï¼š\n//ä½¿ç”¨(256, 250, 1)çš„å¤§å°åˆ›å»ºä¸€ä¸ªæ”¯æŒéšæœºè¯»å†™çš„å››é€šé“æµ®ç‚¹æ•°çš„RenderTexture Vector3Int dispatchThreadCount = new Vector3Int(256, 250, 1); RenderTextureDescriptor desc = new RenderTextureDescriptor { dimension = TextureDimension.Tex2D, width = dispatchThreadCount.x, height = dispatchThreadCount.y, volumeDepth = dispatchThreadCount.z, graphicsFormat = UnityEngine.Experimental.Rendering.GraphicsFormat.R16G16B16A16_SFloat, msaaSamples = 1, enableRandomWrite = true, }; renderTexture = new RenderTexture(desc); //æ‰¾åˆ°å«åš\"CSMain\"çš„kernel int kernel = computeShader.FindKernel(\"CSMain\"); //è·å–numthreadsï¼Œè¿™é‡Œè·å–çš„å€¼æ˜¯(8, 8, 1) computeShader.GetKernelThreadGroupSizes(kernel, out uint x, out uint y, out uint z); //è®¡ç®—Dispatch Countï¼Œè¦æ³¨æ„å…ˆç”¨æµ®ç‚¹æ•°è®¡ç®—ï¼Œå†å‘ä¸Šå–æ•´ Vector3Int dispatchCount = new Vector3Int(Mathf.CeilToInt(dispatchThreadCount.x / (float)x), Mathf.CeilToInt(dispatchThreadCount.y / (float)y), Mathf.CeilToInt(dispatchThreadCount.z / (float)z)); computeShader.SetTexture(kernel, \"Result\", renderTexture); computeShader.Dispatch(kernel, dispatchCount.x, dispatchCount.y, dispatchCount.z); è¿™æ ·å°±èƒ½å¤Ÿæ ¹æ®Compute Shaderé‡Œé¢çš„ä»£ç ï¼Œåœ¨Render Textureä¸Šç»˜åˆ¶å‡ºæƒ³è¦çš„æ•ˆæœäº†ã€‚æœ€ç»ˆç»˜åˆ¶çš„æ•ˆæœæ˜¯è¿™æ ·çš„ï¼š Compute Shaderé‡Œé¢çš„ä»£ç æœ‰ä»€ä¹ˆå«ä¹‰ å¯ä»¥çœ‹åˆ°Compute Shaderçš„#pragma kernel CSMainä½¿ç”¨äº†ä¸€ä¸ªå«åšCSMainçš„å‡½æ•°ä½œä¸ºkernelï¼Œå°±å’Œæ™®é€šshaderä¸­çš„vertexå’Œfragmentå·®ä¸å¤šã€‚è¿™ä¸ªCompute Shaderçš„è¾“å…¥å’Œè¾“å‡ºæ˜¯åŒä¸€å¼ float4çš„2Dè´´å›¾Resultã€‚RWTexture2Dçš„RW(Read Write)è¡¨ç¤ºè¿™å¼ è´´å›¾æ”¯æŒéšæœºè¯»å†™(unordered access view, UAV)ï¼Œè¿™æ ·åœ¨Compute Shaderè¯»å–è¿™å¼ è´´å›¾çš„åŒæ—¶ä¹Ÿèƒ½å¯¹è¿™å¼ è´´å›¾è¿›è¡Œå†™å…¥ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ä¸€å¼ å¯è¯»å†™è´´å›¾ï¼Œå’Œä¸¤å¼ è´´å›¾ä¸€å¼ è¯»ä¸€å¼ å†™ï¼Œåœ¨éœ€è¦è¯»å–é™¤å½“å‰åƒç´ å¤–çš„åƒç´ ä¿¡æ¯å¹¶å†™å…¥å½“å‰åƒç´ æ—¶ï¼Œæ˜¯ä¼šæœ‰ä¸€å®šåŒºåˆ«çš„ã€‚å†æœ‰å°±æ˜¯CSMainä¸­ä¸¤æ¡çœ‹ä¸å¤ªæ‡‚çš„ä»£ç äº†[numthreads(8,8,1)]å’ŒSV_DispatchThreadIDã€‚è¿™é‡Œå¯ä»¥å‚è€ƒHLSLå®˜æ–¹æ–‡æ¡£ä¸Šçš„å®šä¹‰æ¥è¿›è¡Œç†è§£ï¼š é€šå¸¸ç”¨åˆ°çš„æœ‰SV_GroupID, SV_GroupThreadID, SV_GroupIndex, å’ŒSV_DispatchThreadIDï¼Œä¸€èˆ¬æŒ‰æˆ‘çš„æƒ³æ³•ï¼Œæˆ‘è¿˜ä¼šé¢å¤–ä¼ å…¥ä¸€ä¸ª_DispatchCountè®°å½•Compute Shaderçš„Dispatchçš„æ•°ç›®ã€‚Compute Shaderæ˜¯è¿™æ ·è¿ä½œçš„ï¼šå‡è®¾æˆ‘ä»¬æ‰§è¡Œäº†Dispatch(5, 3, 2)å’Œnumthreads(10, 8, 3)ï¼Œé‚£ä¹ˆä¸€å…±ä¼šäº§ç”Ÿ5 * 3 * 2 = 30ä¸ªThread Groupï¼Œæ¯ä¸ªThread Groupä¼šæœ‰ä¸€ä¸ªSV_GroupIDï¼ŒèŒƒå›´æ˜¯(0, 0, 0)åˆ°(4, 2, 1)ï¼›æ¯ä¸ªThread Groupä¸­ä¼šæœ‰10 * 8 * 3ä¸ªThreadï¼Œæ¯ä¸ªThreadä¼šæœ‰ä¸€ä¸ªSV_GroupThreadID, SV_GroupIndexå’ŒSV_DispatchThreadIDã€‚SV_GroupThreadIDçš„èŒƒå›´æ˜¯(0, 0, 0)åˆ°(9, 7, 2)ã€‚SV_GroupIndexæ˜¯Threadåœ¨Thread Groupå†…çš„åºå·ï¼Œå…¶å€¼ç­‰äºSV_GroupThreadID.z * numthreads.y * numthreads.x + SV_GroupThreadID.y * numthreads.x + SV_GroupThreadID.xï¼Œå…¶èŒƒå›´æ˜¯0åˆ°10 * 8 * 3 - 1ï¼Œåœ¨æ¶‰åŠåˆ°groupshared memoryçš„æ—¶å€™ï¼Œå¾€å¾€ä¼šç”¨åˆ°SV_GroupIndexã€‚SV_DispatchThreadIDçš„èŒƒå›´æ˜¯(0, 0, 0)åˆ°(5 * 10 - 1, 3 * 8 -1, 2 * 3 - 1)ï¼ŒSV_DispatchThreadIDçš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯¹äºä»»ä½•ä¸€ä¸ªThreadï¼Œå®ƒçš„SV_DispatchThreadIDéƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œå› æ­¤åœ¨å¾ˆå¤šæƒ…å†µä¸‹éƒ½å¯ä»¥åˆ©ç”¨SV_DispatchThreadIDæ¥è¿›è¡Œæ•°æ®æ“ä½œï¼›æ­¤å¤–ï¼Œåœ¨ä½¿ç”¨RWStructuredBufferæ¥ä½œä¸ºè¾“å…¥è¾“å‡ºçš„æ—¶å€™ï¼Œå¾€å¾€ä¼šéœ€è¦çŸ¥é“æ¯ä¸ªThread Groupåœ¨æ‰€æœ‰Thread Groupä¸­çš„åºå·ï¼Œæˆ–è€…æ˜¯æ¯ä¸ªThreadåœ¨æ‰€æœ‰Threadä¸­çš„åºå·ï¼Œæˆ‘å°†å…¶è®°ä¸ºIndexGroupå’ŒIndexThreadï¼Œç”¨æ¥å’Œè‡ªå¸¦çš„IndexåŒºåˆ†ï¼ŒIndexGroupçš„å€¼ç­‰äºSV_GroupID.z * _DispatchCount.y * _DispatchCount.x + SV_GroupID.y * _DispatchCount.x + SV_GroupID.xï¼ŒèŒƒå›´æ˜¯0åˆ°5 * 3 * 2 - 1ï¼ŒIndexThreadçš„å€¼ç­‰äºIndexGroup * numthreads.z * numthreads.y * numthreads.x + SV_GroupIndexï¼ŒèŒƒå›´æ˜¯0åˆ°5 * 3 * 2 * 10 * 8 * 3 - 1ã€‚æ­¤å¤–è¿˜è¦æ³¨æ„ï¼Œç”±äºDispatchCountæœ‰è¢«å‘ä¸Šå–æ•´çš„å¯èƒ½ï¼Œæ‰€å¾—åˆ°çš„å¦‚SV_DispatchThreadIDå¯èƒ½ä¼šè¶…è¿‡è´´å›¾ã€Bufferçš„å¤§å°ï¼Œæœ€å¥½å†ä¼ å…¥ä¸€ä¸ª_TextureSizeæ¥å°†SV_DisparchThreadIDé™åˆ¶åˆ°åˆé€‚çš„å¤§å°ã€‚\nç‰¹åˆ«éœ€è¦è®°ä½çš„æ˜¯ï¼ŒCompute Shaderä¸­çš„numthreadsã€DispatchCountè¿™äº›æ•°å€¼ï¼Œè·Ÿè¾“å¦‚è¾“å‡ºçš„æ•°æ®ç»“æ„æ²¡æœ‰ç›´æ¥çš„å…³ç³»ï¼Œå¯¹äºä»»æ„çš„æ•°æ®ç»“æ„ï¼Œéƒ½èƒ½ä½¿ç”¨â€œä»»æ„â€çš„numthreadså’ŒDispatchCountï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦åœ¨ä»£ç ä¸­æŒ‡å®šè¿™äº›æ•°å€¼å’Œè¾“å…¥è¾“å‡ºçš„æ•°æ®ç»“æ„çš„å…³ç³»ã€‚æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ä½¿ç”¨IndexThreadæ¥è¯»å–å†™å…¥RWStructuredBufferï¼Œç”¨SV_DispatchThreadIDæ¥è¯»å–å†™å…¥è´´å›¾ã€‚\n","wordCount":"284","inLanguage":"en","image":"https://zznewclear13.github.io/posts/get-started-with-unity-compute-shader/posts/images/ComputeShader.jpg","datePublished":"2021-06-16T19:00:00+08:00","dateModified":"2021-06-16T19:00:00+08:00","author":{"@type":"Person","name":"zznewclear13"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zznewclear13.github.io/posts/get-started-with-unity-compute-shader/"},"publisher":{"@type":"Organization","name":"ZZNEWCLEAR13","logo":{"@type":"ImageObject","url":"https://zznewclear13.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zznewclear13.github.io/ accesskey=h title="ZZNEWCLEAR13 (Alt + H)"><img src=https://zznewclear13.github.io/apple-touch-icon.png alt aria-label=logo height=35>ZZNEWCLEAR13</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zznewclear13.github.io/now/ title=è¿›è¡Œæ—¶><span>è¿›è¡Œæ—¶</span></a></li><li><a href=https://zznewclear13.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://zznewclear13.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://zznewclear13.github.io/links/ title=å‹æƒ…é“¾æ¥><span>å‹æƒ…é“¾æ¥</span></a></li><li><a href=https://zznewclear13.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zznewclear13.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://zznewclear13.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Unity Compute Shaderå¤‡å¿˜å½•</h1><div class=post-description>å¤§æ¦‚è®°ä¸€äº›Unity Compute Shaderç›¸å…³çš„ä¸œè¥¿å§.</div><div class=post-meta><span title='2021-06-16 19:00:00 +0800 CST'>June 16, 2021</span>&nbsp;Â·&nbsp;zznewclear13&nbsp;|&nbsp;<a href=https://github.com/zznewclear13/zznewclear13.com/blob/main/content/posts/get-started-with-unity-compute-shader.md rel="noopener noreferrer" target=_blank>ç¼–è¾‘</a></div></header><figure class=entry-cover><img loading=eager src=https://zznewclear13.github.io/posts/images/ComputeShader.jpg alt="Compute Shader Cover"><p>Compute Shader Result</p></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>Unity Compute Shaderå¤‡å¿˜å½•</div></summary><div class=inner><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%afcompute-shader%e4%bb%a5%e5%8f%8a%e5%ae%83%e8%83%bd%e7%94%a8%e6%9d%a5%e5%b9%b2%e4%bb%80%e4%b9%88 aria-label="ä»€ä¹ˆæ˜¯Compute Shaderï¼Œä»¥åŠå®ƒèƒ½ç”¨æ¥å¹²ä»€ä¹ˆ">ä»€ä¹ˆæ˜¯Compute Shaderï¼Œä»¥åŠå®ƒèƒ½ç”¨æ¥å¹²ä»€ä¹ˆ</a></li><li><a href=#%e5%a6%82%e4%bd%95%e5%9c%a8unity%e9%87%8c%e9%9d%a2%e4%bd%bf%e7%94%a8compute-shader aria-label="å¦‚ä½•åœ¨Unityé‡Œé¢ä½¿ç”¨Compute Shader">å¦‚ä½•åœ¨Unityé‡Œé¢ä½¿ç”¨Compute Shader</a></li><li><a href=#compute-shader%e9%87%8c%e9%9d%a2%e7%9a%84%e4%bb%a3%e7%a0%81%e6%9c%89%e4%bb%80%e4%b9%88%e5%90%ab%e4%b9%89 aria-label="Compute Shaderé‡Œé¢çš„ä»£ç æœ‰ä»€ä¹ˆå«ä¹‰">Compute Shaderé‡Œé¢çš„ä»£ç æœ‰ä»€ä¹ˆå«ä¹‰</a></li></ul></div></details></div><div class=post-content><h2 id=ä»€ä¹ˆæ˜¯compute-shaderä»¥åŠå®ƒèƒ½ç”¨æ¥å¹²ä»€ä¹ˆ>ä»€ä¹ˆæ˜¯Compute Shaderï¼Œä»¥åŠå®ƒèƒ½ç”¨æ¥å¹²ä»€ä¹ˆ<a hidden class=anchor aria-hidden=true href=#ä»€ä¹ˆæ˜¯compute-shaderä»¥åŠå®ƒèƒ½ç”¨æ¥å¹²ä»€ä¹ˆ>#</a></h2><p>é¦–å…ˆæ ¹æ®Direct3D 11çš„è¯´æ˜æ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸€ä¸ªCompute Shaderæ˜¯ä¸€ä¸ªèƒ½å¤Ÿåˆ©ç”¨æ³›å¼ï¼ˆé€šç”¨ï¼‰çš„å†…å­˜è®¿é—®ï¼ˆå³è¾“å…¥å’Œè¾“å‡ºï¼‰ï¼Œæ¥è¿›è¡Œä»»æ„è¿ç®—çš„å¯ç¼–ç¨‹ç€è‰²å™¨ã€‚ä½œä¸ºç±»æ¯”ï¼Œæˆ‘è®¤ä¸ºCompute Shaderå’ŒUnityä¸­çš„Job Systemå¾ˆåƒï¼Œå‡†å¤‡å¥½ä¸€ç³»åˆ—çš„è¾“å…¥ï¼Œå¹¶è®¾ç½®å¥½è¾“å‡ºçš„ç›®æ ‡ï¼Œç„¶åæ‰§è¡Œè¿™ä¸ªCompute Shaderæˆ–è€…Jobï¼Œå°±èƒ½å¾—åˆ°æƒ³è¦çš„ç»“æœã€‚GPUå’Œå¤šçº¿ç¨‹ï¼Œæˆ‘è®¤ä¸ºåœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯å¼‚æ›²åŒå·¥çš„ã€‚Job Systemæœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼Œå°±æ˜¯å¿«ï¼Œè€ŒCompute Shaderä¹Ÿæœ‰è¿™ä¸ªä¼˜åŠ¿ï¼Œè€Œä¸”è¿˜è¦æ›´å¿«ï¼Compute shaderèƒŒåçš„æ€æƒ³å°±æ˜¯General-purpose computing on graphics processing units(GPGPU)ï¼Œå³åœ¨å›¾å½¢å¤„ç†å•å…ƒä¸Šè¿›è¡Œé€šç”¨è®¡ç®—ã€‚</p><h2 id=å¦‚ä½•åœ¨unityé‡Œé¢ä½¿ç”¨compute-shader>å¦‚ä½•åœ¨Unityé‡Œé¢ä½¿ç”¨Compute Shader<a hidden class=anchor aria-hidden=true href=#å¦‚ä½•åœ¨unityé‡Œé¢ä½¿ç”¨compute-shader>#</a></h2><p>åœ¨Unityä¸­åˆ›å»ºCompute Shaderä¹‹åï¼Œä¼šå¾—åˆ°ä¸€ä¸ªé»˜è®¤çš„Compute Shaderï¼Œé‡Œé¢çš„ä»£ç æ˜¯è¿™æ ·çš„:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span><span style=color:#75715e>// Each #kernel tells which function to compile; you can have many kernels</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#pragma kernel CSMain</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Create a RenderTexture with enableRandomWrite flag and set it</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// with cs.SetTexture</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>RWTexture2D</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>float4</span><span style=color:#f92672>&gt;</span> Result;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>numthreads</span>(<span style=color:#ae81ff>8</span>,<span style=color:#ae81ff>8</span>,<span style=color:#ae81ff>1</span>)]
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> CSMain (<span style=color:#66d9ef>uint3</span> id <span style=color:#f92672>:</span> <span style=color:#a6e22e>SV_DispatchThreadID</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TODO: insert actual code here!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Result[id.xy] <span style=color:#f92672>=</span> <span style=color:#66d9ef>float4</span>(id.x <span style=color:#f92672>&amp;</span> id.y, (id.x <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>15</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>15.0</span>, (id.y <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>15</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>15.0</span>, <span style=color:#ae81ff>0.0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>éœ€è¦æ‰§è¡ŒCompute Shaderçš„æ—¶å€™ï¼Œéœ€è¦è·å–è¯¥Compute Shaderçš„å¼•ç”¨ï¼Œå†è°ƒç”¨å®ƒçš„Dispatchçš„æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#75715e>//ä½¿ç”¨(256, 250, 1)çš„å¤§å°åˆ›å»ºä¸€ä¸ªæ”¯æŒéšæœºè¯»å†™çš„å››é€šé“æµ®ç‚¹æ•°çš„RenderTexture</span>
</span></span><span style=display:flex><span>Vector3Int dispatchThreadCount = <span style=color:#66d9ef>new</span> Vector3Int(<span style=color:#ae81ff>256</span>, <span style=color:#ae81ff>250</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>RenderTextureDescriptor desc = <span style=color:#66d9ef>new</span> RenderTextureDescriptor
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    dimension = TextureDimension.Tex2D,
</span></span><span style=display:flex><span>    width = dispatchThreadCount.x,
</span></span><span style=display:flex><span>    height = dispatchThreadCount.y,
</span></span><span style=display:flex><span>    volumeDepth = dispatchThreadCount.z,
</span></span><span style=display:flex><span>    graphicsFormat = UnityEngine.Experimental.Rendering.GraphicsFormat.R16G16B16A16_SFloat,
</span></span><span style=display:flex><span>    msaaSamples = <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    enableRandomWrite = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>renderTexture = <span style=color:#66d9ef>new</span> RenderTexture(desc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//æ‰¾åˆ°å«åš&#34;CSMain&#34;çš„kernel</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> kernel = computeShader.FindKernel(<span style=color:#e6db74>&#34;CSMain&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>//è·å–numthreadsï¼Œè¿™é‡Œè·å–çš„å€¼æ˜¯(8, 8, 1)</span>
</span></span><span style=display:flex><span>computeShader.GetKernelThreadGroupSizes(kernel, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> x, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> y, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> z);
</span></span><span style=display:flex><span><span style=color:#75715e>//è®¡ç®—Dispatch Countï¼Œè¦æ³¨æ„å…ˆç”¨æµ®ç‚¹æ•°è®¡ç®—ï¼Œå†å‘ä¸Šå–æ•´</span>
</span></span><span style=display:flex><span>Vector3Int dispatchCount = <span style=color:#66d9ef>new</span> Vector3Int(Mathf.CeilToInt(dispatchThreadCount.x / (<span style=color:#66d9ef>float</span>)x),
</span></span><span style=display:flex><span>                                        Mathf.CeilToInt(dispatchThreadCount.y / (<span style=color:#66d9ef>float</span>)y),
</span></span><span style=display:flex><span>                                        Mathf.CeilToInt(dispatchThreadCount.z / (<span style=color:#66d9ef>float</span>)z));
</span></span><span style=display:flex><span>computeShader.SetTexture(kernel, <span style=color:#e6db74>&#34;Result&#34;</span>, renderTexture);
</span></span><span style=display:flex><span>computeShader.Dispatch(kernel, dispatchCount.x, dispatchCount.y, dispatchCount.z);
</span></span></code></pre></div><p>è¿™æ ·å°±èƒ½å¤Ÿæ ¹æ®Compute Shaderé‡Œé¢çš„ä»£ç ï¼Œåœ¨Render Textureä¸Šç»˜åˆ¶å‡ºæƒ³è¦çš„æ•ˆæœäº†ã€‚æœ€ç»ˆç»˜åˆ¶çš„æ•ˆæœæ˜¯è¿™æ ·çš„ï¼š
<img loading=lazy src=../images/ComputeShader.jpg#center alt="Default Compute Shader"></p><h2 id=compute-shaderé‡Œé¢çš„ä»£ç æœ‰ä»€ä¹ˆå«ä¹‰>Compute Shaderé‡Œé¢çš„ä»£ç æœ‰ä»€ä¹ˆå«ä¹‰<a hidden class=anchor aria-hidden=true href=#compute-shaderé‡Œé¢çš„ä»£ç æœ‰ä»€ä¹ˆå«ä¹‰>#</a></h2><p>å¯ä»¥çœ‹åˆ°Compute Shaderçš„<code>#pragma kernel CSMain</code>ä½¿ç”¨äº†ä¸€ä¸ªå«åšCSMainçš„å‡½æ•°ä½œä¸ºkernelï¼Œå°±å’Œæ™®é€šshaderä¸­çš„vertexå’Œfragmentå·®ä¸å¤šã€‚è¿™ä¸ªCompute Shaderçš„è¾“å…¥å’Œè¾“å‡ºæ˜¯åŒä¸€å¼ float4çš„2Dè´´å›¾Resultã€‚RWTexture2Dçš„RW(Read Write)è¡¨ç¤ºè¿™å¼ è´´å›¾æ”¯æŒéšæœºè¯»å†™(unordered access view, UAV)ï¼Œè¿™æ ·åœ¨Compute Shaderè¯»å–è¿™å¼ è´´å›¾çš„åŒæ—¶ä¹Ÿèƒ½å¯¹è¿™å¼ è´´å›¾è¿›è¡Œå†™å…¥ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ä¸€å¼ å¯è¯»å†™è´´å›¾ï¼Œå’Œä¸¤å¼ è´´å›¾ä¸€å¼ è¯»ä¸€å¼ å†™ï¼Œåœ¨éœ€è¦è¯»å–é™¤å½“å‰åƒç´ å¤–çš„åƒç´ ä¿¡æ¯å¹¶å†™å…¥å½“å‰åƒç´ æ—¶ï¼Œæ˜¯ä¼šæœ‰ä¸€å®šåŒºåˆ«çš„ã€‚å†æœ‰å°±æ˜¯CSMainä¸­ä¸¤æ¡çœ‹ä¸å¤ªæ‡‚çš„ä»£ç äº†<code>[numthreads(8,8,1)]</code>å’Œ<code>SV_DispatchThreadID</code>ã€‚è¿™é‡Œå¯ä»¥å‚è€ƒ<a href=https://docs.microsoft.com/en-us/windows/win32/direct3dhlsl/sv-dispatchthreadid>HLSLå®˜æ–¹æ–‡æ¡£</a>ä¸Šçš„å®šä¹‰æ¥è¿›è¡Œç†è§£ï¼š
<img loading=lazy src=../images/threadgroupids.png#center alt=DispatchThreadID></p><p>é€šå¸¸ç”¨åˆ°çš„æœ‰<code>SV_GroupID</code>, <code>SV_GroupThreadID</code>, <code>SV_GroupIndex</code>, å’Œ<code>SV_DispatchThreadID</code>ï¼Œä¸€èˆ¬æŒ‰æˆ‘çš„æƒ³æ³•ï¼Œæˆ‘è¿˜ä¼šé¢å¤–ä¼ å…¥ä¸€ä¸ª<code>_DispatchCount</code>è®°å½•Compute Shaderçš„Dispatchçš„æ•°ç›®ã€‚Compute Shaderæ˜¯è¿™æ ·è¿ä½œçš„ï¼šå‡è®¾æˆ‘ä»¬æ‰§è¡Œäº†<code>Dispatch(5, 3, 2)</code>å’Œ<code>numthreads(10, 8, 3)</code>ï¼Œé‚£ä¹ˆä¸€å…±ä¼šäº§ç”Ÿ5 * 3 * 2 = 30ä¸ªThread Groupï¼Œæ¯ä¸ªThread Groupä¼šæœ‰ä¸€ä¸ª<code>SV_GroupID</code>ï¼ŒèŒƒå›´æ˜¯(0, 0, 0)åˆ°(4, 2, 1)ï¼›æ¯ä¸ªThread Groupä¸­ä¼šæœ‰10 * 8 * 3ä¸ªThreadï¼Œæ¯ä¸ªThreadä¼šæœ‰ä¸€ä¸ª<code>SV_GroupThreadID</code>, <code>SV_GroupIndex</code>å’Œ<code>SV_DispatchThreadID</code>ã€‚<code>SV_GroupThreadID</code>çš„èŒƒå›´æ˜¯(0, 0, 0)åˆ°(9, 7, 2)ã€‚<code>SV_GroupIndex</code>æ˜¯Threadåœ¨Thread Groupå†…çš„åºå·ï¼Œå…¶å€¼ç­‰äº<code>SV_GroupThreadID.z * numthreads.y * numthreads.x + SV_GroupThreadID.y * numthreads.x + SV_GroupThreadID.x</code>ï¼Œå…¶èŒƒå›´æ˜¯0åˆ°10 * 8 * 3 - 1ï¼Œåœ¨æ¶‰åŠåˆ°groupshared memoryçš„æ—¶å€™ï¼Œå¾€å¾€ä¼šç”¨åˆ°<code>SV_GroupIndex</code>ã€‚<code>SV_DispatchThreadID</code>çš„èŒƒå›´æ˜¯(0, 0, 0)åˆ°(5 * 10 - 1, 3 * 8 -1, 2 * 3 - 1)ï¼Œ<code>SV_DispatchThreadID</code>çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯¹äºä»»ä½•ä¸€ä¸ªThreadï¼Œå®ƒçš„<code>SV_DispatchThreadID</code>éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œå› æ­¤åœ¨å¾ˆå¤šæƒ…å†µä¸‹éƒ½å¯ä»¥åˆ©ç”¨<code>SV_DispatchThreadID</code>æ¥è¿›è¡Œæ•°æ®æ“ä½œï¼›æ­¤å¤–ï¼Œåœ¨ä½¿ç”¨RWStructuredBufferæ¥ä½œä¸ºè¾“å…¥è¾“å‡ºçš„æ—¶å€™ï¼Œå¾€å¾€ä¼šéœ€è¦çŸ¥é“æ¯ä¸ªThread Groupåœ¨æ‰€æœ‰Thread Groupä¸­çš„åºå·ï¼Œæˆ–è€…æ˜¯æ¯ä¸ªThreadåœ¨æ‰€æœ‰Threadä¸­çš„åºå·ï¼Œæˆ‘å°†å…¶è®°ä¸º<code>IndexGroup</code>å’Œ<code>IndexThread</code>ï¼Œç”¨æ¥å’Œè‡ªå¸¦çš„IndexåŒºåˆ†ï¼Œ<code>IndexGroup</code>çš„å€¼ç­‰äº<code>SV_GroupID.z * _DispatchCount.y * _DispatchCount.x + SV_GroupID.y * _DispatchCount.x + SV_GroupID.x</code>ï¼ŒèŒƒå›´æ˜¯0åˆ°5 * 3 * 2 - 1ï¼Œ<code>IndexThread</code>çš„å€¼ç­‰äº<code>IndexGroup * numthreads.z * numthreads.y * numthreads.x + SV_GroupIndex</code>ï¼ŒèŒƒå›´æ˜¯0åˆ°5 * 3 * 2 * 10 * 8 * 3 - 1ã€‚æ­¤å¤–è¿˜è¦æ³¨æ„ï¼Œç”±äºDispatchCountæœ‰è¢«å‘ä¸Šå–æ•´çš„å¯èƒ½ï¼Œæ‰€å¾—åˆ°çš„å¦‚<code>SV_DispatchThreadID</code>å¯èƒ½ä¼šè¶…è¿‡è´´å›¾ã€Bufferçš„å¤§å°ï¼Œæœ€å¥½å†ä¼ å…¥ä¸€ä¸ª<code>_TextureSize</code>æ¥å°†<code>SV_DisparchThreadID</code>é™åˆ¶åˆ°åˆé€‚çš„å¤§å°ã€‚</p><p>ç‰¹åˆ«éœ€è¦è®°ä½çš„æ˜¯ï¼ŒCompute Shaderä¸­çš„numthreadsã€DispatchCountè¿™äº›æ•°å€¼ï¼Œè·Ÿè¾“å¦‚è¾“å‡ºçš„æ•°æ®ç»“æ„æ²¡æœ‰ç›´æ¥çš„å…³ç³»ï¼Œå¯¹äºä»»æ„çš„æ•°æ®ç»“æ„ï¼Œéƒ½èƒ½ä½¿ç”¨â€œä»»æ„â€çš„numthreadså’ŒDispatchCountï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦åœ¨ä»£ç ä¸­æŒ‡å®šè¿™äº›æ•°å€¼å’Œè¾“å…¥è¾“å‡ºçš„æ•°æ®ç»“æ„çš„å…³ç³»ã€‚æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ä½¿ç”¨<code>IndexThread</code>æ¥è¯»å–å†™å…¥RWStructuredBufferï¼Œç”¨<code>SV_DispatchThreadID</code>æ¥è¯»å–å†™å…¥è´´å›¾ã€‚</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://zznewclear13.github.io/tags/compute-shader/>Compute Shader</a></li></ul><nav class=paginav><a class=prev href=https://zznewclear13.github.io/posts/calculate-spherical-harmonics-using-compute-shader/><span class=title>Â« Prev</span><br><span>ä½¿ç”¨Compute Shaderè®¡ç®—çƒè°å…¨å±€å…‰ç…§</span></a></nav></footer><div id=comments></div><script>let currentHugoTheme=window.localStorage.getItem("pref-theme");function loadComment(){const t=document.getElementById("comments");let n=currentHugoTheme=="dark"?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","zznewclear13/zznewclear13.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","utterances"),e.setAttribute("theme",n),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),t.innerHTML="",t.appendChild(e)}loadComment(),document.getElementById("theme-toggle").onclick=async()=>{await new Promise(e=>setTimeout(e,200));let e=window.localStorage.getItem("pref-theme");e!=currentHugoTheme&&(currentHugoTheme=e,loadComment())}</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://zznewclear13.github.io/>ZZNEWCLEAR13</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>