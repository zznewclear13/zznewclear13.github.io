<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Unityçš„é«˜è´¨é‡çš„Bloomæ•ˆæœ | ZZNEWCLEAR13</title>
<meta name=keywords content="Bloom,Post-Process"><meta name=description content="ä½¿ç”¨Dual Kawase Bluråˆ¶ä½œé«˜è´¨é‡çš„Bloomæ•ˆæœ."><meta name=author content="zznewclear13"><link rel=canonical href=https://zznewclear13.github.io/posts/unity-high-quality-bloom/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://zznewclear13.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zznewclear13.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://zznewclear13.github.io/favicon.ico><link rel=apple-touch-icon href=https://zznewclear13.github.io/favicon.ico><link rel=mask-icon href=https://zznewclear13.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://zznewclear13.github.io/posts/unity-high-quality-bloom/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css integrity=sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js integrity=sha384-YNHdsYkH6gMx9y3mRkmcJ2mFUjTd0qNQQvY9VYZgQd7DcN7env35GzlmFaZ23JGp crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous onload=renderMathInElement(document.body)></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JZ0FQH1VK5"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JZ0FQH1VK5")}</script><meta property="og:title" content="Unityçš„é«˜è´¨é‡çš„Bloomæ•ˆæœ"><meta property="og:description" content="ä½¿ç”¨Dual Kawase Bluråˆ¶ä½œé«˜è´¨é‡çš„Bloomæ•ˆæœ."><meta property="og:type" content="article"><meta property="og:url" content="https://zznewclear13.github.io/posts/unity-high-quality-bloom/"><meta property="og:image" content="https://zznewclear13.github.io/posts/unity-high-quality-bloom/posts/images/HighQualityBloom.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-22T12:00:00+08:00"><meta property="article:modified_time" content="2023-07-22T12:00:00+08:00"><meta property="og:site_name" content="ZZNEWCLEAR13"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zznewclear13.github.io/posts/unity-high-quality-bloom/posts/images/HighQualityBloom.png"><meta name=twitter:title content="Unityçš„é«˜è´¨é‡çš„Bloomæ•ˆæœ"><meta name=twitter:description content="ä½¿ç”¨Dual Kawase Bluråˆ¶ä½œé«˜è´¨é‡çš„Bloomæ•ˆæœ."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zznewclear13.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Unityçš„é«˜è´¨é‡çš„Bloomæ•ˆæœ","item":"https://zznewclear13.github.io/posts/unity-high-quality-bloom/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Unityçš„é«˜è´¨é‡çš„Bloomæ•ˆæœ","name":"Unityçš„é«˜è´¨é‡çš„Bloomæ•ˆæœ","description":"ä½¿ç”¨Dual Kawase Bluråˆ¶ä½œé«˜è´¨é‡çš„Bloomæ•ˆæœ.","keywords":["Bloom","Post-Process"],"articleBody":"Bloomè¾‰å…‰æ•ˆæœ ä¸€ç›´éƒ½æƒ³åšä¸€ä¸ªBloomæ•ˆæœï¼ŒBloomæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ•ˆæœï¼Œå‡ ä¹æ‰€æœ‰ä»‹ç»åå¤„ç†çš„æ•™ç¨‹é‡Œéƒ½ä¼šæåˆ°Bloomæ•ˆæœçš„åˆ¶ä½œï¼Œä½†æ˜¯Bloomåˆæ˜¯ä¸€ä¸ªä¸é‚£ä¹ˆç®€å•çš„æ•ˆæœï¼Œå¤§éƒ¨åˆ†æ•™ç¨‹åˆ¶ä½œå‡ºæ¥çš„Bloomçœ‹ä¸Šå»éƒ½ä¸å¤ªå¥½çœ‹ã€‚\næƒ³è¦åšå¥½Bloomï¼Œé¦–å…ˆå¾—è®¤è¯†åˆ°ä»€ä¹ˆæ˜¯Bloomæ•ˆæœã€‚Bloomæ˜¯ç”±äºé€é•œä¸èƒ½å®Œç¾åœ°è®©å…‰çº¿èšç„¦ä¸åŒä¸€ç‚¹è€Œå¯¼è‡´å›¾åƒä¸Šçš„é«˜äº®åŒºåŸŸçš„é¢œè‰²å‘å‘¨å›´æº¢å‡ºçš„æ•ˆæœï¼Œå’Œä½“ç§¯é›¾è¿™æ ·çš„ç”±äºå¤šæ¬¡æ•£å°„å’ŒæŠ˜å°„å½¢æˆçš„æº¢å‡ºæ•ˆæœåœ¨åŸç†ä¸Šå°±ä¸ç›¸åŒã€‚åœ¨è®¡ç®—æœºå›¾å½¢å­¦é‡Œå¾€å¾€ä½¿ç”¨å¤šæ¬¡æ¨¡ç³Šçš„æ–¹å¼æ¥è¡¨ç°è¿™ç§æ•ˆæœã€‚\nè€Œåœ¨è®¨è®ºä»€ä¹ˆæ˜¯å¥½çš„Bloomä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å·®çš„Bloomçš„æ•ˆæœã€‚Matthew Gallantåœ¨ä»–çš„æ–‡ç« Bloom Disastersä¸­å°±ç»™å‡ºäº†å¾ˆå¤šå½“æ—¶çš„æç³Ÿç³•çš„Bloomæ•ˆæœçš„ä¾‹å­ã€‚å¯ä»¥çœ‹åˆ°Bloomå¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼ŒBloomä¹‹å‰çš„ç”»é¢å¿…é¡»è¦æ˜¯HDRçš„ç”»é¢ï¼Œå¦‚æœæ•´ä¸ªç”»é¢è¢«é™åˆ¶åœ¨01ä¹‹é—´ï¼Œé‚£ä¹ˆç™½è‰²çš„Tæ¤å’Œç‰¹åˆ«äº®ä»¥è‡³äºçœ‹ä¸Šå»æ˜¯ç™½è‰²çš„å¤ªé˜³å¸¦æ¥çš„Bloomæ•ˆæœå°±ä¼šç›¸åŒã€‚åœ¨LearnOpenGLä¸Šæœ‰é‚£ä¹ˆä¸€ç¯‡æ–‡ç« ï¼Œå…¶ä¸­è¯´åˆ°ï¼Œä¸ºäº†æ¨¡æ‹Ÿæˆ‘ä»¬çœ¼ç›çš„å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬ä¸å¯¹é¢œè‰²è¿›è¡Œé˜ˆå€¼é™åˆ¶ï¼Œè€Œæ˜¯ç›´æ¥å¯¹HDRç”»é¢è¿›è¡Œæ¨¡ç³Šå†å’ŒåŸHDRç”»é¢è¿›è¡Œæ’å€¼ã€‚æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ç§ååˆ†é”™è¯¯çš„æ–¹å¼ã€‚æœ€åˆç†çš„æ–¹å¼åº”å½“æ˜¯ï¼Œç”»é¢ä¸Šçš„æ¯ä¸ªé¢œè‰²ç¡®å®ä¼šå‘å‘¨å›´æº¢å‡ºè‡ªå·±çš„é¢œè‰²ï¼Œä½†æ˜¯æ›´äº®çš„é¢œè‰²çš„æº¢å‡ºåŠå¾„ä¼šæ›´å¤§ï¼Œå¯¹äºè¾ƒæš—çš„é¢œè‰²ï¼Œç”±äºæº¢å‡ºåŠå¾„å°äºåŠä¸ªåƒç´ å®½ï¼Œåœ¨æœ€åçš„ç”»é¢ä¸­å°±çœ‹ä¸åˆ°é¢œè‰²çš„æº¢å‡ºäº†ã€‚ä½†æ˜¯æ ¹æ®æ˜åº¦æ¥æ§åˆ¶æº¢å‡ºçš„åŠå¾„æ˜¯ä¸€ä»¶å¾ˆå¤æ‚çš„äº‹æƒ…ï¼ˆè¿™å’Œæ™¯æ·±çš„åŸç†æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘åˆ°ç°åœ¨éƒ½æ²¡æœ‰æŒæ¡ä¸€ä¸ªå¾ˆå¥½çš„æ™¯æ·±çš„ç®—æ³•ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è®¡ç®—çš„æ—¶å€™é€šè¿‡ä»…æ¨¡ç³Šè¶…å‡ºé˜ˆå€¼çš„é¢œè‰²æ¥æ¨¡æ‹Ÿè¿™ç§æ•ˆæœã€‚æ¨¡ç³ŠåŠå¾„ä¹Ÿæ˜¯ä¸€ä¸ªå†³å®šBloomè´¨é‡çš„å…³é”®è¦ç´ ï¼Œå¦‚æœæ¨¡ç³Šçš„åŠå¾„æ¯”è¾ƒå°ï¼Œçœ‹ä¸Šå»å°±åƒé«˜å…‰å¥—äº†ä¸€ä¸ªç¨å¼±çš„åœˆä¸€æ ·ï¼Œä¸å¤Ÿç¾è§‚ã€‚\nJorge Jimenezåœ¨2014å¹´Siggraphå¤šçš„Advances in Real-Time Renderingè¯¾ç¨‹ä¸Šä»‹ç»äº†ä»–ä¸ºä½¿å‘½å¬å”¤ç°ä»£æˆ˜äº‰æ‰€åšçš„æ¬¡ä¸–ä»£åå¤„ç†æ•ˆæœã€‚ä»–çš„PPTé‡Œä»‹ç»äº†ä½¿å‘½å¬å”¤ç°ä»£æˆ˜äº‰ä¸­è¿åŠ¨æ¨¡ç³Šã€æ•£æ™¯ã€æ¬¡è¡¨é¢æ•£å°„ã€Bloomå’Œé˜´å½±é‡‡æ ·çš„åšæ³•ï¼Œååˆ†å€¼å¾—ä¸€çœ‹ã€‚æœ¬æ–‡åœ¨æ•´ä½“çš„ç®—æ³•ä¸Šå°±ä½¿ç”¨äº†ä»–ä»‹ç»çš„æ–¹æ³•ï¼Œè€Œé‡‡æ ·åˆ™ä½¿ç”¨äº†Dual Kawase Blurçš„ç®—æ³•ï¼Œå¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„æ–‡ç« ã€‚\nBloomçš„ç®—æ³• ä¸»æµçš„Bloomç®—æ³•éƒ½ä¼šä½¿ç”¨ä¸€ä¸ªé˜ˆå€¼ï¼Œç¬¬ä¸€ä¸ªPassæå–å‡ºå¤§äºè¿™ä¸ªé˜ˆå€¼çš„é¢œè‰²ï¼ˆä½¿ç”¨å‡æ³•ï¼Œè¿™æ ·èƒ½å¤Ÿå’Œå°äºé˜ˆå€¼çš„é¢œè‰²å½¢æˆè‡ªç„¶çš„è¿‡æ¸¡ï¼‰ï¼Œç„¶åè¿›è¡Œä¸€ç³»åˆ—çš„é™é‡‡æ ·å‡é‡‡æ ·ä»¥å‡å°‘é‡‡æ ·çš„æ¬¡æ•°ï¼Œæœ€åå°†ä¹‹å‰æ‰€æœ‰çš„å‡é‡‡æ ·çš„æ¨¡ç³Šç»“æœï¼ˆå°±ç›¸å½“äºæ˜¯Mipçš„æ¯ä¸€çº§ï¼‰å åŠ åˆ°ä¸€å¼€å§‹çš„é¢œè‰²ä¸Šã€‚ä¸ºäº†å‡å°‘æœ€åä¸€æ­¥é‡‡æ ·æ‰€æœ‰çš„Mipç­‰çº§å¸¦æ¥çš„æ¶ˆè€—ï¼Œæ ¹æ®Jorge Jimenezçš„åšæ³•ï¼Œæˆ‘ä»¬ä¼šåœ¨æ¯ä¸€æ­¥å‡é‡‡æ ·æ—¶å åŠ å½“å‰Mipçš„é¢œè‰²ã€‚ä½†æ˜¯æœ€åå åŠ ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤„ç†æ–¹æ³•ï¼Œç”±äºå åŠ äº†å„ä¸ªMipçš„é¢œè‰²ï¼Œä¼šå¯¼è‡´åŸæ¥é«˜å…‰çš„åŒºåŸŸçš„äº®åº¦ä¼šè¢«æé«˜åˆ°åŸæ¥çš„ä¸¤å€ç”šè‡³æ›´å¤šï¼Œä¸è¿‡æˆ‘ä»¬ä¹‹åçš„Tone Mappingèƒ½å¤Ÿä¸€å®šç¨‹åº¦ä¸Šç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚ç„¶åæ˜¯å¯¹å¾®å°çš„é«˜äº®ç‰©ä½“çš„å¤„ç†ï¼ŒJorge Jimenezä½¿ç”¨äº†1/(1 + Luma)çš„æ–¹å¼è¿›è¡ŒåŠ æƒå¤„ç†ï¼Œä¸è¿‡å¦‚æœæˆ‘ä»¬å°†Bloomç§»åŠ¨åˆ°TAAä¹‹åï¼Œè¿™ä¸ªé—®é¢˜èƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³æ‰ã€‚è‡³äºæ¨¡ç³Šï¼Œåœ¨æˆ‘ä¹‹å‰é‚£ä¹ˆå¤šæ–‡ç« çš„é“ºå«ä¸‹ï¼Œä¹Ÿå°±ä¸æ˜¯ä»€ä¹ˆéš¾ç‚¹äº†ã€‚\næˆ‘è‡ªå·±åœ¨å®ç°çš„æ—¶å€™ï¼Œä¼šåœ¨æœ€åä¸€æ­¥å åŠ Mipåˆ°æœ€ä¸€å¼€å§‹çš„å›¾åƒæ—¶ï¼Œå°†æ¨¡ç³Šåçš„é¢œè‰²é™¤ä»¥æ‰€æœ‰çš„é™é‡‡æ ·æ¬¡æ•°ï¼Œè¿™æ ·èƒ½å¤Ÿç¨å¾®å¼¥è¡¥ä¸€ä¸‹å¤šä¸ªMipå¸¦æ¥çš„äº®åº¦å‰§çƒˆå¢åŠ çš„é—®é¢˜ã€‚äº‹å®ä¸Šæˆ‘ä¹Ÿæƒ³è¿‡å°†å› ä¸ºé˜ˆå€¼è€Œä¸¢å¤±çš„äº®åº¦å‚¨å­˜åœ¨é€æ˜é€šé“é‡Œï¼Œå’Œé¢œè‰²ä¸€èµ·å‚ä¸æ¨¡ç³Šï¼Œåœ¨æœ€åçš„æ—¶å€™åŠ å›ä¹‹å‰ä¸¢å¤±çš„äº®åº¦ï¼Œæœ€åå’ŒåŸå§‹é¢œè‰²çº¿æ€§æ’å€¼ï¼Œä¸è¿‡ä¼¼ä¹ä¸é‚£ä¹ˆå¥½åšã€‚\nè¿™é‡Œå¯ä»¥å¯¹æ¯”ä¸€ä¸‹Unityè‡ªå¸¦çš„Bloomå’Œæˆ‘çš„Bloomä¹‹é—´çš„æ•ˆæœå·®å¼‚ã€‚Unityç¬¬ä¸€ä¸ªPassé¢„è¿‡æ»¤ä¼šè¿›è¡Œ13æ¬¡é‡‡æ ·ï¼Œä¹‹åæ¯ä¸€æ¬¡é™é‡‡æ ·åˆ†æˆæ¨ªç«–ä¸¤ä¸ªæ–¹å‘ï¼Œæ¨ªå‘9æ¬¡é‡‡æ ·ï¼Œç«–å‘5æ¬¡é‡‡æ ·ï¼Œå‡é‡‡æ ·åˆ™æ˜¯åœ¨2æ¬¡é‡‡æ ·ä¸­çº¿æ€§æ’å€¼ã€‚æˆ‘çš„åˆ™æ˜¯æ¯æ¬¡é™é‡‡æ ·è¿›è¡Œ5æ¬¡é‡‡æ ·ï¼Œæ¯æ¬¡å‡é‡‡æ ·è¿›è¡Œ8+1æ¬¡é‡‡æ ·ï¼Œä¸éœ€è¦åˆ†æ¨ªç«–é‡‡æ ·ã€‚ä¸‹å›¾ä¸Šè¾¹æ˜¯Unityè‡ªå¸¦çš„Bloomï¼Œä¸‹è¾¹æ˜¯æˆ‘çš„Bloomï¼Œæœ€åå‡ä½¿ç”¨Aces Tonemappingï¼Œåœºæ™¯é‡Œçš„å¤§ç«‹æ–¹ä½“çš„å¤§å°æ˜¯ç›¸é‚»å°ç«‹æ–¹ä½“çš„1.5å€ï¼Œè€Œå°ç«‹æ–¹ä½“çš„äº®åº¦æ˜¯ç›¸é‚»å¤§ç«‹æ–¹ä½“çš„1.5å€ã€‚æˆ‘å°½é‡åœ°å°†å‚æ•°è°ƒçš„å·®ä¸å¤šï¼ŒUnityä¸€å…±22ä¸ªDrawæœ€é«˜Mipä¸º7ï¼Œæˆ‘çš„ä¸€å…±17ä¸ªDrawæœ€é«˜Mipä¸º8ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°Unityçš„ä¼šæœ‰ç¨å¾®æ˜æ˜¾ä¸€ç‚¹çš„Bandingï¼Œä¸­é—´äº®åº¦çš„ä¸­é—´å¤§å°çš„ç‰©ä½“å¸¦æ¥çš„Bloomæ¯”æˆ‘çš„ç¨å¾®å¤§ä¸€äº›ã€‚\nUnity Default Bloom\nMy High Quality Bloom\nBloomçš„å…·ä½“å®ç° HQBloomComputeShader.compute è¿™é‡Œæœ‰å››ä¸ªKernelï¼ŒHQBloomWeightedDownsampleç”¨äºç¬¬ä¸€æ¬¡é™é‡‡æ ·æ—¶å‡å»é˜ˆå€¼å¹¶åŠ æƒè¿›è¡Œæ¨¡ç³Šï¼ŒHQBloomDownsampleæ˜¯å’ŒDual Kawase Blurä¸€æ ·çš„é™é‡‡æ ·çš„æ¨¡ç³Šï¼ŒHQBloomAdditiveUpsampleæ˜¯åœ¨Dual Kawase Blurçš„å‡é‡‡æ ·çš„åŸºç¡€ä¸Šå’Œä½ä¸€çº§çš„Mipå åŠ ï¼ŒHQBloomCompositeåˆ™æ˜¯å°†æœ€ä½ä¸€çº§Mipå’ŒåŸå§‹é¢œè‰²è¿›è¡Œæ··åˆã€‚\n#pragma kernel HQBloomDownsample #pragma kernel HQBloomWeightedDownsample #pragma kernel HQBloomAdditiveUpsample #pragma kernel HQBloomComposite #include \"Packages/com.unity.render-pipelines.core/ShaderLibrary/Common.hlsl\" #include \"Packages/com.unity.render-pipelines.core/ShaderLibrary/Color.hlsl\" #include \"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl\" Texture2D\u003cfloat4\u003e _SourceTexture; Texture2D\u003cfloat4\u003e _ColorTexture; RWTexture2D\u003cfloat4\u003e _RW_TargetTexture; SamplerState sampler_LinearClamp; float4 _SourceSize; float4 _TargetSize; float _Threshold; float _InvDownsampleCount; float _BloomIntensity; float3 applyThreshold(float3 color, out float luma) { luma = Luminance(color); return color * max(0.0f, luma - _Threshold); } float getLumaWeight(float luma) { return rcp(1.0f + luma); } float getLumaWeight(float3 color) { float luma = Luminance(color); return rcp(1.0f + luma); } float3 sampleSource(float2 center, float2 offset) { return _SourceTexture.SampleLevel(sampler_LinearClamp, center + offset, 0.0f).rgb; } [numthreads(8, 8, 1)] void HQBloomDownsample(uint3 id : SV_DispatchThreadID) { float2 uv = (float2(id.xy) + 0.5f) * _TargetSize.zw; float2 halfPixel = 0.5f * _TargetSize.zw; float3 c = sampleSource(uv, float2(0.0f, 0.0f)); float3 tl = sampleSource(uv, halfPixel * float2(-1.0f, +1.0f)); float3 tr = sampleSource(uv, halfPixel * float2(+1.0f, +1.0f)); float3 bl = sampleSource(uv, halfPixel * float2(-1.0f, -1.0f)); float3 br = sampleSource(uv, halfPixel * float2(+1.0f, -1.0f)); float3 color = (tl + tr + bl + br + c * 4.0f) / 8.0f; _RW_TargetTexture[id.xy] = float4(color, 1.0f); } [numthreads(8, 8, 1)] void HQBloomWeightedDownsample(uint3 id : SV_DispatchThreadID) { float2 uv = (float2(id.xy) + 0.5f) * _TargetSize.zw; float2 halfPixel = 0.5f * _TargetSize.zw; float lumac, lumatl, lumatr, lumabl, lumabr; float3 c = applyThreshold(sampleSource(uv, float2(0.0f, 0.0f)), lumac); float3 tl = applyThreshold(sampleSource(uv, halfPixel * float2(-1.0f, +1.0f)), lumatl); float3 tr = applyThreshold(sampleSource(uv, halfPixel * float2(+1.0f, +1.0f)), lumatr); float3 bl = applyThreshold(sampleSource(uv, halfPixel * float2(-1.0f, -1.0f)), lumabl); float3 br = applyThreshold(sampleSource(uv, halfPixel * float2(+1.0f, -1.0f)), lumabr); float3 wc = getLumaWeight(lumac); float3 wtl = getLumaWeight(lumatl); float3 wtr = getLumaWeight(lumatr); float3 wbl = getLumaWeight(lumabl); float3 wbr = getLumaWeight(lumabr); float3 colorSum = tl * wtl + tr * wtr + bl * wbl + br * wbr + c * wc * 4.0f; float3 weightSum = wtl + wtr + wbl + wbr + wc * 4.0f; float3 color = colorSum / weightSum; _RW_TargetTexture[id.xy] = float4(color, 1.0f); } [numthreads(8, 8, 1)] void HQBloomAdditiveUpsample(uint3 id : SV_DispatchThreadID) { float2 uv = (float2(id.xy) + 0.5f) * _TargetSize.zw; float2 onePixel = 1.0f * _TargetSize.zw; // float3 c = sampleSource(uv, float2(0.0f, 0.0f)); float3 t2 = sampleSource(uv, onePixel * float2(+0.0f, +2.0f)); float3 b2 = sampleSource(uv, onePixel * float2(+0.0f, -2.0f)); float3 l2 = sampleSource(uv, onePixel * float2(-2.0f, +0.0f)); float3 r2 = sampleSource(uv, onePixel * float2(+2.0f, +0.0f)); float3 tl = sampleSource(uv, onePixel * float2(-1.0f, +1.0f)); float3 tr = sampleSource(uv, onePixel * float2(+1.0f, +1.0f)); float3 bl = sampleSource(uv, onePixel * float2(-1.0f, -1.0f)); float3 br = sampleSource(uv, onePixel * float2(+1.0f, -1.0f)); float3 color = (t2 + b2 + l2 + r2 + 2.0f * (tl + tr + bl + br)) / 12.0f; float3 prevTarget = _RW_TargetTexture.Load(uint3(id.xy, 0)); _RW_TargetTexture[id.xy] = float4(color + prevTarget, 1.0f); } [numthreads(8, 8, 1)] void HQBloomComposite(uint3 id : SV_DispatchThreadID) { float2 uv = (float2(id.xy) + 0.5f) * _TargetSize.zw; float2 onePixel = 1.0f * _TargetSize.zw; // float3 c = sampleSource(uv, float2(0.0f, 0.0f)); float3 t2 = sampleSource(uv, onePixel * float2(+0.0f, +2.0f)); float3 b2 = sampleSource(uv, onePixel * float2(+0.0f, -2.0f)); float3 l2 = sampleSource(uv, onePixel * float2(-2.0f, +0.0f)); float3 r2 = sampleSource(uv, onePixel * float2(+2.0f, +0.0f)); float3 tl = sampleSource(uv, onePixel * float2(-1.0f, +1.0f)); float3 tr = sampleSource(uv, onePixel * float2(+1.0f, +1.0f)); float3 bl = sampleSource(uv, onePixel * float2(-1.0f, -1.0f)); float3 br = sampleSource(uv, onePixel * float2(+1.0f, -1.0f)); float3 color = (t2 + b2 + l2 + r2 + 2.0f * (tl + tr + bl + br)) / 12.0f; float3 colorTexture = _ColorTexture.Load(uint3(id.xy, 0)); float3 bloomColor = colorTexture + color * _BloomIntensity * _InvDownsampleCount; _RW_TargetTexture[id.xy] = float4(bloomColor, 1.0f); } HQBloom.cs æ²¡å•¥å¥½è¯´çš„ã€‚\nusing System; namespace UnityEngine.Rendering.Universal { [Serializable, VolumeComponentMenuForRenderPipeline(\"Post-processing/HQ Bloom\", typeof(UniversalRenderPipeline))] public sealed class HQBloom : VolumeComponent, IPostProcessComponent { public BoolParameter isEnabled = new BoolParameter(false); public ClampedFloatParameter intensity = new ClampedFloatParameter(1.0f, 0.0f, 1.0f); public ClampedFloatParameter threshold = new ClampedFloatParameter(0.9f, 0.0f, 5.0f); public ClampedIntParameter downsampleCount = new ClampedIntParameter(7, 3, 10); public bool IsActive() { return isEnabled.value \u0026\u0026 intensity.value \u003e 0.0f; } public bool IsTileCompatible() { return false; } } } HQBloomRenderPass.cs è¿™ä¸ªè„šæœ¬ç›¸è¾ƒäºDual Kawase Bluræ¥è¯´è¦ç¨å¾®ç®€å•ä¸€ç‚¹ï¼Œå› ä¸ºBloomæ•ˆæœå¾€å¾€åªä¼šè°ƒæ•´å…¶å¼ºå¼±ï¼Œè€Œä¸ä¼šè°ƒæ•´åŠå¾„ï¼Œä¸éœ€è¦åœ¨ä¸¤ä¸ªé™é‡‡æ ·ä¹‹é—´å†åšçº¿æ€§æ’å€¼äº†ã€‚\nusing System.Collections.Generic; namespace UnityEngine.Rendering.Universal { public class HQBloomRenderPass : ScriptableRenderPass { static readonly string passName = \"HQ Bloom Render Pass\"; private HQBloomRendererFeature.HQBloomSettings settings; private HQBloom hqBloom; private ComputeShader computeShader; static readonly string cameraColorTextureName = \"_CameraColorAttachmentA\"; static readonly int cameraColorTextureID = Shader.PropertyToID(cameraColorTextureName); RenderTargetIdentifier cameraColorIden; private Vector2Int textureSize; private RenderTextureDescriptor desc; public HQBloomRenderPass(HQBloomRendererFeature.HQBloomSettings settings) { profilingSampler = new ProfilingSampler(passName); this.settings = settings; renderPassEvent = settings.renderPassEvent; computeShader = settings.computeShader; cameraColorIden = new RenderTargetIdentifier(cameraColorTextureID); } public void Setup(HQBloom hqBloom) { this.hqBloom = hqBloom; } public override void Configure(CommandBuffer cmd, RenderTextureDescriptor cameraTextureDescriptor) { textureSize = new Vector2Int(cameraTextureDescriptor.width, cameraTextureDescriptor.height); desc = cameraTextureDescriptor; desc.enableRandomWrite = true; desc.msaaSamples = 1; desc.depthBufferBits = 0; } private Vector4 GetTextureSizeParams(Vector2Int size) { return new Vector4(size.x, size.y, 1.0f / size.x, 1.0f / size.y); } private void DoHQBloomDownsample(CommandBuffer cmd, RenderTargetIdentifier sourceid, RenderTargetIdentifier targetid, Vector2Int sourceSize, Vector2Int targetSize, bool firstDownsample, ComputeShader computeShader) { if (!computeShader) return; string kernelName = firstDownsample ? \"HQBloomWeightedDownsample\" : \"HQBloomDownsample\"; int kernelID = computeShader.FindKernel(kernelName); computeShader.GetKernelThreadGroupSizes(kernelID, out uint x, out uint y, out uint z); cmd.SetComputeTextureParam(computeShader, kernelID, \"_SourceTexture\", sourceid); cmd.SetComputeTextureParam(computeShader, kernelID, \"_RW_TargetTexture\", targetid); cmd.SetComputeVectorParam(computeShader, \"_SourceSize\", GetTextureSizeParams(sourceSize)); cmd.SetComputeVectorParam(computeShader, \"_TargetSize\", GetTextureSizeParams(targetSize)); cmd.SetComputeFloatParam(computeShader, \"_Threshold\", hqBloom.threshold.value); cmd.DispatchCompute(computeShader, kernelID, Mathf.CeilToInt((float)targetSize.x / x), Mathf.CeilToInt((float)targetSize.y / y), 1); } private void DoHQBloomAdditiveUpsample(CommandBuffer cmd, RenderTargetIdentifier sourceid, RenderTargetIdentifier targetid, Vector2Int sourceSize, Vector2Int targetSize, ComputeShader computeShader) { if (!computeShader) return; string kernelName = \"HQBloomAdditiveUpsample\"; int kernelID = computeShader.FindKernel(kernelName); computeShader.GetKernelThreadGroupSizes(kernelID, out uint x, out uint y, out uint z); cmd.SetComputeTextureParam(computeShader, kernelID, \"_SourceTexture\", sourceid); cmd.SetComputeTextureParam(computeShader, kernelID, \"_RW_TargetTexture\", targetid); cmd.SetComputeVectorParam(computeShader, \"_SourceSize\", GetTextureSizeParams(sourceSize)); cmd.SetComputeVectorParam(computeShader, \"_TargetSize\", GetTextureSizeParams(targetSize)); cmd.DispatchCompute(computeShader, kernelID, Mathf.CeilToInt((float)targetSize.x / x), Mathf.CeilToInt((float)targetSize.y / y), 1); } private void DoHQloomComposite(CommandBuffer cmd, RenderTargetIdentifier sourceid, RenderTargetIdentifier colorid, RenderTargetIdentifier targetid, Vector2Int sourceSize, Vector2Int targetSize, ComputeShader computeShader) { if (!computeShader) return; string kernelName = \"HQBloomComposite\"; int kernelID = computeShader.FindKernel(kernelName); computeShader.GetKernelThreadGroupSizes(kernelID, out uint x, out uint y, out uint z); cmd.SetComputeTextureParam(computeShader, kernelID, \"_SourceTexture\", sourceid); cmd.SetComputeTextureParam(computeShader, kernelID, \"_ColorTexture\", colorid); cmd.SetComputeTextureParam(computeShader, kernelID, \"_RW_TargetTexture\", targetid); cmd.SetComputeVectorParam(computeShader, \"_SourceSize\", GetTextureSizeParams(sourceSize)); cmd.SetComputeVectorParam(computeShader, \"_TargetSize\", GetTextureSizeParams(targetSize)); cmd.SetComputeFloatParam(computeShader, \"_InvDownsampleCount\", 1.0f / hqBloom.downsampleCount.value); cmd.SetComputeFloatParam(computeShader, \"_BloomIntensity\", hqBloom.intensity.value); cmd.DispatchCompute(computeShader, kernelID, Mathf.CeilToInt((float)targetSize.x / x), Mathf.CeilToInt((float)targetSize.y / y), 1); } public override void Execute(ScriptableRenderContext context, ref RenderingData renderingData) { CommandBuffer cmd = CommandBufferPool.Get(); using (new ProfilingScope(cmd, profilingSampler)) { List\u003cint\u003e rtIDs = new List\u003cint\u003e(); List rtSizes = new List(); RenderTextureDescriptor tempDesc = desc; string bloomRT = \"_BloomRT\"; int bloomRTID = Shader.PropertyToID(bloomRT); cmd.GetTemporaryRT(bloomRTID, tempDesc); rtIDs.Add(bloomRTID); rtSizes.Add(textureSize); Vector2Int lastSize = textureSize; int lastID = cameraColorTextureID; int downsampleCount = hqBloom.downsampleCount.value; for (int i = 0; i \u003c downsampleCount; i++) { string rtName = \"_BloomRT\" + i.ToString(); int rtID = Shader.PropertyToID(rtName); Vector2Int rtSize = new Vector2Int((lastSize.x + 1) / 2, (lastSize.y + 1) / 2); tempDesc.width = rtSize.x; tempDesc.height = rtSize.y; cmd.GetTemporaryRT(rtID, tempDesc); rtIDs.Add(rtID); rtSizes.Add(rtSize); DoHQBloomDownsample(cmd, lastID, rtID, lastSize, rtSize, i == 0, computeShader); lastID = rtID; lastSize = rtSize; } for (int i = downsampleCount; i \u003e= 1; i--) { int sourceID = rtIDs[i]; Vector2Int sourceSize = rtSizes[i]; int targetID = rtIDs[i-1]; Vector2Int targetSize = rtSizes[i-1]; if(i == 1) { DoHQloomComposite(cmd, sourceID, cameraColorIden, targetID, sourceSize, targetSize, computeShader); cmd.Blit(targetID, cameraColorIden); cmd.ReleaseTemporaryRT(targetID); } else { DoHQBloomAdditiveUpsample(cmd, sourceID, targetID, sourceSize, targetSize, computeShader); } cmd.ReleaseTemporaryRT(sourceID); } } context.ExecuteCommandBuffer(cmd); cmd.Clear(); CommandBufferPool.Release(cmd); } } } HQBloomRendererFeature.cs æ²¡å•¥å¥½è¯´çš„ã€‚\nnamespace UnityEngine.Rendering.Universal { public class HQBloomRendererFeature : ScriptableRendererFeature { [System.Serializable] public class HQBloomSettings { public RenderPassEvent renderPassEvent = RenderPassEvent.BeforeRenderingPostProcessing; public ComputeShader computeShader; } public HQBloomSettings settings = new HQBloomSettings(); private HQBloomRenderPass hqBloomRenderPass; public override void Create() { hqBloomRenderPass = new HQBloomRenderPass(settings); } public override void AddRenderPasses(ScriptableRenderer renderer, ref RenderingData renderingData) { HQBloom HQBloom = VolumeManager.instance.stack.GetComponent(); if (HQBloom != null \u0026\u0026 HQBloom.IsActive()) { hqBloomRenderPass.Setup(HQBloom); renderer.EnqueuePass(hqBloomRenderPass); } } } } ","wordCount":"1256","inLanguage":"en","image":"https://zznewclear13.github.io/posts/unity-high-quality-bloom/posts/images/HighQualityBloom.png","datePublished":"2023-07-22T12:00:00+08:00","dateModified":"2023-07-22T12:00:00+08:00","author":{"@type":"Person","name":"zznewclear13"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zznewclear13.github.io/posts/unity-high-quality-bloom/"},"publisher":{"@type":"Organization","name":"ZZNEWCLEAR13","logo":{"@type":"ImageObject","url":"https://zznewclear13.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://zznewclear13.github.io/ accesskey=h title="ZZNEWCLEAR13 (Alt + H)"><img src=https://zznewclear13.github.io/apple-touch-icon.png alt aria-label=logo height=35>ZZNEWCLEAR13</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zznewclear13.github.io/now/ title=è¿›è¡Œæ—¶><span>è¿›è¡Œæ—¶</span></a></li><li><a href=https://zznewclear13.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://zznewclear13.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://zznewclear13.github.io/links/ title=å‹æƒ…é“¾æ¥><span>å‹æƒ…é“¾æ¥</span></a></li><li><a href=https://zznewclear13.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zznewclear13.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://zznewclear13.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Unityçš„é«˜è´¨é‡çš„Bloomæ•ˆæœ</h1><div class=post-description>ä½¿ç”¨Dual Kawase Bluråˆ¶ä½œé«˜è´¨é‡çš„Bloomæ•ˆæœ.</div><div class=post-meta><span title='2023-07-22 12:00:00 +0800 CST'>July 22, 2023</span>&nbsp;Â·&nbsp;zznewclear13&nbsp;|&nbsp;<a href=https://github.com/zznewclear13/zznewclear13.com/blob/main/content/posts/unity-high-quality-bloom.md rel="noopener noreferrer" target=_blank>ç¼–è¾‘</a></div></header><figure class=entry-cover><img loading=eager src=https://zznewclear13.github.io/posts/images/HighQualityBloom.png alt="High Quality Bloom Cover"><p>High Quality Bloom Result</p></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>Unityçš„é«˜è´¨é‡çš„Bloomæ•ˆæœ</div></summary><div class=inner><ul><li><a href=#bloom%e8%be%89%e5%85%89%e6%95%88%e6%9e%9c aria-label=Bloomè¾‰å…‰æ•ˆæœ>Bloomè¾‰å…‰æ•ˆæœ</a></li><li><a href=#bloom%e7%9a%84%e7%ae%97%e6%b3%95 aria-label=Bloomçš„ç®—æ³•>Bloomçš„ç®—æ³•</a></li><li><a href=#bloom%e7%9a%84%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0 aria-label=Bloomçš„å…·ä½“å®ç°>Bloomçš„å…·ä½“å®ç°</a><ul><li><a href=#hqbloomcomputeshadercompute aria-label=HQBloomComputeShader.compute>HQBloomComputeShader.compute</a></li><li><a href=#hqbloomcs aria-label=HQBloom.cs>HQBloom.cs</a></li><li><a href=#hqbloomrenderpasscs aria-label=HQBloomRenderPass.cs>HQBloomRenderPass.cs</a></li><li><a href=#hqbloomrendererfeaturecs aria-label=HQBloomRendererFeature.cs>HQBloomRendererFeature.cs</a></li></ul></li></ul></div></details></div><div class=post-content><h2 id=bloomè¾‰å…‰æ•ˆæœ>Bloomè¾‰å…‰æ•ˆæœ<a hidden class=anchor aria-hidden=true href=#bloomè¾‰å…‰æ•ˆæœ>#</a></h2><p>ä¸€ç›´éƒ½æƒ³åšä¸€ä¸ªBloomæ•ˆæœï¼ŒBloomæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æ•ˆæœï¼Œå‡ ä¹æ‰€æœ‰ä»‹ç»åå¤„ç†çš„æ•™ç¨‹é‡Œéƒ½ä¼šæåˆ°Bloomæ•ˆæœçš„åˆ¶ä½œï¼Œä½†æ˜¯Bloomåˆæ˜¯ä¸€ä¸ªä¸é‚£ä¹ˆç®€å•çš„æ•ˆæœï¼Œå¤§éƒ¨åˆ†æ•™ç¨‹åˆ¶ä½œå‡ºæ¥çš„Bloomçœ‹ä¸Šå»éƒ½ä¸å¤ªå¥½çœ‹ã€‚</p><p>æƒ³è¦åšå¥½Bloomï¼Œé¦–å…ˆå¾—è®¤è¯†åˆ°ä»€ä¹ˆæ˜¯Bloomæ•ˆæœã€‚Bloomæ˜¯ç”±äºé€é•œä¸èƒ½å®Œç¾åœ°è®©å…‰çº¿èšç„¦ä¸åŒä¸€ç‚¹è€Œå¯¼è‡´å›¾åƒä¸Šçš„é«˜äº®åŒºåŸŸçš„é¢œè‰²å‘å‘¨å›´æº¢å‡ºçš„æ•ˆæœï¼Œå’Œä½“ç§¯é›¾è¿™æ ·çš„ç”±äºå¤šæ¬¡æ•£å°„å’ŒæŠ˜å°„å½¢æˆçš„æº¢å‡ºæ•ˆæœåœ¨åŸç†ä¸Šå°±ä¸ç›¸åŒã€‚åœ¨è®¡ç®—æœºå›¾å½¢å­¦é‡Œå¾€å¾€ä½¿ç”¨å¤šæ¬¡æ¨¡ç³Šçš„æ–¹å¼æ¥è¡¨ç°è¿™ç§æ•ˆæœã€‚</p><p>è€Œåœ¨è®¨è®ºä»€ä¹ˆæ˜¯å¥½çš„Bloomä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å·®çš„Bloomçš„æ•ˆæœã€‚Matthew Gallantåœ¨ä»–çš„æ–‡ç« <a href=http://gangles.ca/2008/07/18/bloom-disasters/>Bloom Disasters</a>ä¸­å°±ç»™å‡ºäº†å¾ˆå¤šå½“æ—¶çš„æç³Ÿç³•çš„Bloomæ•ˆæœçš„ä¾‹å­ã€‚å¯ä»¥çœ‹åˆ°Bloomå¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼ŒBloomä¹‹å‰çš„ç”»é¢å¿…é¡»è¦æ˜¯HDRçš„ç”»é¢ï¼Œå¦‚æœæ•´ä¸ªç”»é¢è¢«é™åˆ¶åœ¨01ä¹‹é—´ï¼Œé‚£ä¹ˆç™½è‰²çš„Tæ¤å’Œç‰¹åˆ«äº®ä»¥è‡³äºçœ‹ä¸Šå»æ˜¯ç™½è‰²çš„å¤ªé˜³å¸¦æ¥çš„Bloomæ•ˆæœå°±ä¼šç›¸åŒã€‚åœ¨LearnOpenGLä¸Šæœ‰é‚£ä¹ˆä¸€ç¯‡<a href=https://learnopengl.com/Guest-Articles/2022/Phys.-Based-Bloom>æ–‡ç« </a>ï¼Œå…¶ä¸­è¯´åˆ°ï¼Œä¸ºäº†æ¨¡æ‹Ÿæˆ‘ä»¬çœ¼ç›çš„å·¥ä½œåŸç†ï¼Œæˆ‘ä»¬ä¸å¯¹é¢œè‰²è¿›è¡Œé˜ˆå€¼é™åˆ¶ï¼Œè€Œæ˜¯ç›´æ¥å¯¹HDRç”»é¢è¿›è¡Œæ¨¡ç³Šå†å’ŒåŸHDRç”»é¢è¿›è¡Œæ’å€¼ã€‚æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ç§ååˆ†é”™è¯¯çš„æ–¹å¼ã€‚æœ€åˆç†çš„æ–¹å¼åº”å½“æ˜¯ï¼Œç”»é¢ä¸Šçš„æ¯ä¸ªé¢œè‰²ç¡®å®ä¼šå‘å‘¨å›´æº¢å‡ºè‡ªå·±çš„é¢œè‰²ï¼Œä½†æ˜¯æ›´äº®çš„é¢œè‰²çš„æº¢å‡ºåŠå¾„ä¼šæ›´å¤§ï¼Œå¯¹äºè¾ƒæš—çš„é¢œè‰²ï¼Œç”±äºæº¢å‡ºåŠå¾„å°äºåŠä¸ªåƒç´ å®½ï¼Œåœ¨æœ€åçš„ç”»é¢ä¸­å°±çœ‹ä¸åˆ°é¢œè‰²çš„æº¢å‡ºäº†ã€‚ä½†æ˜¯æ ¹æ®æ˜åº¦æ¥æ§åˆ¶æº¢å‡ºçš„åŠå¾„æ˜¯ä¸€ä»¶å¾ˆå¤æ‚çš„äº‹æƒ…ï¼ˆè¿™å’Œæ™¯æ·±çš„åŸç†æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘åˆ°ç°åœ¨éƒ½æ²¡æœ‰æŒæ¡ä¸€ä¸ªå¾ˆå¥½çš„æ™¯æ·±çš„ç®—æ³•ï¼‰ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è®¡ç®—çš„æ—¶å€™é€šè¿‡ä»…æ¨¡ç³Šè¶…å‡ºé˜ˆå€¼çš„é¢œè‰²æ¥æ¨¡æ‹Ÿè¿™ç§æ•ˆæœã€‚æ¨¡ç³ŠåŠå¾„ä¹Ÿæ˜¯ä¸€ä¸ªå†³å®šBloomè´¨é‡çš„å…³é”®è¦ç´ ï¼Œå¦‚æœæ¨¡ç³Šçš„åŠå¾„æ¯”è¾ƒå°ï¼Œçœ‹ä¸Šå»å°±åƒé«˜å…‰å¥—äº†ä¸€ä¸ªç¨å¼±çš„åœˆä¸€æ ·ï¼Œä¸å¤Ÿç¾è§‚ã€‚</p><p>Jorge Jimenezåœ¨2014å¹´Siggraphå¤šçš„Advances in Real-Time Renderingè¯¾ç¨‹ä¸Šä»‹ç»äº†ä»–ä¸ºä½¿å‘½å¬å”¤ç°ä»£æˆ˜äº‰æ‰€åšçš„<a href=http://www.iryoku.com/next-generation-post-processing-in-call-of-duty-advanced-warfare>æ¬¡ä¸–ä»£åå¤„ç†æ•ˆæœ</a>ã€‚ä»–çš„PPTé‡Œä»‹ç»äº†ä½¿å‘½å¬å”¤ç°ä»£æˆ˜äº‰ä¸­è¿åŠ¨æ¨¡ç³Šã€æ•£æ™¯ã€æ¬¡è¡¨é¢æ•£å°„ã€Bloomå’Œé˜´å½±é‡‡æ ·çš„åšæ³•ï¼Œååˆ†å€¼å¾—ä¸€çœ‹ã€‚æœ¬æ–‡åœ¨æ•´ä½“çš„ç®—æ³•ä¸Šå°±ä½¿ç”¨äº†ä»–ä»‹ç»çš„æ–¹æ³•ï¼Œè€Œé‡‡æ ·åˆ™ä½¿ç”¨äº†Dual Kawase Blurçš„ç®—æ³•ï¼Œå¯ä»¥çœ‹æˆ‘ä¹‹å‰çš„<a href=../almost-continuous-dual-kawase-blur/>æ–‡ç« </a>ã€‚</p><h2 id=bloomçš„ç®—æ³•>Bloomçš„ç®—æ³•<a hidden class=anchor aria-hidden=true href=#bloomçš„ç®—æ³•>#</a></h2><p>ä¸»æµçš„Bloomç®—æ³•éƒ½ä¼šä½¿ç”¨ä¸€ä¸ªé˜ˆå€¼ï¼Œç¬¬ä¸€ä¸ªPassæå–å‡ºå¤§äºè¿™ä¸ªé˜ˆå€¼çš„é¢œè‰²ï¼ˆä½¿ç”¨å‡æ³•ï¼Œè¿™æ ·èƒ½å¤Ÿå’Œå°äºé˜ˆå€¼çš„é¢œè‰²å½¢æˆè‡ªç„¶çš„è¿‡æ¸¡ï¼‰ï¼Œç„¶åè¿›è¡Œä¸€ç³»åˆ—çš„é™é‡‡æ ·å‡é‡‡æ ·ä»¥å‡å°‘é‡‡æ ·çš„æ¬¡æ•°ï¼Œæœ€åå°†ä¹‹å‰æ‰€æœ‰çš„å‡é‡‡æ ·çš„æ¨¡ç³Šç»“æœï¼ˆå°±ç›¸å½“äºæ˜¯Mipçš„æ¯ä¸€çº§ï¼‰å åŠ åˆ°ä¸€å¼€å§‹çš„é¢œè‰²ä¸Šã€‚ä¸ºäº†å‡å°‘æœ€åä¸€æ­¥é‡‡æ ·æ‰€æœ‰çš„Mipç­‰çº§å¸¦æ¥çš„æ¶ˆè€—ï¼Œæ ¹æ®Jorge Jimenezçš„åšæ³•ï¼Œæˆ‘ä»¬ä¼šåœ¨æ¯ä¸€æ­¥å‡é‡‡æ ·æ—¶å åŠ å½“å‰Mipçš„é¢œè‰²ã€‚ä½†æ˜¯æœ€åå åŠ ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¤„ç†æ–¹æ³•ï¼Œç”±äºå åŠ äº†å„ä¸ªMipçš„é¢œè‰²ï¼Œä¼šå¯¼è‡´åŸæ¥é«˜å…‰çš„åŒºåŸŸçš„äº®åº¦ä¼šè¢«æé«˜åˆ°åŸæ¥çš„ä¸¤å€ç”šè‡³æ›´å¤šï¼Œä¸è¿‡æˆ‘ä»¬ä¹‹åçš„Tone Mappingèƒ½å¤Ÿä¸€å®šç¨‹åº¦ä¸Šç¼“è§£è¿™ä¸ªé—®é¢˜ã€‚ç„¶åæ˜¯å¯¹å¾®å°çš„é«˜äº®ç‰©ä½“çš„å¤„ç†ï¼ŒJorge Jimenezä½¿ç”¨äº†<code>1/(1 + Luma)</code>çš„æ–¹å¼è¿›è¡ŒåŠ æƒå¤„ç†ï¼Œä¸è¿‡å¦‚æœæˆ‘ä»¬å°†Bloomç§»åŠ¨åˆ°TAAä¹‹åï¼Œè¿™ä¸ªé—®é¢˜èƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³æ‰ã€‚è‡³äºæ¨¡ç³Šï¼Œåœ¨æˆ‘ä¹‹å‰é‚£ä¹ˆå¤šæ–‡ç« çš„é“ºå«ä¸‹ï¼Œä¹Ÿå°±ä¸æ˜¯ä»€ä¹ˆéš¾ç‚¹äº†ã€‚</p><p>æˆ‘è‡ªå·±åœ¨å®ç°çš„æ—¶å€™ï¼Œä¼šåœ¨æœ€åä¸€æ­¥å åŠ Mipåˆ°æœ€ä¸€å¼€å§‹çš„å›¾åƒæ—¶ï¼Œå°†æ¨¡ç³Šåçš„é¢œè‰²é™¤ä»¥æ‰€æœ‰çš„é™é‡‡æ ·æ¬¡æ•°ï¼Œè¿™æ ·èƒ½å¤Ÿç¨å¾®å¼¥è¡¥ä¸€ä¸‹å¤šä¸ªMipå¸¦æ¥çš„äº®åº¦å‰§çƒˆå¢åŠ çš„é—®é¢˜ã€‚äº‹å®ä¸Šæˆ‘ä¹Ÿæƒ³è¿‡å°†å› ä¸ºé˜ˆå€¼è€Œä¸¢å¤±çš„äº®åº¦å‚¨å­˜åœ¨é€æ˜é€šé“é‡Œï¼Œå’Œé¢œè‰²ä¸€èµ·å‚ä¸æ¨¡ç³Šï¼Œåœ¨æœ€åçš„æ—¶å€™åŠ å›ä¹‹å‰ä¸¢å¤±çš„äº®åº¦ï¼Œæœ€åå’ŒåŸå§‹é¢œè‰²çº¿æ€§æ’å€¼ï¼Œä¸è¿‡ä¼¼ä¹ä¸é‚£ä¹ˆå¥½åšã€‚</p><p>è¿™é‡Œå¯ä»¥å¯¹æ¯”ä¸€ä¸‹Unityè‡ªå¸¦çš„Bloomå’Œæˆ‘çš„Bloomä¹‹é—´çš„æ•ˆæœå·®å¼‚ã€‚Unityç¬¬ä¸€ä¸ªPassé¢„è¿‡æ»¤ä¼šè¿›è¡Œ13æ¬¡é‡‡æ ·ï¼Œä¹‹åæ¯ä¸€æ¬¡é™é‡‡æ ·åˆ†æˆæ¨ªç«–ä¸¤ä¸ªæ–¹å‘ï¼Œæ¨ªå‘9æ¬¡é‡‡æ ·ï¼Œç«–å‘5æ¬¡é‡‡æ ·ï¼Œå‡é‡‡æ ·åˆ™æ˜¯åœ¨2æ¬¡é‡‡æ ·ä¸­çº¿æ€§æ’å€¼ã€‚æˆ‘çš„åˆ™æ˜¯æ¯æ¬¡é™é‡‡æ ·è¿›è¡Œ5æ¬¡é‡‡æ ·ï¼Œæ¯æ¬¡å‡é‡‡æ ·è¿›è¡Œ8+1æ¬¡é‡‡æ ·ï¼Œä¸éœ€è¦åˆ†æ¨ªç«–é‡‡æ ·ã€‚ä¸‹å›¾ä¸Šè¾¹æ˜¯Unityè‡ªå¸¦çš„Bloomï¼Œä¸‹è¾¹æ˜¯æˆ‘çš„Bloomï¼Œæœ€åå‡ä½¿ç”¨Aces Tonemappingï¼Œåœºæ™¯é‡Œçš„å¤§ç«‹æ–¹ä½“çš„å¤§å°æ˜¯ç›¸é‚»å°ç«‹æ–¹ä½“çš„1.5å€ï¼Œè€Œå°ç«‹æ–¹ä½“çš„äº®åº¦æ˜¯ç›¸é‚»å¤§ç«‹æ–¹ä½“çš„1.5å€ã€‚æˆ‘å°½é‡åœ°å°†å‚æ•°è°ƒçš„å·®ä¸å¤šï¼ŒUnityä¸€å…±22ä¸ªDrawæœ€é«˜Mipä¸º7ï¼Œæˆ‘çš„ä¸€å…±17ä¸ªDrawæœ€é«˜Mipä¸º8ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°Unityçš„ä¼šæœ‰ç¨å¾®æ˜æ˜¾ä¸€ç‚¹çš„Bandingï¼Œä¸­é—´äº®åº¦çš„ä¸­é—´å¤§å°çš„ç‰©ä½“å¸¦æ¥çš„Bloomæ¯”æˆ‘çš„ç¨å¾®å¤§ä¸€äº›ã€‚</p><figure class=entry-cover><img loading=lazy src=../images/UnityDefaultBloom.png alt="Unity Default Bloom"><p>Unity Default Bloom</p></figure><figure class=entry-cover><img loading=lazy src=../images/HighQualityBloom.png alt="My High Quality Bloom"><p>My High Quality Bloom</p></figure><h2 id=bloomçš„å…·ä½“å®ç°>Bloomçš„å…·ä½“å®ç°<a hidden class=anchor aria-hidden=true href=#bloomçš„å…·ä½“å®ç°>#</a></h2><h3 id=hqbloomcomputeshadercompute>HQBloomComputeShader.compute<a hidden class=anchor aria-hidden=true href=#hqbloomcomputeshadercompute>#</a></h3><p>è¿™é‡Œæœ‰å››ä¸ªKernelï¼Œ<code>HQBloomWeightedDownsample</code>ç”¨äºç¬¬ä¸€æ¬¡é™é‡‡æ ·æ—¶å‡å»é˜ˆå€¼å¹¶åŠ æƒè¿›è¡Œæ¨¡ç³Šï¼Œ<code>HQBloomDownsample</code>æ˜¯å’ŒDual Kawase Blurä¸€æ ·çš„é™é‡‡æ ·çš„æ¨¡ç³Šï¼Œ<code>HQBloomAdditiveUpsample</code>æ˜¯åœ¨Dual Kawase Blurçš„å‡é‡‡æ ·çš„åŸºç¡€ä¸Šå’Œä½ä¸€çº§çš„Mipå åŠ ï¼Œ<code>HQBloomComposite</code>åˆ™æ˜¯å°†æœ€ä½ä¸€çº§Mipå’ŒåŸå§‹é¢œè‰²è¿›è¡Œæ··åˆã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-HLSL data-lang=HLSL><span style=display:flex><span><span style=color:#75715e>#pragma kernel HQBloomDownsample</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#pragma kernel HQBloomWeightedDownsample</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#pragma kernel HQBloomAdditiveUpsample</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#pragma kernel HQBloomComposite</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include &#34;Packages/com.unity.render-pipelines.core/ShaderLibrary/Common.hlsl&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include &#34;Packages/com.unity.render-pipelines.core/ShaderLibrary/Color.hlsl&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include &#34;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Texture2D</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>float4</span><span style=color:#f92672>&gt;</span> _SourceTexture;
</span></span><span style=display:flex><span><span style=color:#66d9ef>Texture2D</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>float4</span><span style=color:#f92672>&gt;</span> _ColorTexture;
</span></span><span style=display:flex><span><span style=color:#66d9ef>RWTexture2D</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>float4</span><span style=color:#f92672>&gt;</span> _RW_TargetTexture;
</span></span><span style=display:flex><span><span style=color:#66d9ef>SamplerState</span> sampler_LinearClamp;
</span></span><span style=display:flex><span><span style=color:#66d9ef>float4</span> _SourceSize;
</span></span><span style=display:flex><span><span style=color:#66d9ef>float4</span> _TargetSize;
</span></span><span style=display:flex><span><span style=color:#66d9ef>float</span> _Threshold;
</span></span><span style=display:flex><span><span style=color:#66d9ef>float</span> _InvDownsampleCount;
</span></span><span style=display:flex><span><span style=color:#66d9ef>float</span> _BloomIntensity;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>float3</span> applyThreshold(<span style=color:#66d9ef>float3</span> color, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>float</span> luma)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	luma <span style=color:#f92672>=</span> Luminance(color);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> color <span style=color:#f92672>*</span> max(<span style=color:#ae81ff>0.0f</span>, luma <span style=color:#f92672>-</span> _Threshold);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>float</span> getLumaWeight(<span style=color:#66d9ef>float</span> luma)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> rcp(<span style=color:#ae81ff>1.0f</span> <span style=color:#f92672>+</span> luma);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>float</span> getLumaWeight(<span style=color:#66d9ef>float3</span> color)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float</span> luma <span style=color:#f92672>=</span> Luminance(color);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> rcp(<span style=color:#ae81ff>1.0f</span> <span style=color:#f92672>+</span> luma);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>float3</span> sampleSource(<span style=color:#66d9ef>float2</span> center, <span style=color:#66d9ef>float2</span> offset)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> _SourceTexture.SampleLevel(sampler_LinearClamp, center <span style=color:#f92672>+</span> offset, <span style=color:#ae81ff>0.0f</span>).rgb;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>numthreads</span>(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>1</span>)]
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> HQBloomDownsample(<span style=color:#66d9ef>uint3</span> id <span style=color:#f92672>:</span> <span style=color:#a6e22e>SV_DispatchThreadID</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float2</span> uv <span style=color:#f92672>=</span> (<span style=color:#66d9ef>float2</span>(id.xy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.5f</span>) <span style=color:#f92672>*</span> _TargetSize.zw;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float2</span> halfPixel <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5f</span> <span style=color:#f92672>*</span> _TargetSize.zw;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> c <span style=color:#f92672>=</span> sampleSource(uv, <span style=color:#66d9ef>float2</span>(<span style=color:#ae81ff>0.0f</span>, <span style=color:#ae81ff>0.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> tl <span style=color:#f92672>=</span> sampleSource(uv, halfPixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> tr <span style=color:#f92672>=</span> sampleSource(uv, halfPixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> bl <span style=color:#f92672>=</span> sampleSource(uv, halfPixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> br <span style=color:#f92672>=</span> sampleSource(uv, halfPixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> color <span style=color:#f92672>=</span> (tl <span style=color:#f92672>+</span> tr <span style=color:#f92672>+</span> bl <span style=color:#f92672>+</span> br <span style=color:#f92672>+</span> c <span style=color:#f92672>*</span> <span style=color:#ae81ff>4.0f</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>8.0f</span>;
</span></span><span style=display:flex><span>	_RW_TargetTexture[id.xy] <span style=color:#f92672>=</span> <span style=color:#66d9ef>float4</span>(color, <span style=color:#ae81ff>1.0f</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>numthreads</span>(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>1</span>)]
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> HQBloomWeightedDownsample(<span style=color:#66d9ef>uint3</span> id <span style=color:#f92672>:</span> <span style=color:#a6e22e>SV_DispatchThreadID</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float2</span> uv <span style=color:#f92672>=</span> (<span style=color:#66d9ef>float2</span>(id.xy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.5f</span>) <span style=color:#f92672>*</span> _TargetSize.zw;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float2</span> halfPixel <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.5f</span> <span style=color:#f92672>*</span> _TargetSize.zw;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float</span> lumac, lumatl, lumatr, lumabl, lumabr;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> c <span style=color:#f92672>=</span> applyThreshold(sampleSource(uv, <span style=color:#66d9ef>float2</span>(<span style=color:#ae81ff>0.0f</span>, <span style=color:#ae81ff>0.0f</span>)), lumac);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> tl <span style=color:#f92672>=</span> applyThreshold(sampleSource(uv, halfPixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>)), lumatl);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> tr <span style=color:#f92672>=</span> applyThreshold(sampleSource(uv, halfPixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>)), lumatr);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> bl <span style=color:#f92672>=</span> applyThreshold(sampleSource(uv, halfPixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>)), lumabl);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> br <span style=color:#f92672>=</span> applyThreshold(sampleSource(uv, halfPixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>)), lumabr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> wc <span style=color:#f92672>=</span> getLumaWeight(lumac);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> wtl <span style=color:#f92672>=</span> getLumaWeight(lumatl);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> wtr <span style=color:#f92672>=</span> getLumaWeight(lumatr);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> wbl <span style=color:#f92672>=</span> getLumaWeight(lumabl);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> wbr <span style=color:#f92672>=</span> getLumaWeight(lumabr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> colorSum <span style=color:#f92672>=</span> tl <span style=color:#f92672>*</span> wtl <span style=color:#f92672>+</span> tr <span style=color:#f92672>*</span> wtr <span style=color:#f92672>+</span> bl <span style=color:#f92672>*</span> wbl <span style=color:#f92672>+</span> br <span style=color:#f92672>*</span> wbr <span style=color:#f92672>+</span> c <span style=color:#f92672>*</span> wc <span style=color:#f92672>*</span> <span style=color:#ae81ff>4.0f</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> weightSum <span style=color:#f92672>=</span> wtl <span style=color:#f92672>+</span> wtr <span style=color:#f92672>+</span> wbl <span style=color:#f92672>+</span> wbr <span style=color:#f92672>+</span> wc <span style=color:#f92672>*</span> <span style=color:#ae81ff>4.0f</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> color <span style=color:#f92672>=</span> colorSum <span style=color:#f92672>/</span> weightSum;
</span></span><span style=display:flex><span>	_RW_TargetTexture[id.xy] <span style=color:#f92672>=</span> <span style=color:#66d9ef>float4</span>(color, <span style=color:#ae81ff>1.0f</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>numthreads</span>(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>1</span>)]
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> HQBloomAdditiveUpsample(<span style=color:#66d9ef>uint3</span> id <span style=color:#f92672>:</span> <span style=color:#a6e22e>SV_DispatchThreadID</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float2</span> uv <span style=color:#f92672>=</span> (<span style=color:#66d9ef>float2</span>(id.xy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.5f</span>) <span style=color:#f92672>*</span> _TargetSize.zw;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float2</span> onePixel <span style=color:#f92672>=</span> <span style=color:#ae81ff>1.0f</span> <span style=color:#f92672>*</span> _TargetSize.zw;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// float3 c = sampleSource(uv, float2(0.0f, 0.0f));</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> t2 <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>0.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>2.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> b2 <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>0.0f</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>2.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> l2 <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>2.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>0.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> r2 <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>2.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>0.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> tl <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> tr <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> bl <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> br <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> color <span style=color:#f92672>=</span> (t2 <span style=color:#f92672>+</span> b2 <span style=color:#f92672>+</span> l2 <span style=color:#f92672>+</span> r2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>2.0f</span> <span style=color:#f92672>*</span> (tl <span style=color:#f92672>+</span> tr <span style=color:#f92672>+</span> bl <span style=color:#f92672>+</span> br)) <span style=color:#f92672>/</span> <span style=color:#ae81ff>12.0f</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> prevTarget <span style=color:#f92672>=</span> _RW_TargetTexture.Load(<span style=color:#66d9ef>uint3</span>(id.xy, <span style=color:#ae81ff>0</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	_RW_TargetTexture[id.xy] <span style=color:#f92672>=</span> <span style=color:#66d9ef>float4</span>(color <span style=color:#f92672>+</span> prevTarget, <span style=color:#ae81ff>1.0f</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>numthreads</span>(<span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>1</span>)]
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> HQBloomComposite(<span style=color:#66d9ef>uint3</span> id <span style=color:#f92672>:</span> <span style=color:#a6e22e>SV_DispatchThreadID</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float2</span> uv <span style=color:#f92672>=</span> (<span style=color:#66d9ef>float2</span>(id.xy) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.5f</span>) <span style=color:#f92672>*</span> _TargetSize.zw;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float2</span> onePixel <span style=color:#f92672>=</span> <span style=color:#ae81ff>1.0f</span> <span style=color:#f92672>*</span> _TargetSize.zw;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// float3 c = sampleSource(uv, float2(0.0f, 0.0f));</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> t2 <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>0.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>2.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> b2 <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>0.0f</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>2.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> l2 <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>2.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>0.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> r2 <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>2.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>0.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> tl <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> tr <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> bl <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> br <span style=color:#f92672>=</span> sampleSource(uv, onePixel <span style=color:#f92672>*</span> <span style=color:#66d9ef>float2</span>(<span style=color:#f92672>+</span><span style=color:#ae81ff>1.0f</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1.0f</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> color <span style=color:#f92672>=</span> (t2 <span style=color:#f92672>+</span> b2 <span style=color:#f92672>+</span> l2 <span style=color:#f92672>+</span> r2 <span style=color:#f92672>+</span> <span style=color:#ae81ff>2.0f</span> <span style=color:#f92672>*</span> (tl <span style=color:#f92672>+</span> tr <span style=color:#f92672>+</span> bl <span style=color:#f92672>+</span> br)) <span style=color:#f92672>/</span> <span style=color:#ae81ff>12.0f</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> colorTexture <span style=color:#f92672>=</span> _ColorTexture.Load(<span style=color:#66d9ef>uint3</span>(id.xy, <span style=color:#ae81ff>0</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>float3</span> bloomColor <span style=color:#f92672>=</span> colorTexture <span style=color:#f92672>+</span> color <span style=color:#f92672>*</span> _BloomIntensity <span style=color:#f92672>*</span> _InvDownsampleCount;
</span></span><span style=display:flex><span>	_RW_TargetTexture[id.xy] <span style=color:#f92672>=</span> <span style=color:#66d9ef>float4</span>(bloomColor, <span style=color:#ae81ff>1.0f</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=hqbloomcs>HQBloom.cs<a hidden class=anchor aria-hidden=true href=#hqbloomcs>#</a></h3><p>æ²¡å•¥å¥½è¯´çš„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#66d9ef>using</span> System;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> UnityEngine.Rendering.Universal
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#a6e22e>    [Serializable, VolumeComponentMenuForRenderPipeline(&#34;Post-processing/HQ Bloom&#34;, typeof(UniversalRenderPipeline))]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>sealed</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HQBloom</span> : VolumeComponent, IPostProcessComponent
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> BoolParameter isEnabled = <span style=color:#66d9ef>new</span> BoolParameter(<span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> ClampedFloatParameter intensity = <span style=color:#66d9ef>new</span> ClampedFloatParameter(<span style=color:#ae81ff>1.0f</span>, <span style=color:#ae81ff>0.0f</span>, <span style=color:#ae81ff>1.0f</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> ClampedFloatParameter threshold = <span style=color:#66d9ef>new</span> ClampedFloatParameter(<span style=color:#ae81ff>0.9f</span>, <span style=color:#ae81ff>0.0f</span>, <span style=color:#ae81ff>5.0f</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> ClampedIntParameter downsampleCount = <span style=color:#66d9ef>new</span> ClampedIntParameter(<span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>10</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> IsActive()
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> isEnabled.<span style=color:#66d9ef>value</span> &amp;&amp; intensity.<span style=color:#66d9ef>value</span> &gt; <span style=color:#ae81ff>0.0f</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> IsTileCompatible()
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=hqbloomrenderpasscs>HQBloomRenderPass.cs<a hidden class=anchor aria-hidden=true href=#hqbloomrenderpasscs>#</a></h3><p>è¿™ä¸ªè„šæœ¬ç›¸è¾ƒäºDual Kawase Bluræ¥è¯´è¦ç¨å¾®ç®€å•ä¸€ç‚¹ï¼Œå› ä¸ºBloomæ•ˆæœå¾€å¾€åªä¼šè°ƒæ•´å…¶å¼ºå¼±ï¼Œè€Œä¸ä¼šè°ƒæ•´åŠå¾„ï¼Œä¸éœ€è¦åœ¨ä¸¤ä¸ªé™é‡‡æ ·ä¹‹é—´å†åšçº¿æ€§æ’å€¼äº†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#66d9ef>using</span> System.Collections.Generic;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>namespace</span> UnityEngine.Rendering.Universal
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HQBloomRenderPass</span> : ScriptableRenderPass
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>readonly</span> <span style=color:#66d9ef>string</span> passName = <span style=color:#e6db74>&#34;HQ Bloom Render Pass&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> HQBloomRendererFeature.HQBloomSettings settings;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> HQBloom hqBloom;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> ComputeShader computeShader;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>readonly</span> <span style=color:#66d9ef>string</span> cameraColorTextureName = <span style=color:#e6db74>&#34;_CameraColorAttachmentA&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>readonly</span> <span style=color:#66d9ef>int</span> cameraColorTextureID = Shader.PropertyToID(cameraColorTextureName);
</span></span><span style=display:flex><span>        RenderTargetIdentifier cameraColorIden;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> Vector2Int textureSize;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> RenderTextureDescriptor desc;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> HQBloomRenderPass(HQBloomRendererFeature.HQBloomSettings settings)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            profilingSampler = <span style=color:#66d9ef>new</span> ProfilingSampler(passName);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.settings = settings;
</span></span><span style=display:flex><span>            renderPassEvent = settings.renderPassEvent;
</span></span><span style=display:flex><span>            computeShader = settings.computeShader;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            cameraColorIden = <span style=color:#66d9ef>new</span> RenderTargetIdentifier(cameraColorTextureID);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Setup(HQBloom hqBloom)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.hqBloom = hqBloom;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> Configure(CommandBuffer cmd, RenderTextureDescriptor cameraTextureDescriptor)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            textureSize = <span style=color:#66d9ef>new</span> Vector2Int(cameraTextureDescriptor.width, cameraTextureDescriptor.height);
</span></span><span style=display:flex><span>            desc = cameraTextureDescriptor;
</span></span><span style=display:flex><span>            desc.enableRandomWrite = <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>            desc.msaaSamples = <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>            desc.depthBufferBits = <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> Vector4 GetTextureSizeParams(Vector2Int size)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Vector4(size.x, size.y, <span style=color:#ae81ff>1.0f</span> / size.x, <span style=color:#ae81ff>1.0f</span> / size.y);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> DoHQBloomDownsample(CommandBuffer cmd, RenderTargetIdentifier sourceid, RenderTargetIdentifier targetid,
</span></span><span style=display:flex><span>                                        Vector2Int sourceSize, Vector2Int targetSize,
</span></span><span style=display:flex><span>                                        <span style=color:#66d9ef>bool</span> firstDownsample, ComputeShader computeShader)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (!computeShader) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>string</span> kernelName = firstDownsample ? <span style=color:#e6db74>&#34;HQBloomWeightedDownsample&#34;</span> : <span style=color:#e6db74>&#34;HQBloomDownsample&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> kernelID = computeShader.FindKernel(kernelName);
</span></span><span style=display:flex><span>            computeShader.GetKernelThreadGroupSizes(kernelID, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> x, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> y, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> z);
</span></span><span style=display:flex><span>            cmd.SetComputeTextureParam(computeShader, kernelID, <span style=color:#e6db74>&#34;_SourceTexture&#34;</span>, sourceid);
</span></span><span style=display:flex><span>            cmd.SetComputeTextureParam(computeShader, kernelID, <span style=color:#e6db74>&#34;_RW_TargetTexture&#34;</span>, targetid);
</span></span><span style=display:flex><span>            cmd.SetComputeVectorParam(computeShader, <span style=color:#e6db74>&#34;_SourceSize&#34;</span>, GetTextureSizeParams(sourceSize));
</span></span><span style=display:flex><span>            cmd.SetComputeVectorParam(computeShader, <span style=color:#e6db74>&#34;_TargetSize&#34;</span>, GetTextureSizeParams(targetSize));
</span></span><span style=display:flex><span>            cmd.SetComputeFloatParam(computeShader, <span style=color:#e6db74>&#34;_Threshold&#34;</span>, hqBloom.threshold.<span style=color:#66d9ef>value</span>);
</span></span><span style=display:flex><span>            cmd.DispatchCompute(computeShader, kernelID,
</span></span><span style=display:flex><span>                                Mathf.CeilToInt((<span style=color:#66d9ef>float</span>)targetSize.x / x),
</span></span><span style=display:flex><span>                                Mathf.CeilToInt((<span style=color:#66d9ef>float</span>)targetSize.y / y),
</span></span><span style=display:flex><span>                                <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> DoHQBloomAdditiveUpsample(CommandBuffer cmd, RenderTargetIdentifier sourceid, RenderTargetIdentifier targetid,
</span></span><span style=display:flex><span>                                        Vector2Int sourceSize, Vector2Int targetSize,
</span></span><span style=display:flex><span>                                        ComputeShader computeShader)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (!computeShader) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>string</span> kernelName = <span style=color:#e6db74>&#34;HQBloomAdditiveUpsample&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> kernelID = computeShader.FindKernel(kernelName);
</span></span><span style=display:flex><span>            computeShader.GetKernelThreadGroupSizes(kernelID, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> x, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> y, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> z);
</span></span><span style=display:flex><span>            cmd.SetComputeTextureParam(computeShader, kernelID, <span style=color:#e6db74>&#34;_SourceTexture&#34;</span>, sourceid);
</span></span><span style=display:flex><span>            cmd.SetComputeTextureParam(computeShader, kernelID, <span style=color:#e6db74>&#34;_RW_TargetTexture&#34;</span>, targetid);
</span></span><span style=display:flex><span>            cmd.SetComputeVectorParam(computeShader, <span style=color:#e6db74>&#34;_SourceSize&#34;</span>, GetTextureSizeParams(sourceSize));
</span></span><span style=display:flex><span>            cmd.SetComputeVectorParam(computeShader, <span style=color:#e6db74>&#34;_TargetSize&#34;</span>, GetTextureSizeParams(targetSize));
</span></span><span style=display:flex><span>            cmd.DispatchCompute(computeShader, kernelID,
</span></span><span style=display:flex><span>                                Mathf.CeilToInt((<span style=color:#66d9ef>float</span>)targetSize.x / x),
</span></span><span style=display:flex><span>                                Mathf.CeilToInt((<span style=color:#66d9ef>float</span>)targetSize.y / y),
</span></span><span style=display:flex><span>                                <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> DoHQloomComposite(CommandBuffer cmd,
</span></span><span style=display:flex><span>                                        RenderTargetIdentifier sourceid, RenderTargetIdentifier colorid, RenderTargetIdentifier targetid,
</span></span><span style=display:flex><span>                                        Vector2Int sourceSize, Vector2Int targetSize,
</span></span><span style=display:flex><span>                                        ComputeShader computeShader)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (!computeShader) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>string</span> kernelName = <span style=color:#e6db74>&#34;HQBloomComposite&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> kernelID = computeShader.FindKernel(kernelName);
</span></span><span style=display:flex><span>            computeShader.GetKernelThreadGroupSizes(kernelID, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> x, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> y, <span style=color:#66d9ef>out</span> <span style=color:#66d9ef>uint</span> z);
</span></span><span style=display:flex><span>            cmd.SetComputeTextureParam(computeShader, kernelID, <span style=color:#e6db74>&#34;_SourceTexture&#34;</span>, sourceid);
</span></span><span style=display:flex><span>            cmd.SetComputeTextureParam(computeShader, kernelID, <span style=color:#e6db74>&#34;_ColorTexture&#34;</span>, colorid);
</span></span><span style=display:flex><span>            cmd.SetComputeTextureParam(computeShader, kernelID, <span style=color:#e6db74>&#34;_RW_TargetTexture&#34;</span>, targetid);
</span></span><span style=display:flex><span>            cmd.SetComputeVectorParam(computeShader, <span style=color:#e6db74>&#34;_SourceSize&#34;</span>, GetTextureSizeParams(sourceSize));
</span></span><span style=display:flex><span>            cmd.SetComputeVectorParam(computeShader, <span style=color:#e6db74>&#34;_TargetSize&#34;</span>, GetTextureSizeParams(targetSize));
</span></span><span style=display:flex><span>            cmd.SetComputeFloatParam(computeShader, <span style=color:#e6db74>&#34;_InvDownsampleCount&#34;</span>, <span style=color:#ae81ff>1.0f</span> / hqBloom.downsampleCount.<span style=color:#66d9ef>value</span>);
</span></span><span style=display:flex><span>            cmd.SetComputeFloatParam(computeShader, <span style=color:#e6db74>&#34;_BloomIntensity&#34;</span>, hqBloom.intensity.<span style=color:#66d9ef>value</span>);
</span></span><span style=display:flex><span>            cmd.DispatchCompute(computeShader, kernelID,
</span></span><span style=display:flex><span>                                Mathf.CeilToInt((<span style=color:#66d9ef>float</span>)targetSize.x / x),
</span></span><span style=display:flex><span>                                Mathf.CeilToInt((<span style=color:#66d9ef>float</span>)targetSize.y / y),
</span></span><span style=display:flex><span>                                <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> Execute(ScriptableRenderContext context, <span style=color:#66d9ef>ref</span> RenderingData renderingData)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            CommandBuffer cmd = CommandBufferPool.Get();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>using</span> (<span style=color:#66d9ef>new</span> ProfilingScope(cmd, profilingSampler))
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                List&lt;<span style=color:#66d9ef>int</span>&gt; rtIDs = <span style=color:#66d9ef>new</span> List&lt;<span style=color:#66d9ef>int</span>&gt;();
</span></span><span style=display:flex><span>                List&lt;Vector2Int&gt; rtSizes = <span style=color:#66d9ef>new</span> List&lt;Vector2Int&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                RenderTextureDescriptor tempDesc = desc;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>string</span> bloomRT = <span style=color:#e6db74>&#34;_BloomRT&#34;</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> bloomRTID = Shader.PropertyToID(bloomRT);
</span></span><span style=display:flex><span>                cmd.GetTemporaryRT(bloomRTID, tempDesc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                rtIDs.Add(bloomRTID);
</span></span><span style=display:flex><span>                rtSizes.Add(textureSize);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                Vector2Int lastSize = textureSize;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> lastID = cameraColorTextureID;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> downsampleCount = hqBloom.downsampleCount.<span style=color:#66d9ef>value</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = <span style=color:#ae81ff>0</span>; i &lt; downsampleCount; i++)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>string</span> rtName = <span style=color:#e6db74>&#34;_BloomRT&#34;</span> + i.ToString();
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> rtID = Shader.PropertyToID(rtName);
</span></span><span style=display:flex><span>                    Vector2Int rtSize = <span style=color:#66d9ef>new</span> Vector2Int((lastSize.x + <span style=color:#ae81ff>1</span>) / <span style=color:#ae81ff>2</span>, (lastSize.y + <span style=color:#ae81ff>1</span>) / <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>                    tempDesc.width = rtSize.x;
</span></span><span style=display:flex><span>                    tempDesc.height = rtSize.y;
</span></span><span style=display:flex><span>                    cmd.GetTemporaryRT(rtID, tempDesc);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    rtIDs.Add(rtID);
</span></span><span style=display:flex><span>                    rtSizes.Add(rtSize);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    DoHQBloomDownsample(cmd, lastID, rtID, lastSize, rtSize, i == <span style=color:#ae81ff>0</span>, computeShader);
</span></span><span style=display:flex><span>                    lastID = rtID;
</span></span><span style=display:flex><span>                    lastSize = rtSize;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i = downsampleCount; i &gt;= <span style=color:#ae81ff>1</span>; i--)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> sourceID = rtIDs[i];
</span></span><span style=display:flex><span>                    Vector2Int sourceSize = rtSizes[i];
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> targetID = rtIDs[i-<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>                    Vector2Int targetSize = rtSizes[i-<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span>(i == <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        DoHQloomComposite(cmd, sourceID, cameraColorIden, targetID, sourceSize, targetSize, computeShader);
</span></span><span style=display:flex><span>                        cmd.Blit(targetID, cameraColorIden);
</span></span><span style=display:flex><span>                        cmd.ReleaseTemporaryRT(targetID);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                        DoHQBloomAdditiveUpsample(cmd, sourceID, targetID, sourceSize, targetSize, computeShader);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    cmd.ReleaseTemporaryRT(sourceID);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            context.ExecuteCommandBuffer(cmd);
</span></span><span style=display:flex><span>            cmd.Clear();
</span></span><span style=display:flex><span>            CommandBufferPool.Release(cmd);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=hqbloomrendererfeaturecs>HQBloomRendererFeature.cs<a hidden class=anchor aria-hidden=true href=#hqbloomrendererfeaturecs>#</a></h3><p>æ²¡å•¥å¥½è¯´çš„ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C# data-lang=C#><span style=display:flex><span><span style=color:#66d9ef>namespace</span> UnityEngine.Rendering.Universal
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HQBloomRendererFeature</span> : ScriptableRendererFeature
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span><span style=color:#a6e22e>        [System.Serializable]</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>HQBloomSettings</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> RenderPassEvent renderPassEvent = RenderPassEvent.BeforeRenderingPostProcessing;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> ComputeShader computeShader;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> HQBloomSettings settings = <span style=color:#66d9ef>new</span> HQBloomSettings();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> HQBloomRenderPass hqBloomRenderPass;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> Create()
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            hqBloomRenderPass = <span style=color:#66d9ef>new</span> HQBloomRenderPass(settings);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>void</span> AddRenderPasses(ScriptableRenderer renderer, <span style=color:#66d9ef>ref</span> RenderingData renderingData)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            HQBloom HQBloom = VolumeManager.instance.stack.GetComponent&lt;HQBloom&gt;();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (HQBloom != <span style=color:#66d9ef>null</span> &amp;&amp; HQBloom.IsActive())
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                hqBloomRenderPass.Setup(HQBloom);
</span></span><span style=display:flex><span>                renderer.EnqueuePass(hqBloomRenderPass);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://zznewclear13.github.io/tags/bloom/>Bloom</a></li><li><a href=https://zznewclear13.github.io/tags/post-process/>Post-Process</a></li></ul><nav class=paginav><a class=prev href=https://zznewclear13.github.io/posts/screen-space-reflection/><span class=title>Â« Prev</span><br><span>å±å¹•ç©ºé—´åå°„</span>
</a><a class=next href=https://zznewclear13.github.io/posts/relaxed-cone-step-mapping-in-unity/><span class=title>Next Â»</span><br><span>åœ¨Unityé‡Œå®ç°æ¾æ•£åœ†é”¥æ­¥è¿›Relaxed Cone Step Mapping</span></a></nav></footer><div id=comments></div><script>let currentHugoTheme=window.localStorage.getItem("pref-theme");function loadComment(){const t=document.getElementById("comments");let n=currentHugoTheme=="dark"?"photon-dark":"github-light",e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","zznewclear13/zznewclear13.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("label","utterances"),e.setAttribute("theme",n),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),t.innerHTML="",t.appendChild(e)}loadComment(),document.getElementById("theme-toggle").onclick=async()=>{await new Promise(e=>setTimeout(e,200));let e=window.localStorage.getItem("pref-theme");e!=currentHugoTheme&&(currentHugoTheme=e,loadComment())}</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://zznewclear13.github.io/>ZZNEWCLEAR13</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>