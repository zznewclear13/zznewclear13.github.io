<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>å±å¹•ç©ºé—´åå°„ | ZZNEWCLEAR13</title><meta name=keywords content="Screen Space Reflection,Screen Space"><meta name=description content="ç›®æ ‡æ˜¯åœ¨ä¸€ä¸ªShaderä¸­ä½¿ç”¨å°½é‡å°‘çš„æ­¥è¿›æ¬¡æ•°å¾—åˆ°æ­£ç¡®çš„åå°„é¢œè‰²."><meta name=author content="zznewclear13"><link rel=canonical href=https://zznewclear13.github.io/posts/screen-space-reflection/><link crossorigin=anonymous href=/assets/css/stylesheet.a6fe470bfe70eb4fad7ee3efc590e817f121cf0f6d66fa91de327cf6bfbad62d.css integrity="sha256-pv5HC/5w60+tfuPvxZDoF/Ehzw9tZvqR3jJ89r+61i0=" rel="preload stylesheet" as=style><link rel=icon href=https://zznewclear13.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://zznewclear13.github.io/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://zznewclear13.github.io/favicon.ico><link rel=apple-touch-icon href=https://zznewclear13.github.io/favicon.ico><link rel=mask-icon href=https://zznewclear13.github.io/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-157509723-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="å±å¹•ç©ºé—´åå°„"><meta property="og:description" content="ç›®æ ‡æ˜¯åœ¨ä¸€ä¸ªShaderä¸­ä½¿ç”¨å°½é‡å°‘çš„æ­¥è¿›æ¬¡æ•°å¾—åˆ°æ­£ç¡®çš„åå°„é¢œè‰²."><meta property="og:type" content="article"><meta property="og:url" content="https://zznewclear13.github.io/posts/screen-space-reflection/"><meta property="og:image" content="https://zznewclear13.github.io/posts/screen-space-reflection/posts/images/ScreenSpaceReflection_64.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-03-09T17:00:00+08:00"><meta property="article:modified_time" content="2024-03-09T17:00:00+08:00"><meta property="og:site_name" content="ZZNEWCLEAR13"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://zznewclear13.github.io/posts/screen-space-reflection/posts/images/ScreenSpaceReflection_64.png"><meta name=twitter:title content="å±å¹•ç©ºé—´åå°„"><meta name=twitter:description content="ç›®æ ‡æ˜¯åœ¨ä¸€ä¸ªShaderä¸­ä½¿ç”¨å°½é‡å°‘çš„æ­¥è¿›æ¬¡æ•°å¾—åˆ°æ­£ç¡®çš„åå°„é¢œè‰²."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://zznewclear13.github.io/posts/"},{"@type":"ListItem","position":2,"name":"å±å¹•ç©ºé—´åå°„","item":"https://zznewclear13.github.io/posts/screen-space-reflection/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"å±å¹•ç©ºé—´åå°„","name":"å±å¹•ç©ºé—´åå°„","description":"ç›®æ ‡æ˜¯åœ¨ä¸€ä¸ªShaderä¸­ä½¿ç”¨å°½é‡å°‘çš„æ­¥è¿›æ¬¡æ•°å¾—åˆ°æ­£ç¡®çš„åå°„é¢œè‰².","keywords":["Screen Space Reflection","Screen Space"],"articleBody":"å±å¹•ç©ºé—´åå°„ å±å¹•ç©ºé—´åå°„ä¹Ÿæ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„æ•ˆæœäº†ï¼Œä½†æ­£å¦‚æœ¬åšå®¢çš„å®—æ—¨ï¼Œè¦ä»åƒç¯‡ä¸€å¾‹ä¸­è„±é¢–è€Œå‡ºï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿå°†ä»‹ç»ä¸ä¼—ä¸åŒçš„ï¼Œè‡³å°‘æˆ‘åœ¨ç½‘ä¸Šæ²¡æœ‰è§åˆ°è¿‡çš„è®¡ç®—å±å¹•ç©ºé—´åå°„çš„æ–¹æ³•ã€‚\nç½‘ä¸Šæœ‰å¾ˆå¤šå¾ˆå¤šçš„å±å¹•ç©ºé—´åå°„çš„æ•™ç¨‹ï¼Œç»å¤§éƒ¨åˆ†çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼šè®¡ç®—ä¸–ç•Œç©ºé—´çš„åå°„æ–¹å‘ï¼Œä½¿ç”¨ä¸€ä¸ªå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ç»Ÿä¸€çš„æ­¥é•¿åœ¨ä¸–ç•Œç©ºé—´ä¸­æ­¥è¿›ï¼Œå¯¹äºæ¯ä¸€æ¬¡æ­¥è¿›ï¼Œè®¡ç®—æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´çš„åæ ‡ï¼Œå°†å½“å‰çš„æ·±åº¦å’Œæ·±åº¦å›¾è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœåœ¨æ·±åº¦å›¾ä¹‹åï¼Œè®¤ä¸ºå‘ç”Ÿäº†äº¤å‰ï¼Œé‡‡æ ·å½“å‰ç‚¹çš„é¢œè‰²å€¼å¹¶è¿”å›ã€‚è¿™ç§æ–¹æ³•èƒ½çœ‹åˆ°å¾ˆå¤šå¾ˆå¤šçœ‹ä¸Šå»éå¸¸å®Œç¾çš„åå°„æ•ˆæœï¼Œä½†å‡ ä¹æ²¡æœ‰äººä¼šæåŠæ‰€éœ€è¦çš„æ­¥è¿›æ¬¡æ•°ï¼Œå› ä¸ºå®ƒå¾€å¾€é«˜å¾—æƒŠäººï¼Œå…³äºè¿™ç‚¹æˆ‘ä»¬åç»­è¿˜ä¼šè°ˆåˆ°ã€‚è€Œä¸”å¯¹äºä¸åŒè¿œè¿‘çš„ç‰©ä½“ï¼Œæƒ³è¦è¾¾åˆ°æ¯”è¾ƒå¥½åå°„æ•ˆæœï¼Œå…¶éœ€è¦çš„æ­¥é•¿å¾€å¾€æ˜¯ä¸åŒçš„ï¼Œä¹Ÿå¾ˆå°‘æœ‰äººå»åšè¿™æ–¹é¢çš„æ€è€ƒã€‚ç¨å¥½ä¸€äº›çš„ä¼šè€ƒè™‘åœ¨äº¤å‰ä¹‹ååšå‡ æ¬¡äºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œè¿™æ ·èƒ½å¤Ÿè®©ä¸€æ®µä¸€æ®µçš„åå°„åçš„é¢œè‰²å¸¦ä¸Šä¸‹é¢ å€’ï¼Œä½¿ç”»é¢çœ‹ä¸Šå»æ›´åŠ è¿è´¯ï¼Œåé¢ä¹Ÿèƒ½çœ‹åˆ°å¯¹æ¯”ã€‚è¿˜æœ‰ä¸€äº›ä¼šè€ƒè™‘åœ¨è®¡ç®—æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´çš„åæ ‡åï¼Œæ ¹æ®åæ ‡å’Œ[-1, 1]ä¹‹é—´çš„å¤§å°å…³ç³»ï¼Œæå‰ç»“æŸæ­¥è¿›æˆ–æ˜¯å¯¹åå°„çš„é¢œè‰²å’Œç¯å¢ƒåå°„è¿›è¡Œæ’å€¼ã€‚ç›®å‰çœ‹æ¥æœ€å¥½çš„æ­¥è¿›æ–¹æ³•ï¼Œæ˜¯é¢„å…ˆè®¡ç®—Hierarchical ZBufferï¼Œé€šè¿‡å¯¹æ›´é«˜LODæ­¥è¿›çš„æ–¹æ³•ï¼Œä½¿ç”¨æ›´å°‘çš„æ­¥è¿›æ¬¡æ•°è¾¾åˆ°åŒæ ·çš„æ­¥è¿›æ•ˆæœï¼Œä½†æ˜¯Hierarchical ZBufferå¹¶ä¸æ˜¯ä¸€ä¸ªæ‰€æœ‰é¡¹ç›®éƒ½èƒ½æœ‰çš„ç‰¹æ€§ã€‚\nç½‘ä¸Šèƒ½æ‰¾åˆ°çš„æœ€æœ‰ç”¨çš„æ•™ç¨‹ï¼Œæ˜¯Morgan McGuireå†™çš„Screen Space Ray Tracingã€‚åœ¨ä»–çš„è¿™ç¯‡æ–‡ç« ä¸­ä¹Ÿæåˆ°äº†ä¸ºä»€ä¹ˆåœ¨ä¸–ç•Œç©ºé—´ä¸­æ­¥è¿›æ˜¯ä¸å¥½çš„ï¼Œå› ä¸ºä¸–ç•Œç©ºé—´æ­¥è¿›çš„ä½ç½®åœ¨ç»è¿‡é€è§†å˜æ¢åï¼Œå¾ˆæœ‰å¯èƒ½åœ¨å±å¹•ç©ºé—´ä¸­æ²¡å¤šå¤§å˜åŒ–ï¼Œä¹Ÿå°±å¯¼è‡´äº†ä¸–ç•Œç©ºé—´æ­¥è¿›éœ€è¦æ›´å¤šçš„æ¬¡æ•°æ¥è¾¾åˆ°è¾ƒå¥½çš„åå°„æ•ˆæœã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­å±•ç¤ºäº†ä¸€ä¸ªéå¸¸å¥½çš„æ–¹æ³•ï¼Œè®¡ç®—è£å‰ªç©ºé—´å’Œå±å¹•ç©ºé—´çš„èµ·ç‚¹å’Œç»ˆç‚¹çš„åæ ‡ï¼Œé€šè¿‡å¯¹è£å‰ªç©ºé—´çš„zã€è£å‰ªç©ºé—´çš„1/wã€å±å¹•ç©ºé—´çš„xyè¿›è¡Œçº¿æ€§æ’å€¼ï¼Œçœå»äº†æ¯ä¸€æ¬¡æ­¥è¿›æ‰€éœ€è¦çš„çŸ©é˜µè¿ç®—ï¼Œååˆ†å€¼å¾—ä½¿ç”¨ã€‚\næœ¬æ–‡çš„ç›®æ ‡æ˜¯ï¼Œåœ¨ä¸€ä¸ªShaderä¸­ä½¿ç”¨å°½é‡å°‘çš„æ­¥è¿›æ¬¡æ•°å¾—åˆ°æ­£ç¡®çš„åå°„é¢œè‰²ã€‚éšæœºé‡‡æ ·ã€æ¨¡ç³Šã€è²æ¶…å°”æ•ˆåº”ä¹‹ç±»çš„ä¸åœ¨æœ¬æ–‡çš„è€ƒè™‘èŒƒå›´ä¹‹å†…ã€‚æœ¬æ–‡ä»…è€ƒè™‘Windowså¹³å°ä¸‹DX11çš„Shaderï¼Œè¿™æ ·èƒ½çœå»å¾ˆå¤šçš„å¹³å°é€‚é…çš„ä»£ç ï¼Œä½¿ç”¨çš„Unityç‰ˆæœ¬æ˜¯Unity 2022.3.21f1ï¼Œåœ¨æ–‡ç« çš„æœ€åä¼šé™„ä¸Šæœ€ç»ˆçš„Shaderä»£ç ã€‚\nåå°„çš„è®¡ç®— å‚æ•°çš„é€‰æ‹© è®¡ç®—åå°„åŸºæœ¬ä¸Šåªéœ€è¦ä¸‰ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯Max Distanceï¼Œåªè€ƒè™‘è·ç¦»åå°„ç‚¹ä¸€å®šèŒƒå›´å†…çš„ç‰©ä½“å¸¦æ¥çš„åå°„ï¼Œä¸€ä¸ªæ˜¯Step Countï¼Œæ›´å¤šçš„æ­¥è¿›æ¬¡æ•°å¸¦æ¥æ›´ç²¾ç¡®çš„åå°„ï¼ŒåŒæ—¶ä¹Ÿå¢åŠ æ€§èƒ½æ¶ˆè€—ï¼Œæœ€åä¸€ä¸ªæ˜¯Thickness Paramsï¼Œå¯¹äºä¸€ä¸ªç‰©ä½“ï¼Œé»˜è®¤å…¶åšåº¦ä¸ºdepth * _Thickness.y + _Thickness.xï¼Œè¿™æ ·å½“å°„çº¿ç»è¿‡ç‰©ä½“èƒŒé¢æ—¶ä¸ä¼šè¢«è®¤ä¸ºå‘ç”Ÿäº†äº¤å‰ã€‚\næ·±åº¦æ¯”è¾ƒ æ­¥è¿›çš„æ—¶å€™æ¯”è¾ƒä»€ä¹ˆæ·±åº¦ä¹Ÿæ˜¯ä¸€ä¸ªå€¼å¾—æ€è€ƒçš„é—®é¢˜ã€‚å°†æ­¥è¿›çš„æ·±åº¦è®°ä¸ºrayDepthï¼Œå°†é‡‡æ ·è·å¾—çš„æ·±åº¦è®°ä¸ºsampleDepthï¼Œä¸€ä¸ªå¾ˆç®€å•çš„æƒ³æ³•åœ¨æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´è¿›è¡Œæ¯”è¾ƒï¼Œå› ä¸ºç›´æ¥é‡‡æ ·æ·±åº¦å›¾å°±èƒ½è·å–åˆ°æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´çš„æ·±åº¦å€¼ï¼Œå½“rayDepth çš„æ—¶å€™ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ã€‚åˆæˆ–æ˜¯å¯¹å®é™…çš„æ·±åº¦è¿›è¡Œæ¯”è¾ƒï¼Œè¿™æ ·èƒ½å¤ŸæŒ‡å®šä¸€ä¸ªåšåº¦ï¼Œå½“æ·±åº¦çš„å·®å¤§äºåšåº¦æ—¶ï¼Œè®¤ä¸ºå°„çº¿ä»åœºæ™¯ç‰©ä½“çš„åé¢ç©¿äº†è¿‡å»å¹¶æ²¡æœ‰å‘ç”Ÿäº¤å‰ï¼Œå½“rayDepth  sampleDepth \u0026\u0026 rayDepth çš„æ—¶å€™ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ã€‚æ­¤å¤–è£å‰ªç©ºé—´çš„Zåˆ†é‡ä¹Ÿèƒ½ç”¨æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†äº¤å‰ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚æ·±åº¦å›¾çš„é‡‡æ ·æ–¹å¼åˆ™åº”è¯¥ä½¿ç”¨PointClampçš„æ–¹å¼ï¼Œä½¿ç”¨çº¿æ€§æ’å€¼çš„è¯åœ¨ä¸€å‰ä¸€åçš„ä¸¤ä¸ªé¢çš„è¾¹ç¼˜å¾ˆå¯èƒ½ä¼šè¢«è®¤ä¸ºå‘ç”Ÿäº†äº¤å‰ï¼Œå¯¼è‡´ç”»é¢ä¸Šæœ‰ä¸å°‘çš„å°ç‚¹ï¼Œé™¤éå¦å¤–æœ‰ä¸€å¼ æ ‡è®°ç‰©ä½“è¾¹ç¼˜çš„è´´å›¾å¯ä»¥ç”¨æ¥æ’é™¤æ‰è¿™éƒ¨åˆ†çš„äº¤å‰ç‚¹ã€‚\nå…‰çº¿æ­¥è¿› ä¼ªä»£ç å¾ˆç®€å•ï¼š\n  è®°k0ã€k1åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„wåˆ†é‡çš„å€’æ•°ã€‚ è®°q0ã€q1åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„xyzåˆ†é‡ã€‚ è®°p0ã€p1åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´åæ ‡çš„xyåˆ†é‡ã€‚ è®°wæ˜¯ä¸€ä¸ªåœ¨(0, 1)ä¹‹é—´æŒ‰ç…§1.0f/_StepCounté€’å¢çš„å˜é‡ã€‚ å¯¹æ¯ä¸€æ¬¡æ­¥è¿›ï¼Œæ›´æ–°wçš„å€¼ï¼Œå¹¶å¯¹ä¸Šé¢çš„ä¸‰ç»„åˆ†é‡çº¿æ€§æ’å€¼å¾—åˆ°kã€qã€pã€‚ ä½¿ç”¨q.z * kè·å¾—rayDepthï¼Œä½¿ç”¨pé‡‡æ ·æ·±åº¦å›¾è·å¾—sampleDepthã€‚ å¦‚æœrayDepth ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ï¼Œè·³å‡ºå¾ªç¯ï¼Œè¿”å›pã€‚ ä½¿ç”¨pé‡‡æ ·é¢œè‰²å›¾ï¼Œè·å¾—åå°„çš„é¢œè‰²ã€‚   æ•ˆæœæ˜¯è¿™æ ·çš„ï¼ˆæ­¥è¿›æ¬¡æ•°ä¸º32æ¬¡ï¼‰: çœ‹ä¸Šå»éå¸¸ç³Ÿç³•ï¼Œæœ€æ˜æ˜¾çš„æ˜¯æ‹‰æ‰¯çš„æ•ˆæœã€‚å®ƒä¸»è¦æœ‰ä¸¤ä¸ªäº§ç”Ÿçš„åŸå› ï¼šä¸€æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨åšåº¦æ¥åˆ¤æ–­å°„çº¿æ˜¯å¦ä»ç‰©ä½“çš„èƒŒé¢ç©¿è¿‡ï¼Œè¿™å¯¼è‡´äº†æ‚¬ç©ºçš„ç‰©ä½“ä¸‹æ–¹ä¼šæœ‰å¾ˆé•¿çš„æ‹‰æ‰¯ï¼›äºŒæ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹è¶…å‡ºå±å¹•èŒƒå›´çš„ä½ç½®è¿›è¡Œé™åˆ¶ï¼Œè¿™å¯¼è‡´äº†æˆ‘ä»¬ä½¿ç”¨å±å¹•å¤–çš„åæ ‡é‡‡æ ·æ·±åº¦å›¾ä½†è¿”å›äº†Clampä¹‹åçš„æ·±åº¦å€¼ã€‚\nåšåº¦æ£€æµ‹ ä¸ºäº†è§£å†³ä¸Šé¢çš„åšåº¦é—®é¢˜ï¼Œæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªæ–¹æ³•ç”±äºåˆ¤æ–­æ­¥è¿›çš„ä½ç½®æ˜¯å¦åœ¨ç‰©ä½“åé¢ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„æ˜¯è·ç¦»ç›¸æœºçš„çº¿æ€§æ·±åº¦linearRayDepthå’ŒlinearSampleDepthã€‚ä¸Šæ–‡è¯´åˆ°æˆ‘ä»¬ä½¿ç”¨linearSampleDepth * _Thickness.y + _Thickness.xæ¥ä½œä¸ºä¸€ä¸ªåœºæ™¯ä¸­ä¸€ä¸ªç‰©ä½“çš„åšåº¦ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ¤æ–­(linearRayDepth-linearSampleDepth-_Thickness.x) / linearSampleDepthå’Œ_Thickness.yçš„å¤§å°å³å¯ï¼Œå¦‚æœå‰å¼å¤§äºåå¼ï¼Œåˆ™è¡¨æ˜å°„çº¿ä»ç‰©ä½“åé¢ç©¿è¿‡ã€‚\nfloat getThicknessDiff(float diff, float linearSampleDepth, float2 thicknessParams)\r{\rreturn (diff - thicknessParams.x) / linearSampleDepth;\r}\rä¼ªä»£ç å˜æˆäº†ï¼š\n å¦‚æœrayZ ä¸”thicknessDiff ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ï¼Œè·³å‡ºå¾ªç¯ï¼Œè¿”å›pã€‚   æ•ˆæœæ˜¯è¿™æ ·çš„ï¼ˆæ­¥è¿›æ¬¡æ•°ä¸º32æ¬¡ï¼‰: è§†é”¥ä½“è£å‰ª å¯¹äºè¶…å‡ºå±å¹•ç©ºé—´çš„p1ï¼Œä¼šå¸¦æ¥ä¸¤ä¸ªåå¤„ï¼Œä¸€æ˜¯é‡‡æ ·äº†è¶…å‡ºèŒƒå›´çš„æ·±åº¦å›¾å¾—åˆ°äº†é”™è¯¯çš„æ·±åº¦å€¼ï¼ŒäºŒæ˜¯å‡å°‘äº†æœ‰æ•ˆé‡‡æ ·çš„æ¬¡æ•°ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†p1é™åˆ¶åœ¨å±å¹•ç©ºé—´å†…ï¼Œè¿™é‡Œæ–°å¢äº†ä¸€ä¸ªæ–¹æ³•ç”¨äºå°†æ­¥è¿›ç»ˆç‚¹é™åˆ¶åœ¨è§†é”¥ä½“å†…éƒ¨ã€‚æˆ‘ä»¬è®°nfä¸ºè¿‘è£å‰ªé¢æ·±åº¦å’Œè¿œè£å‰ªé¢æ·±åº¦å€¼ï¼ˆæ­£æ•°ï¼‰ï¼Œsä¸ºè§†é”¥ä½“çš„å·¦å³å’Œä¸Šä¸‹çš„æ–œç‡ï¼ˆæ­£æ•°ï¼‰ï¼Œsåœ¨æ•°å€¼ä¸Šä¸ºfloat2(asepect * tan(fovy * 0.5f), tan(fovy * 0.5f)ï¼Œæ³¨æ„ä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼Œè¿™é‡Œfromå’Œtoçš„zåˆ†é‡ä¸ºæ­£æ•°ã€‚ä¸‹é¢çš„ç®—æ³•åº”è¯¥è¿˜èƒ½ä¼˜åŒ–ä¸€äº›ï¼Œä¸è¿‡å·²ç»å¤Ÿç”¨äº†ã€‚\näº‹å®ä¸Šæˆ‘è¿˜å†™äº†ä¸€ä¸ªShadertoyç”¨æ¥æ¼”ç¤ºï¼Œä½¿ç”¨é¼ æ ‡è¿›è¡Œäº¤äº’ï¼š\n\rFrustum Clip 2D\n\r#define INFINITY 1e10\rfloat3 frustumClip(float3 from, float3 to, float2 nf, float2 s)\r{\rfloat3 dir = to - from;\rfloat3 signDir = sign(dir);\rfloat nfSlab = signDir.z * (nf.y - nf.x) * 0.5f + (nf.y + nf.x) * 0.5f;\rfloat lenZ = (nfSlab - from.z) / dir.z;\rif (dir.z == 0.0f) lenZ = INFINITY;\rfloat2 ss = sign(dir.xy - s * dir.z) * s;\rfloat2 denom = ss * dir.z - dir.xy;\rfloat2 lenXY = (from.xy - ss * from.z) / denom;\rif (lenXY.x ä¼ªä»£ç å˜æˆäº†ï¼š\n å°†æ­¥è¿›ç»ˆç‚¹è¿›è¡Œè§†é”¥ä½“è£å‰ªå¾—åˆ°clippedPosVSï¼Œå†è¿›ä¸€æ­¥å¾—åˆ°ç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡endCSã€‚   æ•ˆæœæ˜¯è¿™æ ·çš„ï¼ˆæ­¥è¿›æ¬¡æ•°ä¸º32æ¬¡ï¼‰: çœ‹ä¸Šå»æœ‰é‚£ä¹ˆç‚¹åå°„çš„æ„æ€äº†ï¼Œè§†é”¥ä½“å‰”é™¤ä¸€å®šç¨‹åº¦åœ°å‡å°‘äº†æ¯æ¬¡æ­¥è¿›çš„åƒç´ æ•°ï¼Œå› æ­¤è¡¥ä¸Šäº†ä¸€éƒ¨åˆ†çš„çªŸçª¿ã€‚ä½†æ˜¯åå°„çš„é¢œè‰²æ‰­æ‰­æ›²æ›²çš„ã€‚\näºŒåˆ†æ³•æŸ¥æ‰¾ æˆ‘ä»¬ä¸Šä¸€æ­¥è·å¾—çš„pè™½ç„¶ç¡®ä¿äº†åœ¨ç‰©ä½“å†…éƒ¨ï¼Œä½†è·ç¦»å®é™…çš„äº¤ç‚¹ä»æœ‰ä¸€éƒ¨åˆ†çš„è·ç¦»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒåˆ†æ³•æŸ¥æ‰¾å‡å°‘ä¸¤è€…ä¹‹é—´çš„è¯¯å·®ã€‚ä¸ºäº†è¿›è¡ŒäºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•æœ€åä¸¤æ¬¡æ­¥è¿›çš„wå€¼ï¼Œè®°ä¸ºw1å’Œw2ï¼ˆw1  w2ï¼‰ã€‚æ¯æ¬¡äºŒåˆ†æ³•æ—¶ï¼Œå–w = 0.5f * (w1 + w2)ï¼Œå¦‚æœæ£€æµ‹åˆ°ç›¸äº¤ï¼Œåˆ™w1 = wï¼Œå¦åˆ™w2 = wï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯ã€‚\nä¼ªä»£ç å˜æˆäº†ï¼š\n å°†æ­¥è¿›ç»ˆç‚¹è¿›è¡Œè§†é”¥ä½“è£å‰ªå¾—åˆ°clippedPosVSï¼Œå†è¿›ä¸€æ­¥å¾—åˆ°ç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡endCSã€‚ è®°k0ã€k1åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„wåˆ†é‡çš„å€’æ•°ã€‚ è®°q0ã€q1åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„xyzåˆ†é‡ã€‚ è®°p0ã€p1åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´åæ ‡çš„xyåˆ†é‡ã€‚ è®°w1æ˜¯ä¸€ä¸ªåœ¨(0, 1)ä¹‹é—´æŒ‰ç…§1.0f/_StepCounté€’å¢çš„å˜é‡ï¼Œw1å’Œw2åˆå§‹åŒ–ä¸º0ã€‚ å¯¹æ¯ä¸€æ¬¡æ­¥è¿›ï¼Œw2=w1ï¼Œæ›´æ–°w1çš„å€¼ï¼Œå¹¶å¯¹ä¸Šé¢çš„ä¸‰ç»„åˆ†é‡çº¿æ€§æ’å€¼å¾—åˆ°kã€qã€pã€‚ ä½¿ç”¨q.z * kè·å¾—rayDepthï¼Œä½¿ç”¨pé‡‡æ ·æ·±åº¦å›¾è·å¾—sampleDepthã€‚ å¦‚æœrayZ ä¸”thicknessDiff ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ï¼Œè·³å‡ºå¾ªç¯ã€‚ è®°wä¸ºw1å’Œw2çš„å¹³å‡æ•°ï¼ŒæŒ‰ç…§567åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº¤å‰ï¼Œæ ¹æ®æ˜¯å¦äº¤å‰æ›´æ–°w1æˆ–w2ï¼Œç›´åˆ°ç»“æŸäºŒåˆ†æ³•å¾ªç¯ã€‚ ä½¿ç”¨pé‡‡æ ·é¢œè‰²å›¾ï¼Œè·å¾—åå°„çš„é¢œè‰²ã€‚   æ•ˆæœæ˜¯è¿™æ ·çš„ï¼ˆæ­¥è¿›æ¬¡æ•°ä¸º32æ¬¡ï¼ŒäºŒåˆ†æ³•æŸ¥æ‰¾æ¬¡æ•°ä¸º5æ¬¡ï¼‰: å¯ä»¥çœ‹åˆ°åå°„çš„æ•ˆæœçœ‹ä¸Šå»ä¸é‚£ä¹ˆæ‰­æ‰­æ›²æ›²çš„äº†ï¼ˆå·¦ä¸‹è§’å°¤ä¸ºæ˜æ˜¾ï¼‰ï¼Œä½†æ˜¯ä¸¤æ®µé¢œè‰²ä¹‹é—´ä»ç„¶æœ‰ç€ç©ºéš™ï¼Œè¿™æ¥è‡ªäºæˆ‘ä»¬çš„åšåº¦æµ‹è¯•ï¼Œå®ƒå°†æ½œåœ¨çš„äº¤å‰æ’é™¤åœ¨å¤–äº†ã€‚\næ½œåœ¨çš„äº¤å‰ ä¸ºäº†è®¡ç®—æ½œåœ¨çš„äº¤å‰ï¼Œæˆ‘ä»¬éœ€è¦å›é¡¾ä¹‹å‰åšåšåº¦æµ‹è¯•çš„ä»£ç ã€‚å½“å°„çº¿ç©¿è¿‡ç‰©ä½“åé¢æ—¶ï¼Œå¦‚æœå‰ä¸€æ¬¡å°„çº¿è¿˜åœ¨ç‰©ä½“å‰æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥è®°å½•ä¸¤è€…ä¹‹é—´çš„å·®è·thicknessDiffï¼Œå¦‚æœå®ƒçš„å€¼å°äºæœ€å°çš„å·®è·minThicknessDiffï¼Œæˆ‘ä»¬å°†å…¶ä½œä¸ºæ½œåœ¨çš„äº¤å‰ï¼Œæ›´æ–°minThicknessDiffï¼Œå¹¶è®°å½•å½“å‰çš„w1å’Œw2ç”¨äºåç»­çš„äºŒåˆ†æ³•æŸ¥æ‰¾ã€‚åœ¨äºŒåˆ†æ³•æ—¶æˆ‘ä»¬éœ€è¦åˆ¤æ–­å‘ç”Ÿäº†äº¤å‰è¿˜æ˜¯å‘ç”Ÿäº†æ½œåœ¨çš„äº¤å‰ï¼Œå¦‚æœå‘ç”Ÿäº†äº¤å‰ï¼Œæˆ‘ä»¬æ‰§è¡ŒåŸæœ‰çš„ä»£ç ï¼Œå¦‚æœå‘ç”Ÿçš„æ˜¯æ½œåœ¨çš„äº¤å‰ï¼Œåœ¨äºŒåˆ†æ³•æ—¶æˆ‘ä»¬ä¹Ÿéœ€è¦è®°å½•thicknessDiffï¼Œæ‰¾åˆ°æœ€å°çš„å°äº_Thickness.yçš„thicknessDiffï¼Œä½¿ç”¨å½“å‰wæ’å€¼å¾—åˆ°çš„pé‡‡æ ·è·å¾—æœ€ç»ˆçš„é¢œè‰²ã€‚\nä¼ªä»£ç å˜æˆäº†ï¼š\n å°†æ­¥è¿›ç»ˆç‚¹è¿›è¡Œè§†é”¥ä½“è£å‰ªå¾—åˆ°clippedPosVSï¼Œå†è¿›ä¸€æ­¥å¾—åˆ°ç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡endCSã€‚ è®°k0ã€k1åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„wåˆ†é‡çš„å€’æ•°ã€‚ è®°q0ã€q1åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„xyzåˆ†é‡ã€‚ è®°p0ã€p1åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´åæ ‡çš„xyåˆ†é‡ã€‚ è®°w1æ˜¯ä¸€ä¸ªåœ¨(0, 1)ä¹‹é—´æŒ‰ç…§1.0f/_StepCounté€’å¢çš„å˜é‡ï¼Œw1å’Œw2åˆå§‹åŒ–ä¸º0ã€‚ å¯¹æ¯ä¸€æ¬¡æ­¥è¿›ï¼Œw2=w1ï¼Œæ›´æ–°w1çš„å€¼ï¼Œå¹¶å¯¹ä¸Šé¢çš„ä¸‰ç»„åˆ†é‡çº¿æ€§æ’å€¼å¾—åˆ°kã€qã€pã€‚ ä½¿ç”¨q.z * kè·å¾—rayDepthï¼Œä½¿ç”¨pé‡‡æ ·æ·±åº¦å›¾è·å¾—sampleDepthã€‚ å¦‚æœrayZ ä¸”thicknessDiff ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ï¼Œè·³å‡ºå¾ªç¯ã€‚ å¦åˆ™å¦‚æœrayZ ä¸”thicknessDiff  _Thickness.yä¸”ä¸Šä¸€æ¬¡å°„çº¿åœ¨ç‰©ä½“å‰æ–¹ï¼Œå°†thicknessDiffå’Œæœ€å°å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ›´å°åˆ™æ›´æ–°æœ€å°å€¼ï¼Œè®°å½•æ­¤æ—¶çš„w1å’Œw2ï¼Œè®°ä¸ºå‘ç”Ÿäº†æ½œåœ¨çš„äº¤å‰ï¼Œç»§ç»­å¾ªç¯ã€‚ å¦‚æœå‘ç”Ÿäº†äº¤å‰ï¼Œè®°wä¸ºw1å’Œw2çš„å¹³å‡æ•°ï¼ŒæŒ‰ç…§567åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº¤å‰ï¼Œæ ¹æ®æ˜¯å¦äº¤å‰æ›´æ–°w1æˆ–w2ï¼Œç›´åˆ°ç»“æŸäºŒåˆ†æ³•å¾ªç¯ã€‚ å¦åˆ™å¦‚æœå‘ç”Ÿäº†æ½œåœ¨äº¤å‰ï¼ŒæŒ‰ç…§567åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº¤å‰ï¼Œä½¿ç”¨æœ€å°çš„thicknessDiffæ›´æ–°pã€‚ ä½¿ç”¨pé‡‡æ ·é¢œè‰²å›¾ï¼Œè·å¾—åå°„çš„é¢œè‰²ã€‚   æ•ˆæœæ˜¯è¿™æ ·çš„ï¼ˆæ­¥è¿›æ¬¡æ•°ä¸º32æ¬¡ï¼ŒäºŒåˆ†æ³•æŸ¥æ‰¾æ¬¡æ•°ä¸º5æ¬¡ï¼‰: ä¸‹å›¾æ˜¯æ­¥è¿›æ¬¡æ•°ä¸º64æ¬¡ï¼ŒäºŒåˆ†æ³•æŸ¥æ‰¾5æ¬¡çš„æ•ˆæœï¼š æœ€ç»ˆçš„ä»£ç  /*\r// Copyright (c) 2024 zznewclear@gmail.com\r// // Permission is hereby granted, free of charge, to any person obtaining a copy\r// of this software and associated documentation files (the \"Software\"), to deal\r// in the Software without restriction, including without limitation the rights\r// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r// copies of the Software, and to permit persons to whom the Software is\r// furnished to do so, subject to the following conditions:\r// // The above copyright notice and this permission notice shall be included in all\r// copies or substantial portions of the Software.\r// // THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r// SOFTWARE.\r*/\rShader \"zznewclear13/SSRShader\"\r{\rProperties\r{\r[Toggle(USE_POTENTIAL_HIT)] _UsePotentialHit (\"Use Potential Hit\", Float) = 1.0\r[Toggle(USE_FRUSTUM_CLIP)] _UseFrustumClip (\"Use Frustum Clip\", Float) = 1.0\r[Toggle(USE_BINARY_SEARCH)] _UseBinarySearch (\"Use Binary Search\", Float) = 1.0\r[Toggle(USE_THICKNESS)] _UseThickness (\"Use Thickness\", Float) = 1.0\r_MaxDistance (\"Max Distance\", Range(0.1, 100.0)) = 15.0\r[int] _StepCount (\"Step Count\", Float) = 32\r_ThicknessParams (\"Thickness Params\", Vector) = (0.1, 0.02, 0.0, 0.0)\r}\rHLSLINCLUDE\r#include \"Packages/com.unity.render-pipelines.core/ShaderLibrary/Common.hlsl\"\r#include \"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl\"\r#include \"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl\"\r#pragma shader_feature _ USE_POTENTIAL_HIT\r#pragma shader_feature _ USE_FRUSTUM_CLIP\r#pragma shader_feature _ USE_BINARY_SEARCH\r#pragma shader_feature _ USE_THICKNESS\r#define INFINITY 1e10\r#define DEPTH_SAMPLER sampler_PointClamp\rTexture2D _CameraOpaqueTexture;\rTexture2D _CameraDepthTexture;\rCBUFFER_START(UnityPerMaterial)\rfloat _MaxDistance;\rint _StepCount;\rfloat2 _ThicknessParams;\rCBUFFER_END\rstruct Attributes\r{\rfloat4 positionOS : POSITION;\rfloat3 normalOS : NORMAL;\rfloat2 texcoord : TEXCOORD0;\r};\rstruct Varyings\r{\rfloat4 positionCS : SV_POSITION;\rfloat3 positionWS : TEXCOORD0;\rfloat3 normalWS : TEXCOORD1;\rfloat2 uv : TEXCOORD2;\rfloat3 viewWS : TEXCOORD3;\r};\rVaryings vert(Attributes input)\r{\rVaryings output = (Varyings)0;\rVertexPositionInputs vpi = GetVertexPositionInputs(input.positionOS.xyz);\rVertexNormalInputs vni = GetVertexNormalInputs(input.normalOS);\routput.positionCS = vpi.positionCS;\routput.positionWS = vpi.positionWS;\routput.normalWS = vni.normalWS;\routput.uv = input.texcoord;\routput.viewWS = GetCameraPositionWS() - vpi.positionWS;\rreturn output;\r}\rfloat3 frustumClip(float3 from, float3 to, float2 nf, float2 s)\r{\rfloat3 dir = to - from;\rfloat3 signDir = sign(dir);\rfloat nfSlab = signDir.z * (nf.y - nf.x) * 0.5f + (nf.y + nf.x) * 0.5f;\rfloat lenZ = (nfSlab - from.z) / dir.z;\rif (dir.z == 0.0f) lenZ = INFINITY;\rfloat2 ss = sign(dir.xy - s * dir.z) * s;\rfloat2 denom = ss * dir.z - dir.xy;\rfloat2 lenXY = (from.xy - ss * from.z) / denom;\rif (lenXY.x 0.0f)\r{\rif (thicknessDiff thicknessDiff)\r{\rminPotentialHitPos = thicknessDiff;\rpotentialW12 = float2(w1, w2);\r}\r}\r}\rlastHit = hitDiff  0.0f;\r}\r#else\rfloat w1 = 0.0f;\rfloat w2 = 0.0f;\rbool hit = false;\r[unroll(64)]\rfor (int i=0; i0.0f \u0026\u0026 thicknessDiff 0.0f)\r{\rw1 = w;\rif (hit) hitPos = p;\r}\relse\r{\rw2 = w;\r}\rfloat thicknessDiff = getThicknessDiff(hitDiff, linearSampleDepth, _ThicknessParams);\rfloat absThicknessDiff = abs(thicknessDiff);\rif (!hit \u0026\u0026 absThicknessDiff ä¼˜åŒ–çš„æ–¹å‘ ç›®å‰è¿˜æœ‰ä¸€ä¸ªå€¼å¾—ä¼˜åŒ–çš„æ–¹å‘ï¼Œå°±æ˜¯æ ¹æ®p0å’Œp1ä¹‹é—´çš„åƒç´ è·ç¦»æ§åˆ¶æ€»ä½“çš„æ­¥è¿›æ¬¡æ•°ï¼Œæ€»ä¸è‡³äºå¯¹10ä¸ªåƒç´ æ­¥è¿›64æ¬¡å§ã€‚ä¸è¿‡è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œç•™ç»™æœ‰ç©ºçš„äººæ¥åšå§ã€‚è‡³äºéšæœºé‡‡æ ·ã€æ¨¡ç³Šå’Œè²æ¶…å°”ï¼Œç­‰åˆ°çœŸçš„ç”¨åˆ°çš„æ—¶å€™å†å»è€ƒè™‘å§ã€‚\nåè®° 2024ç®€ç›´å°±æ˜¯å¼€å¹•é›·å‡»ï¼Œå„ç§ç³Ÿç³•çš„äº‹æƒ…æ¥è¸µè€Œè‡³ï¼Œæœ‰æ—¶å€™ä¼šæœ‰æ·±æ·±çš„æ— åŠ›æ„Ÿã€‚å¯èƒ½åªæœ‰å†™åšå®¢å’ŒShadertoyæ‰èƒ½ç»™æˆ‘å¸¦æ¥æœ€å¼ºçš„æ»¡è¶³æ„Ÿå§ï¼Œå¸Œæœ›çœŸçš„æœ‰äººèƒ½ä»æˆ‘çš„åšå®¢å’ŒShadertoyä¸­æœ‰æ‰€æ”¶è·ã€‚æœ¬æ¥æ˜¯æ‰“ç®—å†™ä¸€ç¯‡Contact Shadowçš„ï¼Œä½†æ˜¯å‘ç°å±å¹•ç©ºé—´ray marchingå…¶å®å¹¶ä¸æ˜¯é‚£ä¹ˆä¸€ä»¶ç®€å•çš„äº‹æƒ…ï¼Œå› æ­¤æƒ³å…ˆå†™å®Œè¿™ä¸ªå†ç»§ç»­æˆ‘çš„Contact Shadowã€‚è¯´å®åœ¨çš„æˆ‘å¯¹è¿™ç¯‡åšå®¢çš„è´¨é‡è¿˜æ˜¯æ¯”è¾ƒæ»¡æ„çš„ï¼Œæ‰“ç®—å†å†™ä¸ªè‹±æ–‡ç‰ˆçš„å»æŠ•ç¨¿Graphics Programming weeklyï¼Œæ‹­ç›®ä»¥å¾….gifã€‚\n","wordCount":"1447","inLanguage":"en","image":"https://zznewclear13.github.io/posts/screen-space-reflection/posts/images/ScreenSpaceReflection_64.png","datePublished":"2024-03-09T17:00:00+08:00","dateModified":"2024-03-09T17:00:00+08:00","author":{"@type":"Person","name":"zznewclear13"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://zznewclear13.github.io/posts/screen-space-reflection/"},"publisher":{"@type":"Organization","name":"ZZNEWCLEAR13","logo":{"@type":"ImageObject","url":"https://zznewclear13.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><header class=header><nav class=nav><div class=logo><a href=https://zznewclear13.github.io/ accesskey=h title="ZZNEWCLEAR13 (Alt + H)"><img src=https://zznewclear13.github.io/apple-touch-icon.png alt aria-label=logo height=35>ZZNEWCLEAR13</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://zznewclear13.github.io/now/ title=è¿›è¡Œæ—¶><span>è¿›è¡Œæ—¶</span></a></li><li><a href=https://zznewclear13.github.io/tags/ title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://zznewclear13.github.io/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://zznewclear13.github.io/links/ title=å‹æƒ…é“¾æ¥><span>å‹æƒ…é“¾æ¥</span></a></li><li><a href=https://zznewclear13.github.io/search/ title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://zznewclear13.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://zznewclear13.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">å±å¹•ç©ºé—´åå°„</h1><div class=post-description>ç›®æ ‡æ˜¯åœ¨ä¸€ä¸ªShaderä¸­ä½¿ç”¨å°½é‡å°‘çš„æ­¥è¿›æ¬¡æ•°å¾—åˆ°æ­£ç¡®çš„åå°„é¢œè‰².</div><div class=post-meta><span title="2024-03-09 17:00:00 +0800 CST">March 9, 2024</span>&nbsp;Â·&nbsp;zznewclear13&nbsp;|&nbsp;<a href=https://github.com/zznewclear13/zznewclear13.com/blob/main/content/posts/screen-space-reflection.md rel="noopener noreferrer" target=_blank>ç¼–è¾‘</a></div></header><figure class=entry-cover><img loading=eager src=https://zznewclear13.github.io/posts/images/ScreenSpaceReflection_64.png alt="Screen Space Reflection Cover"><p>Screen Space Reflection Example</p></figure><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>å±å¹•ç©ºé—´åå°„</div></summary><div class=inner><ul><li><a href=#%e5%b1%8f%e5%b9%95%e7%a9%ba%e9%97%b4%e5%8f%8d%e5%b0%84 aria-label=å±å¹•ç©ºé—´åå°„>å±å¹•ç©ºé—´åå°„</a></li><li><a href=#%e5%8f%8d%e5%b0%84%e7%9a%84%e8%ae%a1%e7%ae%97 aria-label=åå°„çš„è®¡ç®—>åå°„çš„è®¡ç®—</a><ul><li><a href=#%e5%8f%82%e6%95%b0%e7%9a%84%e9%80%89%e6%8b%a9 aria-label=å‚æ•°çš„é€‰æ‹©>å‚æ•°çš„é€‰æ‹©</a></li><li><a href=#%e6%b7%b1%e5%ba%a6%e6%af%94%e8%be%83 aria-label=æ·±åº¦æ¯”è¾ƒ>æ·±åº¦æ¯”è¾ƒ</a></li><li><a href=#%e5%85%89%e7%ba%bf%e6%ad%a5%e8%bf%9b aria-label=å…‰çº¿æ­¥è¿›>å…‰çº¿æ­¥è¿›</a></li><li><a href=#%e5%8e%9a%e5%ba%a6%e6%a3%80%e6%b5%8b aria-label=åšåº¦æ£€æµ‹>åšåº¦æ£€æµ‹</a></li><li><a href=#%e8%a7%86%e9%94%a5%e4%bd%93%e8%a3%81%e5%89%aa aria-label=è§†é”¥ä½“è£å‰ª>è§†é”¥ä½“è£å‰ª</a></li><li><a href=#%e4%ba%8c%e5%88%86%e6%b3%95%e6%9f%a5%e6%89%be aria-label=äºŒåˆ†æ³•æŸ¥æ‰¾>äºŒåˆ†æ³•æŸ¥æ‰¾</a></li><li><a href=#%e6%bd%9c%e5%9c%a8%e7%9a%84%e4%ba%a4%e5%8f%89 aria-label=æ½œåœ¨çš„äº¤å‰>æ½œåœ¨çš„äº¤å‰</a></li><li><a href=#%e6%9c%80%e7%bb%88%e7%9a%84%e4%bb%a3%e7%a0%81 aria-label=æœ€ç»ˆçš„ä»£ç >æœ€ç»ˆçš„ä»£ç </a></li><li><a href=#%e4%bc%98%e5%8c%96%e7%9a%84%e6%96%b9%e5%90%91 aria-label=ä¼˜åŒ–çš„æ–¹å‘>ä¼˜åŒ–çš„æ–¹å‘</a></li></ul></li><li><a href=#%e5%90%8e%e8%ae%b0 aria-label=åè®°>åè®°</a></li></ul></div></details></div><div class=post-content><h2 id=å±å¹•ç©ºé—´åå°„>å±å¹•ç©ºé—´åå°„<a hidden class=anchor aria-hidden=true href=#å±å¹•ç©ºé—´åå°„>#</a></h2><p>å±å¹•ç©ºé—´åå°„ä¹Ÿæ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„æ•ˆæœäº†ï¼Œä½†æ­£å¦‚æœ¬åšå®¢çš„å®—æ—¨ï¼Œè¦ä»åƒç¯‡ä¸€å¾‹ä¸­è„±é¢–è€Œå‡ºï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿå°†ä»‹ç»ä¸ä¼—ä¸åŒçš„ï¼Œè‡³å°‘æˆ‘åœ¨ç½‘ä¸Šæ²¡æœ‰è§åˆ°è¿‡çš„è®¡ç®—å±å¹•ç©ºé—´åå°„çš„æ–¹æ³•ã€‚</p><p>ç½‘ä¸Šæœ‰å¾ˆå¤šå¾ˆå¤šçš„å±å¹•ç©ºé—´åå°„çš„æ•™ç¨‹ï¼Œç»å¤§éƒ¨åˆ†çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼šè®¡ç®—ä¸–ç•Œç©ºé—´çš„åå°„æ–¹å‘ï¼Œä½¿ç”¨ä¸€ä¸ªå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ç»Ÿä¸€çš„æ­¥é•¿åœ¨ä¸–ç•Œç©ºé—´ä¸­æ­¥è¿›ï¼Œå¯¹äºæ¯ä¸€æ¬¡æ­¥è¿›ï¼Œè®¡ç®—æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´çš„åæ ‡ï¼Œå°†å½“å‰çš„æ·±åº¦å’Œæ·±åº¦å›¾è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœåœ¨æ·±åº¦å›¾ä¹‹åï¼Œè®¤ä¸ºå‘ç”Ÿäº†äº¤å‰ï¼Œé‡‡æ ·å½“å‰ç‚¹çš„é¢œè‰²å€¼å¹¶è¿”å›ã€‚è¿™ç§æ–¹æ³•èƒ½çœ‹åˆ°å¾ˆå¤šå¾ˆå¤šçœ‹ä¸Šå»éå¸¸å®Œç¾çš„åå°„æ•ˆæœï¼Œä½†å‡ ä¹æ²¡æœ‰äººä¼šæåŠæ‰€éœ€è¦çš„æ­¥è¿›æ¬¡æ•°ï¼Œå› ä¸ºå®ƒå¾€å¾€é«˜å¾—æƒŠäººï¼Œå…³äºè¿™ç‚¹æˆ‘ä»¬åç»­è¿˜ä¼šè°ˆåˆ°ã€‚è€Œä¸”å¯¹äºä¸åŒè¿œè¿‘çš„ç‰©ä½“ï¼Œæƒ³è¦è¾¾åˆ°æ¯”è¾ƒå¥½åå°„æ•ˆæœï¼Œå…¶éœ€è¦çš„æ­¥é•¿å¾€å¾€æ˜¯ä¸åŒçš„ï¼Œä¹Ÿå¾ˆå°‘æœ‰äººå»åšè¿™æ–¹é¢çš„æ€è€ƒã€‚ç¨å¥½ä¸€äº›çš„ä¼šè€ƒè™‘åœ¨äº¤å‰ä¹‹ååšå‡ æ¬¡äºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œè¿™æ ·èƒ½å¤Ÿè®©ä¸€æ®µä¸€æ®µçš„åå°„åçš„é¢œè‰²å¸¦ä¸Šä¸‹é¢ å€’ï¼Œä½¿ç”»é¢çœ‹ä¸Šå»æ›´åŠ è¿è´¯ï¼Œåé¢ä¹Ÿèƒ½çœ‹åˆ°å¯¹æ¯”ã€‚è¿˜æœ‰ä¸€äº›ä¼šè€ƒè™‘åœ¨è®¡ç®—æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´çš„åæ ‡åï¼Œæ ¹æ®åæ ‡å’Œ[-1, 1]ä¹‹é—´çš„å¤§å°å…³ç³»ï¼Œæå‰ç»“æŸæ­¥è¿›æˆ–æ˜¯å¯¹åå°„çš„é¢œè‰²å’Œç¯å¢ƒåå°„è¿›è¡Œæ’å€¼ã€‚ç›®å‰çœ‹æ¥æœ€å¥½çš„æ­¥è¿›æ–¹æ³•ï¼Œæ˜¯é¢„å…ˆè®¡ç®—Hierarchical ZBufferï¼Œé€šè¿‡å¯¹æ›´é«˜LODæ­¥è¿›çš„æ–¹æ³•ï¼Œä½¿ç”¨æ›´å°‘çš„æ­¥è¿›æ¬¡æ•°è¾¾åˆ°åŒæ ·çš„æ­¥è¿›æ•ˆæœï¼Œä½†æ˜¯Hierarchical ZBufferå¹¶ä¸æ˜¯ä¸€ä¸ªæ‰€æœ‰é¡¹ç›®éƒ½èƒ½æœ‰çš„ç‰¹æ€§ã€‚</p><p>ç½‘ä¸Šèƒ½æ‰¾åˆ°çš„æœ€æœ‰ç”¨çš„æ•™ç¨‹ï¼Œæ˜¯Morgan McGuireå†™çš„<a href=http://casual-effects.blogspot.com/2014/08/screen-space-ray-tracing.html>Screen Space Ray Tracing</a>ã€‚åœ¨ä»–çš„è¿™ç¯‡æ–‡ç« ä¸­ä¹Ÿæåˆ°äº†ä¸ºä»€ä¹ˆåœ¨ä¸–ç•Œç©ºé—´ä¸­æ­¥è¿›æ˜¯ä¸å¥½çš„ï¼Œå› ä¸ºä¸–ç•Œç©ºé—´æ­¥è¿›çš„ä½ç½®åœ¨ç»è¿‡é€è§†å˜æ¢åï¼Œå¾ˆæœ‰å¯èƒ½åœ¨å±å¹•ç©ºé—´ä¸­æ²¡å¤šå¤§å˜åŒ–ï¼Œä¹Ÿå°±å¯¼è‡´äº†ä¸–ç•Œç©ºé—´æ­¥è¿›éœ€è¦æ›´å¤šçš„æ¬¡æ•°æ¥è¾¾åˆ°è¾ƒå¥½çš„åå°„æ•ˆæœã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­å±•ç¤ºäº†ä¸€ä¸ªéå¸¸å¥½çš„æ–¹æ³•ï¼Œè®¡ç®—è£å‰ªç©ºé—´å’Œå±å¹•ç©ºé—´çš„èµ·ç‚¹å’Œç»ˆç‚¹çš„åæ ‡ï¼Œé€šè¿‡å¯¹è£å‰ªç©ºé—´çš„zã€è£å‰ªç©ºé—´çš„1/wã€å±å¹•ç©ºé—´çš„xyè¿›è¡Œçº¿æ€§æ’å€¼ï¼Œçœå»äº†æ¯ä¸€æ¬¡æ­¥è¿›æ‰€éœ€è¦çš„çŸ©é˜µè¿ç®—ï¼Œååˆ†å€¼å¾—ä½¿ç”¨ã€‚</p><p>æœ¬æ–‡çš„ç›®æ ‡æ˜¯ï¼Œåœ¨ä¸€ä¸ªShaderä¸­ä½¿ç”¨å°½é‡å°‘çš„æ­¥è¿›æ¬¡æ•°å¾—åˆ°æ­£ç¡®çš„åå°„é¢œè‰²ã€‚éšæœºé‡‡æ ·ã€æ¨¡ç³Šã€è²æ¶…å°”æ•ˆåº”ä¹‹ç±»çš„ä¸åœ¨æœ¬æ–‡çš„è€ƒè™‘èŒƒå›´ä¹‹å†…ã€‚æœ¬æ–‡ä»…è€ƒè™‘Windowså¹³å°ä¸‹DX11çš„Shaderï¼Œè¿™æ ·èƒ½çœå»å¾ˆå¤šçš„å¹³å°é€‚é…çš„ä»£ç ï¼Œä½¿ç”¨çš„Unityç‰ˆæœ¬æ˜¯Unity 2022.3.21f1ï¼Œåœ¨æ–‡ç« çš„æœ€åä¼šé™„ä¸Šæœ€ç»ˆçš„Shaderä»£ç ã€‚</p><h2 id=åå°„çš„è®¡ç®—>åå°„çš„è®¡ç®—<a hidden class=anchor aria-hidden=true href=#åå°„çš„è®¡ç®—>#</a></h2><h3 id=å‚æ•°çš„é€‰æ‹©>å‚æ•°çš„é€‰æ‹©<a hidden class=anchor aria-hidden=true href=#å‚æ•°çš„é€‰æ‹©>#</a></h3><p>è®¡ç®—åå°„åŸºæœ¬ä¸Šåªéœ€è¦ä¸‰ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯<code>Max Distance</code>ï¼Œåªè€ƒè™‘è·ç¦»åå°„ç‚¹ä¸€å®šèŒƒå›´å†…çš„ç‰©ä½“å¸¦æ¥çš„åå°„ï¼Œä¸€ä¸ªæ˜¯<code>Step Count</code>ï¼Œæ›´å¤šçš„æ­¥è¿›æ¬¡æ•°å¸¦æ¥æ›´ç²¾ç¡®çš„åå°„ï¼ŒåŒæ—¶ä¹Ÿå¢åŠ æ€§èƒ½æ¶ˆè€—ï¼Œæœ€åä¸€ä¸ªæ˜¯<code>Thickness Params</code>ï¼Œå¯¹äºä¸€ä¸ªç‰©ä½“ï¼Œé»˜è®¤å…¶åšåº¦ä¸º<code>depth * _Thickness.y + _Thickness.x</code>ï¼Œè¿™æ ·å½“å°„çº¿ç»è¿‡ç‰©ä½“èƒŒé¢æ—¶ä¸ä¼šè¢«è®¤ä¸ºå‘ç”Ÿäº†äº¤å‰ã€‚</p><h3 id=æ·±åº¦æ¯”è¾ƒ>æ·±åº¦æ¯”è¾ƒ<a hidden class=anchor aria-hidden=true href=#æ·±åº¦æ¯”è¾ƒ>#</a></h3><p>æ­¥è¿›çš„æ—¶å€™æ¯”è¾ƒä»€ä¹ˆæ·±åº¦ä¹Ÿæ˜¯ä¸€ä¸ªå€¼å¾—æ€è€ƒçš„é—®é¢˜ã€‚å°†æ­¥è¿›çš„æ·±åº¦è®°ä¸º<code>rayDepth</code>ï¼Œå°†é‡‡æ ·è·å¾—çš„æ·±åº¦è®°ä¸º<code>sampleDepth</code>ï¼Œä¸€ä¸ªå¾ˆç®€å•çš„æƒ³æ³•åœ¨æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´è¿›è¡Œæ¯”è¾ƒï¼Œå› ä¸ºç›´æ¥é‡‡æ ·æ·±åº¦å›¾å°±èƒ½è·å–åˆ°æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´çš„æ·±åº¦å€¼ï¼Œå½“<code>rayDepth &lt; sampleDepth</code>çš„æ—¶å€™ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ã€‚åˆæˆ–æ˜¯å¯¹å®é™…çš„æ·±åº¦è¿›è¡Œæ¯”è¾ƒï¼Œè¿™æ ·èƒ½å¤ŸæŒ‡å®šä¸€ä¸ªåšåº¦ï¼Œå½“æ·±åº¦çš„å·®å¤§äºåšåº¦æ—¶ï¼Œè®¤ä¸ºå°„çº¿ä»åœºæ™¯ç‰©ä½“çš„åé¢ç©¿äº†è¿‡å»å¹¶æ²¡æœ‰å‘ç”Ÿäº¤å‰ï¼Œå½“<code>rayDepth > sampleDepth && rayDepth &lt; sampleDepth + thickness</code>çš„æ—¶å€™ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ã€‚æ­¤å¤–è£å‰ªç©ºé—´çš„Zåˆ†é‡ä¹Ÿèƒ½ç”¨æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†äº¤å‰ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚æ·±åº¦å›¾çš„é‡‡æ ·æ–¹å¼åˆ™åº”è¯¥ä½¿ç”¨<code>PointClamp</code>çš„æ–¹å¼ï¼Œä½¿ç”¨çº¿æ€§æ’å€¼çš„è¯åœ¨ä¸€å‰ä¸€åçš„ä¸¤ä¸ªé¢çš„è¾¹ç¼˜å¾ˆå¯èƒ½ä¼šè¢«è®¤ä¸ºå‘ç”Ÿäº†äº¤å‰ï¼Œå¯¼è‡´ç”»é¢ä¸Šæœ‰ä¸å°‘çš„å°ç‚¹ï¼Œé™¤éå¦å¤–æœ‰ä¸€å¼ æ ‡è®°ç‰©ä½“è¾¹ç¼˜çš„è´´å›¾å¯ä»¥ç”¨æ¥æ’é™¤æ‰è¿™éƒ¨åˆ†çš„äº¤å‰ç‚¹ã€‚</p><h3 id=å…‰çº¿æ­¥è¿›>å…‰çº¿æ­¥è¿›<a hidden class=anchor aria-hidden=true href=#å…‰çº¿æ­¥è¿›>#</a></h3><p>ä¼ªä»£ç å¾ˆç®€å•ï¼š</p><blockquote><ol><li>è®°<code>k0</code>ã€<code>k1</code>åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„wåˆ†é‡çš„å€’æ•°ã€‚</li><li>è®°<code>q0</code>ã€<code>q1</code>åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„xyzåˆ†é‡ã€‚</li><li>è®°<code>p0</code>ã€<code>p1</code>åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´åæ ‡çš„xyåˆ†é‡ã€‚</li><li>è®°<code>w</code>æ˜¯ä¸€ä¸ªåœ¨(0, 1)ä¹‹é—´æŒ‰ç…§<code>1.0f/_StepCount</code>é€’å¢çš„å˜é‡ã€‚</li><li>å¯¹æ¯ä¸€æ¬¡æ­¥è¿›ï¼Œæ›´æ–°<code>w</code>çš„å€¼ï¼Œå¹¶å¯¹ä¸Šé¢çš„ä¸‰ç»„åˆ†é‡çº¿æ€§æ’å€¼å¾—åˆ°<code>k</code>ã€<code>q</code>ã€<code>p</code>ã€‚</li><li>ä½¿ç”¨<code>q.z * k</code>è·å¾—<code>rayDepth</code>ï¼Œä½¿ç”¨<code>p</code>é‡‡æ ·æ·±åº¦å›¾è·å¾—<code>sampleDepth</code>ã€‚</li><li>å¦‚æœ<code>rayDepth &lt; sampleDepth</code>ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ï¼Œè·³å‡ºå¾ªç¯ï¼Œè¿”å›<code>p</code>ã€‚</li><li>ä½¿ç”¨<code>p</code>é‡‡æ ·é¢œè‰²å›¾ï¼Œè·å¾—åå°„çš„é¢œè‰²ã€‚</li></ol></blockquote><p>æ•ˆæœæ˜¯è¿™æ ·çš„ï¼ˆæ­¥è¿›æ¬¡æ•°ä¸º32æ¬¡ï¼‰:
<img loading=lazy src=../images/ScreenSpaceReflection_Naive.png#center alt="Screen Space Reflection Naive"></p><p>çœ‹ä¸Šå»éå¸¸ç³Ÿç³•ï¼Œæœ€æ˜æ˜¾çš„æ˜¯æ‹‰æ‰¯çš„æ•ˆæœã€‚å®ƒä¸»è¦æœ‰ä¸¤ä¸ªäº§ç”Ÿçš„åŸå› ï¼šä¸€æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰ä½¿ç”¨åšåº¦æ¥åˆ¤æ–­å°„çº¿æ˜¯å¦ä»ç‰©ä½“çš„èƒŒé¢ç©¿è¿‡ï¼Œè¿™å¯¼è‡´äº†æ‚¬ç©ºçš„ç‰©ä½“ä¸‹æ–¹ä¼šæœ‰å¾ˆé•¿çš„æ‹‰æ‰¯ï¼›äºŒæ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹è¶…å‡ºå±å¹•èŒƒå›´çš„ä½ç½®è¿›è¡Œé™åˆ¶ï¼Œè¿™å¯¼è‡´äº†æˆ‘ä»¬ä½¿ç”¨å±å¹•å¤–çš„åæ ‡é‡‡æ ·æ·±åº¦å›¾ä½†è¿”å›äº†Clampä¹‹åçš„æ·±åº¦å€¼ã€‚</p><h3 id=åšåº¦æ£€æµ‹>åšåº¦æ£€æµ‹<a hidden class=anchor aria-hidden=true href=#åšåº¦æ£€æµ‹>#</a></h3><p>ä¸ºäº†è§£å†³ä¸Šé¢çš„åšåº¦é—®é¢˜ï¼Œæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªæ–¹æ³•ç”±äºåˆ¤æ–­æ­¥è¿›çš„ä½ç½®æ˜¯å¦åœ¨ç‰©ä½“åé¢ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„æ˜¯è·ç¦»ç›¸æœºçš„çº¿æ€§æ·±åº¦<code>linearRayDepth</code>å’Œ<code>linearSampleDepth</code>ã€‚ä¸Šæ–‡è¯´åˆ°æˆ‘ä»¬ä½¿ç”¨<code>linearSampleDepth * _Thickness.y + _Thickness.x</code>æ¥ä½œä¸ºä¸€ä¸ªåœºæ™¯ä¸­ä¸€ä¸ªç‰©ä½“çš„åšåº¦ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ¤æ–­<code>(linearRayDepth-linearSampleDepth-_Thickness.x) / linearSampleDepth</code>å’Œ<code>_Thickness.y</code>çš„å¤§å°å³å¯ï¼Œå¦‚æœå‰å¼å¤§äºåå¼ï¼Œåˆ™è¡¨æ˜å°„çº¿ä»ç‰©ä½“åé¢ç©¿è¿‡ã€‚</p><pre><code class=language-HLSL data-lang=HLSL>    float getThicknessDiff(float diff, float linearSampleDepth, float2 thicknessParams)
    {
        return (diff - thicknessParams.x) / linearSampleDepth;
    }
</code></pre><p>ä¼ªä»£ç å˜æˆäº†ï¼š</p><blockquote><ol start=7><li>å¦‚æœ<code>rayZ &lt; sampleZ</code>ä¸”<code>thicknessDiff &lt; _Thickness.y</code>ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ï¼Œè·³å‡ºå¾ªç¯ï¼Œè¿”å›<code>p</code>ã€‚</li></ol></blockquote><p>æ•ˆæœæ˜¯è¿™æ ·çš„ï¼ˆæ­¥è¿›æ¬¡æ•°ä¸º32æ¬¡ï¼‰:
<img loading=lazy src=../images/ScreenSpaceReflection_ThicknessTest.png#center alt="Screen Space Reflection Thickness Test"></p><h3 id=è§†é”¥ä½“è£å‰ª>è§†é”¥ä½“è£å‰ª<a hidden class=anchor aria-hidden=true href=#è§†é”¥ä½“è£å‰ª>#</a></h3><p>å¯¹äºè¶…å‡ºå±å¹•ç©ºé—´çš„<code>p1</code>ï¼Œä¼šå¸¦æ¥ä¸¤ä¸ªåå¤„ï¼Œä¸€æ˜¯é‡‡æ ·äº†è¶…å‡ºèŒƒå›´çš„æ·±åº¦å›¾å¾—åˆ°äº†é”™è¯¯çš„æ·±åº¦å€¼ï¼ŒäºŒæ˜¯å‡å°‘äº†æœ‰æ•ˆé‡‡æ ·çš„æ¬¡æ•°ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†<code>p1</code>é™åˆ¶åœ¨å±å¹•ç©ºé—´å†…ï¼Œè¿™é‡Œæ–°å¢äº†ä¸€ä¸ªæ–¹æ³•ç”¨äºå°†æ­¥è¿›ç»ˆç‚¹é™åˆ¶åœ¨è§†é”¥ä½“å†…éƒ¨ã€‚æˆ‘ä»¬è®°<code>nf</code>ä¸ºè¿‘è£å‰ªé¢æ·±åº¦å’Œè¿œè£å‰ªé¢æ·±åº¦å€¼ï¼ˆæ­£æ•°ï¼‰ï¼Œ<code>s</code>ä¸ºè§†é”¥ä½“çš„å·¦å³å’Œä¸Šä¸‹çš„æ–œç‡ï¼ˆæ­£æ•°ï¼‰ï¼Œ<code>s</code>åœ¨æ•°å€¼ä¸Šä¸º<code>float2(asepect * tan(fovy * 0.5f), tan(fovy * 0.5f)</code>ï¼Œæ³¨æ„ä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼Œè¿™é‡Œ<code>from</code>å’Œ<code>to</code>çš„zåˆ†é‡ä¸ºæ­£æ•°ã€‚ä¸‹é¢çš„ç®—æ³•åº”è¯¥è¿˜èƒ½ä¼˜åŒ–ä¸€äº›ï¼Œä¸è¿‡å·²ç»å¤Ÿç”¨äº†ã€‚</p><p>äº‹å®ä¸Šæˆ‘è¿˜å†™äº†ä¸€ä¸ªShadertoyç”¨æ¥æ¼”ç¤ºï¼Œä½¿ç”¨é¼ æ ‡è¿›è¡Œäº¤äº’ï¼š</p><figure class=entry-cover><iframe width=640 height=360 frameborder=0 src="https://www.shadertoy.com/embed/4XfSDB?gui=true&t=10&paused=false&muted=true" allowfullscreen></iframe><p>Frustum Clip 2D</p></figure><pre><code class=language-HLSL data-lang=HLSL>#define INFINITY 1e10

float3 frustumClip(float3 from, float3 to, float2 nf, float2 s)
{
    float3 dir = to - from;
    float3 signDir = sign(dir);

    float nfSlab = signDir.z * (nf.y - nf.x) * 0.5f + (nf.y + nf.x) * 0.5f;
    float lenZ = (nfSlab - from.z) / dir.z;
    if (dir.z == 0.0f) lenZ = INFINITY;

    float2 ss = sign(dir.xy - s * dir.z) * s;
    float2 denom = ss * dir.z - dir.xy;
    float2 lenXY = (from.xy - ss * from.z) / denom;
    if (lenXY.x &lt; 0.0f || denom.x == 0.0f) lenXY.x = INFINITY;
    if (lenXY.y &lt; 0.0f || denom.y == 0.0f) lenXY.y = INFINITY;

    float len = min(min(1.0f, lenZ), min(lenXY.x, lenXY.y));
    float3 clippedVS = from + dir * len;
    return clippedVS;
}
</code></pre><p>ä¼ªä»£ç å˜æˆäº†ï¼š</p><blockquote><ol start=0><li>å°†æ­¥è¿›ç»ˆç‚¹è¿›è¡Œè§†é”¥ä½“è£å‰ªå¾—åˆ°<code>clippedPosVS</code>ï¼Œå†è¿›ä¸€æ­¥å¾—åˆ°ç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡<code>endCS</code>ã€‚</li></ol></blockquote><p>æ•ˆæœæ˜¯è¿™æ ·çš„ï¼ˆæ­¥è¿›æ¬¡æ•°ä¸º32æ¬¡ï¼‰:
<img loading=lazy src=../images/ScreenSpaceReflection_FrustumClip.png#center alt="Screen Space Reflection Frustum Clip"></p><p>çœ‹ä¸Šå»æœ‰é‚£ä¹ˆç‚¹åå°„çš„æ„æ€äº†ï¼Œè§†é”¥ä½“å‰”é™¤ä¸€å®šç¨‹åº¦åœ°å‡å°‘äº†æ¯æ¬¡æ­¥è¿›çš„åƒç´ æ•°ï¼Œå› æ­¤è¡¥ä¸Šäº†ä¸€éƒ¨åˆ†çš„çªŸçª¿ã€‚ä½†æ˜¯åå°„çš„é¢œè‰²æ‰­æ‰­æ›²æ›²çš„ã€‚</p><h3 id=äºŒåˆ†æ³•æŸ¥æ‰¾>äºŒåˆ†æ³•æŸ¥æ‰¾<a hidden class=anchor aria-hidden=true href=#äºŒåˆ†æ³•æŸ¥æ‰¾>#</a></h3><p>æˆ‘ä»¬ä¸Šä¸€æ­¥è·å¾—çš„<code>p</code>è™½ç„¶ç¡®ä¿äº†åœ¨ç‰©ä½“å†…éƒ¨ï¼Œä½†è·ç¦»å®é™…çš„äº¤ç‚¹ä»æœ‰ä¸€éƒ¨åˆ†çš„è·ç¦»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äºŒåˆ†æ³•æŸ¥æ‰¾å‡å°‘ä¸¤è€…ä¹‹é—´çš„è¯¯å·®ã€‚ä¸ºäº†è¿›è¡ŒäºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œæˆ‘ä»¬éœ€è¦è®°å½•æœ€åä¸¤æ¬¡æ­¥è¿›çš„<code>w</code>å€¼ï¼Œè®°ä¸º<code>w1</code>å’Œ<code>w2</code>ï¼ˆ<code>w1 > w2</code>ï¼‰ã€‚æ¯æ¬¡äºŒåˆ†æ³•æ—¶ï¼Œå–<code>w = 0.5f * (w1 + w2)</code>ï¼Œå¦‚æœæ£€æµ‹åˆ°ç›¸äº¤ï¼Œåˆ™<code>w1 = w</code>ï¼Œå¦åˆ™<code>w2 = w</code>ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯ã€‚</p><p>ä¼ªä»£ç å˜æˆäº†ï¼š</p><blockquote><ol start=0><li>å°†æ­¥è¿›ç»ˆç‚¹è¿›è¡Œè§†é”¥ä½“è£å‰ªå¾—åˆ°<code>clippedPosVS</code>ï¼Œå†è¿›ä¸€æ­¥å¾—åˆ°ç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡<code>endCS</code>ã€‚</li><li>è®°<code>k0</code>ã€<code>k1</code>åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„wåˆ†é‡çš„å€’æ•°ã€‚</li><li>è®°<code>q0</code>ã€<code>q1</code>åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„xyzåˆ†é‡ã€‚</li><li>è®°<code>p0</code>ã€<code>p1</code>åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´åæ ‡çš„xyåˆ†é‡ã€‚</li><li>è®°<code>w1</code>æ˜¯ä¸€ä¸ªåœ¨(0, 1)ä¹‹é—´æŒ‰ç…§<code>1.0f/_StepCount</code>é€’å¢çš„å˜é‡ï¼Œ<code>w1</code>å’Œ<code>w2</code>åˆå§‹åŒ–ä¸º0ã€‚</li><li>å¯¹æ¯ä¸€æ¬¡æ­¥è¿›ï¼Œ<code>w2=w1</code>ï¼Œæ›´æ–°<code>w1</code>çš„å€¼ï¼Œå¹¶å¯¹ä¸Šé¢çš„ä¸‰ç»„åˆ†é‡çº¿æ€§æ’å€¼å¾—åˆ°<code>k</code>ã€<code>q</code>ã€<code>p</code>ã€‚</li><li>ä½¿ç”¨<code>q.z * k</code>è·å¾—<code>rayDepth</code>ï¼Œä½¿ç”¨<code>p</code>é‡‡æ ·æ·±åº¦å›¾è·å¾—<code>sampleDepth</code>ã€‚</li><li>å¦‚æœ<code>rayZ &lt; sampleZ</code>ä¸”<code>thicknessDiff &lt; _Thickness.y</code>ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ï¼Œè·³å‡ºå¾ªç¯ã€‚</li><li>è®°<code>w</code>ä¸º<code>w1</code>å’Œ<code>w2</code>çš„å¹³å‡æ•°ï¼ŒæŒ‰ç…§567åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº¤å‰ï¼Œæ ¹æ®æ˜¯å¦äº¤å‰æ›´æ–°<code>w1</code>æˆ–<code>w2</code>ï¼Œç›´åˆ°ç»“æŸäºŒåˆ†æ³•å¾ªç¯ã€‚</li><li>ä½¿ç”¨<code>p</code>é‡‡æ ·é¢œè‰²å›¾ï¼Œè·å¾—åå°„çš„é¢œè‰²ã€‚</li></ol></blockquote><p>æ•ˆæœæ˜¯è¿™æ ·çš„ï¼ˆæ­¥è¿›æ¬¡æ•°ä¸º32æ¬¡ï¼ŒäºŒåˆ†æ³•æŸ¥æ‰¾æ¬¡æ•°ä¸º5æ¬¡ï¼‰:
<img loading=lazy src=../images/ScreenSpaceReflection_BinarySearch.png#center alt="Screen Space Reflection Binary Search"></p><p>å¯ä»¥çœ‹åˆ°åå°„çš„æ•ˆæœçœ‹ä¸Šå»ä¸é‚£ä¹ˆæ‰­æ‰­æ›²æ›²çš„äº†ï¼ˆå·¦ä¸‹è§’å°¤ä¸ºæ˜æ˜¾ï¼‰ï¼Œä½†æ˜¯ä¸¤æ®µé¢œè‰²ä¹‹é—´ä»ç„¶æœ‰ç€ç©ºéš™ï¼Œè¿™æ¥è‡ªäºæˆ‘ä»¬çš„åšåº¦æµ‹è¯•ï¼Œå®ƒå°†æ½œåœ¨çš„äº¤å‰æ’é™¤åœ¨å¤–äº†ã€‚</p><h3 id=æ½œåœ¨çš„äº¤å‰>æ½œåœ¨çš„äº¤å‰<a hidden class=anchor aria-hidden=true href=#æ½œåœ¨çš„äº¤å‰>#</a></h3><p>ä¸ºäº†è®¡ç®—æ½œåœ¨çš„äº¤å‰ï¼Œæˆ‘ä»¬éœ€è¦å›é¡¾ä¹‹å‰åšåšåº¦æµ‹è¯•çš„ä»£ç ã€‚å½“å°„çº¿ç©¿è¿‡ç‰©ä½“åé¢æ—¶ï¼Œå¦‚æœå‰ä¸€æ¬¡å°„çº¿è¿˜åœ¨ç‰©ä½“å‰æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥è®°å½•ä¸¤è€…ä¹‹é—´çš„å·®è·<code>thicknessDiff</code>ï¼Œå¦‚æœå®ƒçš„å€¼å°äºæœ€å°çš„å·®è·<code>minThicknessDiff</code>ï¼Œæˆ‘ä»¬å°†å…¶ä½œä¸ºæ½œåœ¨çš„äº¤å‰ï¼Œæ›´æ–°<code>minThicknessDiff</code>ï¼Œå¹¶è®°å½•å½“å‰çš„<code>w1</code>å’Œ<code>w2</code>ç”¨äºåç»­çš„äºŒåˆ†æ³•æŸ¥æ‰¾ã€‚åœ¨äºŒåˆ†æ³•æ—¶æˆ‘ä»¬éœ€è¦åˆ¤æ–­å‘ç”Ÿäº†äº¤å‰è¿˜æ˜¯å‘ç”Ÿäº†æ½œåœ¨çš„äº¤å‰ï¼Œå¦‚æœå‘ç”Ÿäº†äº¤å‰ï¼Œæˆ‘ä»¬æ‰§è¡ŒåŸæœ‰çš„ä»£ç ï¼Œå¦‚æœå‘ç”Ÿçš„æ˜¯æ½œåœ¨çš„äº¤å‰ï¼Œåœ¨äºŒåˆ†æ³•æ—¶æˆ‘ä»¬ä¹Ÿéœ€è¦è®°å½•<code>thicknessDiff</code>ï¼Œæ‰¾åˆ°æœ€å°çš„å°äº<code>_Thickness.y</code>çš„<code>thicknessDiff</code>ï¼Œä½¿ç”¨å½“å‰<code>w</code>æ’å€¼å¾—åˆ°çš„<code>p</code>é‡‡æ ·è·å¾—æœ€ç»ˆçš„é¢œè‰²ã€‚</p><p>ä¼ªä»£ç å˜æˆäº†ï¼š</p><blockquote><ol start=0><li>å°†æ­¥è¿›ç»ˆç‚¹è¿›è¡Œè§†é”¥ä½“è£å‰ªå¾—åˆ°<code>clippedPosVS</code>ï¼Œå†è¿›ä¸€æ­¥å¾—åˆ°ç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡<code>endCS</code>ã€‚</li><li>è®°<code>k0</code>ã€<code>k1</code>åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„wåˆ†é‡çš„å€’æ•°ã€‚</li><li>è®°<code>q0</code>ã€<code>q1</code>åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„è£å‰ªç©ºé—´åæ ‡çš„xyzåˆ†é‡ã€‚</li><li>è®°<code>p0</code>ã€<code>p1</code>åˆ†åˆ«æ˜¯æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹çš„æ ‡å‡†åŒ–è®¾å¤‡ç©ºé—´åæ ‡çš„xyåˆ†é‡ã€‚</li><li>è®°<code>w1</code>æ˜¯ä¸€ä¸ªåœ¨(0, 1)ä¹‹é—´æŒ‰ç…§<code>1.0f/_StepCount</code>é€’å¢çš„å˜é‡ï¼Œ<code>w1</code>å’Œ<code>w2</code>åˆå§‹åŒ–ä¸º0ã€‚</li><li>å¯¹æ¯ä¸€æ¬¡æ­¥è¿›ï¼Œ<code>w2=w1</code>ï¼Œæ›´æ–°<code>w1</code>çš„å€¼ï¼Œå¹¶å¯¹ä¸Šé¢çš„ä¸‰ç»„åˆ†é‡çº¿æ€§æ’å€¼å¾—åˆ°<code>k</code>ã€<code>q</code>ã€<code>p</code>ã€‚</li><li>ä½¿ç”¨<code>q.z * k</code>è·å¾—<code>rayDepth</code>ï¼Œä½¿ç”¨<code>p</code>é‡‡æ ·æ·±åº¦å›¾è·å¾—<code>sampleDepth</code>ã€‚</li><li>å¦‚æœ<code>rayZ &lt; sampleZ</code>ä¸”<code>thicknessDiff &lt; _Thickness.y</code>ï¼Œå°„çº¿å’Œåœºæ™¯å‘ç”Ÿäº†äº¤å‰ï¼Œè·³å‡ºå¾ªç¯ã€‚</li><li>å¦åˆ™å¦‚æœ<code>rayZ &lt; sampleZ</code>ä¸”<code>thicknessDiff > _Thickness.y</code>ä¸”ä¸Šä¸€æ¬¡å°„çº¿åœ¨ç‰©ä½“å‰æ–¹ï¼Œå°†<code>thicknessDiff</code>å’Œæœ€å°å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ›´å°åˆ™æ›´æ–°æœ€å°å€¼ï¼Œè®°å½•æ­¤æ—¶çš„<code>w1</code>å’Œ<code>w2</code>ï¼Œè®°ä¸ºå‘ç”Ÿäº†æ½œåœ¨çš„äº¤å‰ï¼Œç»§ç»­å¾ªç¯ã€‚</li><li>å¦‚æœå‘ç”Ÿäº†äº¤å‰ï¼Œè®°<code>w</code>ä¸º<code>w1</code>å’Œ<code>w2</code>çš„å¹³å‡æ•°ï¼ŒæŒ‰ç…§567åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº¤å‰ï¼Œæ ¹æ®æ˜¯å¦äº¤å‰æ›´æ–°<code>w1</code>æˆ–<code>w2</code>ï¼Œç›´åˆ°ç»“æŸäºŒåˆ†æ³•å¾ªç¯ã€‚</li><li>å¦åˆ™å¦‚æœå‘ç”Ÿäº†æ½œåœ¨äº¤å‰ï¼ŒæŒ‰ç…§567åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº¤å‰ï¼Œä½¿ç”¨æœ€å°çš„<code>thicknessDiff</code>æ›´æ–°<code>p</code>ã€‚</li><li>ä½¿ç”¨<code>p</code>é‡‡æ ·é¢œè‰²å›¾ï¼Œè·å¾—åå°„çš„é¢œè‰²ã€‚</li></ol></blockquote><p>æ•ˆæœæ˜¯è¿™æ ·çš„ï¼ˆæ­¥è¿›æ¬¡æ•°ä¸º32æ¬¡ï¼ŒäºŒåˆ†æ³•æŸ¥æ‰¾æ¬¡æ•°ä¸º5æ¬¡ï¼‰:
<img loading=lazy src=../images/ScreenSpaceReflection_PotentialHit.png#center alt="Screen Space Reflection Potential Hit">
ä¸‹å›¾æ˜¯æ­¥è¿›æ¬¡æ•°ä¸º64æ¬¡ï¼ŒäºŒåˆ†æ³•æŸ¥æ‰¾5æ¬¡çš„æ•ˆæœï¼š
<img loading=lazy src=../images/ScreenSpaceReflection_64.png#center alt="Screen Space Reflection Potential Hit"></p><h3 id=æœ€ç»ˆçš„ä»£ç >æœ€ç»ˆçš„ä»£ç <a hidden class=anchor aria-hidden=true href=#æœ€ç»ˆçš„ä»£ç >#</a></h3><pre><code class=language-HLSL data-lang=HLSL>/*
// Copyright (c) 2024 zznewclear@gmail.com
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the &quot;Software&quot;), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.
*/

Shader &quot;zznewclear13/SSRShader&quot;
{
    Properties
    {
        [Toggle(USE_POTENTIAL_HIT)] _UsePotentialHit (&quot;Use Potential Hit&quot;, Float) = 1.0
        [Toggle(USE_FRUSTUM_CLIP)] _UseFrustumClip (&quot;Use Frustum Clip&quot;, Float) = 1.0
        [Toggle(USE_BINARY_SEARCH)] _UseBinarySearch (&quot;Use Binary Search&quot;, Float) = 1.0
        [Toggle(USE_THICKNESS)] _UseThickness (&quot;Use Thickness&quot;, Float) = 1.0
        
        _MaxDistance (&quot;Max Distance&quot;, Range(0.1, 100.0)) = 15.0
        [int] _StepCount (&quot;Step Count&quot;, Float) = 32
        _ThicknessParams (&quot;Thickness Params&quot;, Vector) = (0.1, 0.02, 0.0, 0.0)
    }

    HLSLINCLUDE
    #include &quot;Packages/com.unity.render-pipelines.core/ShaderLibrary/Common.hlsl&quot;
    #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl&quot;
    #include &quot;Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl&quot;
    
    #pragma shader_feature _ USE_POTENTIAL_HIT
    #pragma shader_feature _ USE_FRUSTUM_CLIP
    #pragma shader_feature _ USE_BINARY_SEARCH
    #pragma shader_feature _ USE_THICKNESS

    #define INFINITY 1e10
    #define DEPTH_SAMPLER sampler_PointClamp

    Texture2D _CameraOpaqueTexture;
    Texture2D _CameraDepthTexture;
    CBUFFER_START(UnityPerMaterial)
    float _MaxDistance;
    int _StepCount;
    float2 _ThicknessParams;
    CBUFFER_END

    struct Attributes
    {
        float4 positionOS   : POSITION;
        float3 normalOS     : NORMAL;
        float2 texcoord     : TEXCOORD0;
    };

    struct Varyings
    {
        float4 positionCS   : SV_POSITION;
        float3 positionWS   : TEXCOORD0;
        float3 normalWS     : TEXCOORD1;
        float2 uv           : TEXCOORD2;
        float3 viewWS       : TEXCOORD3;
    };

    Varyings vert(Attributes input)
    {
        Varyings output = (Varyings)0;
        VertexPositionInputs vpi = GetVertexPositionInputs(input.positionOS.xyz);
        VertexNormalInputs vni = GetVertexNormalInputs(input.normalOS);

        output.positionCS = vpi.positionCS;
        output.positionWS = vpi.positionWS;
        output.normalWS = vni.normalWS;
        output.uv = input.texcoord;
        output.viewWS = GetCameraPositionWS() - vpi.positionWS;
        return output;
    }

    float3 frustumClip(float3 from, float3 to, float2 nf, float2 s)
    {
        float3 dir = to - from;
        float3 signDir = sign(dir);

        float nfSlab = signDir.z * (nf.y - nf.x) * 0.5f + (nf.y + nf.x) * 0.5f;
        float lenZ = (nfSlab - from.z) / dir.z;
        if (dir.z == 0.0f) lenZ = INFINITY;

        float2 ss = sign(dir.xy - s * dir.z) * s;
        float2 denom = ss * dir.z - dir.xy;
        float2 lenXY = (from.xy - ss * from.z) / denom;
        if (lenXY.x &lt; 0.0f || denom.x == 0.0f) lenXY.x = INFINITY;
        if (lenXY.y &lt; 0.0f || denom.y == 0.0f) lenXY.y = INFINITY;

        float len = min(min(1.0f, lenZ), min(lenXY.x, lenXY.y));
        float3 clippedVS = from + dir * len;
        return clippedVS;
    }

    float getThicknessDiff(float diff, float linearSampleDepth, float2 thicknessParams)
    {
        return (diff - thicknessParams.x) / linearSampleDepth;
    }

    float4 frag(Varyings input) : SV_TARGET
    {
        float3 positionWS = input.positionWS;
        float3 normalWS = normalize(input.normalWS);
        float3 viewWS = normalize(input.viewWS);
        float3 reflWS = reflect(-viewWS, normalWS);
        float3 env = GlossyEnvironmentReflection(reflWS, 0.0f, 1.0f);
        float3 color = env;

        float3 originWS = positionWS;
        float3 endWS = positionWS + reflWS * _MaxDistance;

#if defined(USE_FRUSTUM_CLIP)
        float3 originVS = mul(UNITY_MATRIX_V, float4(originWS, 1.0f)).xyz;
        float3 endVS = mul(UNITY_MATRIX_V, float4(endWS, 1.0f)).xyz;
        float3 flipZ = float3(1.0f, 1.0f, -1.0f);
        float3 clippedVS = frustumClip(originVS * flipZ, endVS * flipZ, _ProjectionParams.yz, float2(1.0f, -1.0f) / UNITY_MATRIX_P._m00_m11);
        clippedVS *= flipZ;
        float4 originCS = mul(UNITY_MATRIX_VP, float4(originWS, 1.0f));
        float4 endCS = mul(UNITY_MATRIX_P, float4(clippedVS, 1.0f));
#else
        float4 originCS = mul(UNITY_MATRIX_VP, float4(originWS, 1.0f));
        float4 endCS = mul(UNITY_MATRIX_VP, float4(endWS, 1.0f));
#endif

        float k0 = 1.0f / originCS.w;
        float k1 = 1.0f / endCS.w;
        float3 q0 = originCS.xyz;
        float3 q1 = endCS.xyz;
        float2 p0 = originCS.xy * float2(1.0f, -1.0f) * k0 * 0.5f + 0.5f;
        float2 p1 = endCS.xy * float2(1.0f, -1.0f) * k1 * 0.5f + 0.5f;

#if defined(USE_POTENTIAL_HIT)
        float w1 = 0.0f;
        float w2 = 0.0f;
        bool hit = false;
        bool lastHit = false;
        bool potentialHit = false;
        float2 potentialW12 = float2(0.0f, 0.0f);
        float minPotentialHitPos = INFINITY;
        [unroll(64)]
        for (int i=0; i&lt;_StepCount; ++i)
        {
            w2 = w1;
            w1 += 1.0f / float(_StepCount);

            float3 q = lerp(q0, q1, w1);
            float2 p = lerp(p0, p1, w1);
            float k = lerp(k0, k1, w1);
            float sampleDepth = _CameraDepthTexture.Sample(DEPTH_SAMPLER, p).r;
            float linearSampleDepth = LinearEyeDepth(sampleDepth, _ZBufferParams);
            float linearRayDepth = LinearEyeDepth(q.z * k, _ZBufferParams);

            float hitDiff = linearRayDepth - linearSampleDepth;
            float thicknessDiff = getThicknessDiff(hitDiff, linearSampleDepth, _ThicknessParams);
            if (hitDiff &gt; 0.0f)
            {
                if (thicknessDiff &lt; _ThicknessParams.y)
                {
                    hit = true;
                    break;
                }
                else if(!lastHit)
                {
                    potentialHit = true;
                    if (minPotentialHitPos &gt; thicknessDiff)
                    {
                        minPotentialHitPos = thicknessDiff;
                        potentialW12 = float2(w1, w2);
                    }
                }
            }
            lastHit = hitDiff &gt; 0.0f;
        }
#else
        float w1 = 0.0f;
        float w2 = 0.0f;
        bool hit = false;
        [unroll(64)]
        for (int i=0; i&lt;_StepCount; ++i)
        {
            w2 = w1;
            w1 += 1.0f / float(_StepCount);

            float3 q = lerp(q0, q1, w1);
            float2 p = lerp(p0, p1, w1);
            float k = lerp(k0, k1, w1);
            float sampleDepth = _CameraDepthTexture.Sample(DEPTH_SAMPLER, p).r;
#if defined(USE_THICKNESS)
            float linearSampleDepth = LinearEyeDepth(sampleDepth, _ZBufferParams);
            float linearRayDepth = LinearEyeDepth(q.z * k, _ZBufferParams);

            float hitDiff = linearRayDepth - linearSampleDepth;
            float thicknessDiff = getThicknessDiff(hitDiff, linearSampleDepth, _ThicknessParams);
            if (hitDiff &gt; 0.0f &amp;&amp; thicknessDiff &lt; _ThicknessParams.y)
            {
                hit = true;
                break;
            }       
#else
            if (q.z * k &lt; sampleDepth)
            {
                hit = true;
                break;
            }
#endif
        }
#endif

#if defined(USE_POTENTIAL_HIT)
        if (hit || potentialHit)
        {
            if (!hit)
            {
                w1 = potentialW12.x;
                w2 = potentialW12.y;
            }

            bool realHit = false;
            float2 hitPos;
            float minThicknessDiff = _ThicknessParams.y;
            [unroll(5)]
            for (int i=0; i&lt;5; ++i)
            {
                float w = 0.5f * (w1 + w2);
                float3 q = lerp(q0, q1, w1);
                float2 p = lerp(p0, p1, w1);
                float k = lerp(k0, k1, w1);
                float sampleDepth = _CameraDepthTexture.Sample(DEPTH_SAMPLER, p).r;
                float linearSampleDepth = LinearEyeDepth(sampleDepth, _ZBufferParams);
                float linearRayDepth = LinearEyeDepth(q.z * k, _ZBufferParams);
                float hitDiff = linearRayDepth - linearSampleDepth;

                if (hitDiff &gt; 0.0f)
                {
                    w1 = w;
                    if (hit) hitPos = p;
                }
                else
                {
                    w2 = w;
                }

                float thicknessDiff = getThicknessDiff(hitDiff, linearSampleDepth, _ThicknessParams);
                float absThicknessDiff = abs(thicknessDiff);
                if (!hit &amp;&amp; absThicknessDiff &lt; minThicknessDiff) 
                {
                    realHit = true;
                    minThicknessDiff = thicknessDiff;
                    hitPos = p;
                }
            }

            if (hit || realHit) color = _CameraOpaqueTexture.Sample(sampler_LinearClamp, hitPos).rgb * 0.3f;
        }
#elif defined(USE_BINARY_SEARCH)
        if (hit)
        {
            float2 hitPos;
            [unroll(5)]
            for (int i=0; i&lt;5; ++i)
            {
                float w = 0.5f * (w1 + w2);
                float3 q = lerp(q0, q1, w1);
                float2 p = lerp(p0, p1, w1);
                float k = lerp(k0, k1, w1);

                float sampleDepth = _CameraDepthTexture.Sample(DEPTH_SAMPLER, p).r;
                if (q.z * k &lt; sampleDepth)
                {
                    w1 = w;
                    hitPos = p;
                }
                else
                {
                    w2 = w;
                }
            }
            color = _CameraOpaqueTexture.Sample(sampler_LinearClamp, hitPos).rgb * 0.3f;
        }
#else
        if (hit)
        {
            float2 hitPos = lerp(p0, p1, w1);
            color = _CameraOpaqueTexture.Sample(sampler_LinearClamp, hitPos).rgb * 0.3f;
        }
#endif

        return float4(color, 1.0f);
    }

    ENDHLSL

    SubShader
    {
        Tags { &quot;RenderType&quot;=&quot;Transparent&quot; &quot;Queue&quot;=&quot;Transparent&quot; }
        LOD 100

        Pass
        {
            HLSLPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            ENDHLSL
        }
    }
}
</code></pre><h3 id=ä¼˜åŒ–çš„æ–¹å‘>ä¼˜åŒ–çš„æ–¹å‘<a hidden class=anchor aria-hidden=true href=#ä¼˜åŒ–çš„æ–¹å‘>#</a></h3><p>ç›®å‰è¿˜æœ‰ä¸€ä¸ªå€¼å¾—ä¼˜åŒ–çš„æ–¹å‘ï¼Œå°±æ˜¯æ ¹æ®<code>p0</code>å’Œ<code>p1</code>ä¹‹é—´çš„åƒç´ è·ç¦»æ§åˆ¶æ€»ä½“çš„æ­¥è¿›æ¬¡æ•°ï¼Œæ€»ä¸è‡³äºå¯¹10ä¸ªåƒç´ æ­¥è¿›64æ¬¡å§ã€‚ä¸è¿‡è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œç•™ç»™æœ‰ç©ºçš„äººæ¥åšå§ã€‚è‡³äºéšæœºé‡‡æ ·ã€æ¨¡ç³Šå’Œè²æ¶…å°”ï¼Œç­‰åˆ°çœŸçš„ç”¨åˆ°çš„æ—¶å€™å†å»è€ƒè™‘å§ã€‚</p><h2 id=åè®°>åè®°<a hidden class=anchor aria-hidden=true href=#åè®°>#</a></h2><p>2024ç®€ç›´å°±æ˜¯å¼€å¹•é›·å‡»ï¼Œå„ç§ç³Ÿç³•çš„äº‹æƒ…æ¥è¸µè€Œè‡³ï¼Œæœ‰æ—¶å€™ä¼šæœ‰æ·±æ·±çš„æ— åŠ›æ„Ÿã€‚å¯èƒ½åªæœ‰å†™åšå®¢å’ŒShadertoyæ‰èƒ½ç»™æˆ‘å¸¦æ¥æœ€å¼ºçš„æ»¡è¶³æ„Ÿå§ï¼Œå¸Œæœ›çœŸçš„æœ‰äººèƒ½ä»æˆ‘çš„åšå®¢å’ŒShadertoyä¸­æœ‰æ‰€æ”¶è·ã€‚æœ¬æ¥æ˜¯æ‰“ç®—å†™ä¸€ç¯‡Contact Shadowçš„ï¼Œä½†æ˜¯å‘ç°å±å¹•ç©ºé—´ray marchingå…¶å®å¹¶ä¸æ˜¯é‚£ä¹ˆä¸€ä»¶ç®€å•çš„äº‹æƒ…ï¼Œå› æ­¤æƒ³å…ˆå†™å®Œè¿™ä¸ªå†ç»§ç»­æˆ‘çš„Contact Shadowã€‚è¯´å®åœ¨çš„æˆ‘å¯¹è¿™ç¯‡åšå®¢çš„è´¨é‡è¿˜æ˜¯æ¯”è¾ƒæ»¡æ„çš„ï¼Œæ‰“ç®—å†å†™ä¸ªè‹±æ–‡ç‰ˆçš„å»æŠ•ç¨¿Graphics Programming weeklyï¼Œæ‹­ç›®ä»¥å¾….gifã€‚</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://zznewclear13.github.io/tags/screen-space-reflection/>Screen Space Reflection</a></li><li><a href=https://zznewclear13.github.io/tags/screen-space/>Screen Space</a></li></ul><nav class=paginav><a class=prev href=https://zznewclear13.github.io/posts/screen-space-reflection-en/><span class=title>Â« Prev</span><br><span>Screen Space Reflection</span></a>
<a class=next href=https://zznewclear13.github.io/posts/unity-high-quality-bloom/><span class=title>Next Â»</span><br><span>Unityçš„é«˜è´¨é‡çš„Bloomæ•ˆæœ</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://zznewclear13.github.io/>ZZNEWCLEAR13</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script><script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body></html>